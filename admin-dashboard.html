<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Spark Quest ‚ö°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAR4wofIoYwrDMC7jr_GGFYPvZoPgGgbIk",
            authDomain: "spark-quest.firebaseapp.com",
            projectId: "spark-quest",
            storageBucket: "spark-quest.firebasestorage.app",
            messagingSenderId: "113841238943",
            appId: "1:113841238943:web:fd6b69669fb891afcd43aa",
            measurementId: "G-9VQJ7CT98X"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Admin email whitelist
        const ADMIN_EMAIL = "chadramsey01@gmail.com";
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #09090b;
            --bg-secondary: #18181b;
            --bg-tertiary: #27272a;
            --border: #3f3f46;
            --border-light: #52525b;
            --text-primary: #fafafa;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-yellow: #eab308;
            --accent-purple: #a855f7;
            --accent-orange: #f97316;
            --accent-pink: #ec4899;
            --accent-cyan: #06b6d4;
            --accent-red: #ef4444;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }
        
        .mono { font-family: 'JetBrains Mono', monospace; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-light); }
        
        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
        }
        
        .card-hover:hover {
            border-color: var(--border-light);
            background: var(--bg-tertiary);
        }
        
        /* Metric Cards */
        .metric-card {
            position: relative;
            overflow: hidden;
        }
        
        .metric-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            filter: blur(40px);
            opacity: 0.15;
            pointer-events: none;
        }
        
        .metric-card.blue::after { background: var(--accent-blue); }
        .metric-card.green::after { background: var(--accent-green); }
        .metric-card.yellow::after { background: var(--accent-yellow); }
        .metric-card.purple::after { background: var(--accent-purple); }
        .metric-card.orange::after { background: var(--accent-orange); }
        .metric-card.pink::after { background: var(--accent-pink); }
        .metric-card.cyan::after { background: var(--accent-cyan); }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            line-height: 1;
        }
        
        .metric-card.blue .metric-value { color: var(--accent-blue); }
        .metric-card.green .metric-value { color: var(--accent-green); }
        .metric-card.yellow .metric-value { color: var(--accent-yellow); }
        .metric-card.purple .metric-value { color: var(--accent-purple); }
        .metric-card.orange .metric-value { color: var(--accent-orange); }
        .metric-card.pink .metric-value { color: var(--accent-pink); }
        .metric-card.cyan .metric-value { color: var(--accent-cyan); }
        
        /* Trend indicators */
        .trend { display: inline-flex; align-items: center; gap: 2px; font-size: 0.75rem; font-weight: 600; padding: 2px 6px; border-radius: 4px; }
        .trend-up { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
        .trend-down { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }
        .trend-neutral { background: rgba(161, 161, 170, 0.15); color: var(--text-secondary); }
        
        /* Charts */
        .chart-bar {
            transition: all 0.3s ease;
            border-radius: 4px 4px 0 0;
        }
        .chart-bar:hover { filter: brightness(1.2); }
        
        /* Progress bars */
        .progress-track { height: 6px; background: var(--bg-tertiary); border-radius: 3px; overflow: hidden; }
        .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
        
        /* Table */
        .table-row { transition: background 0.2s; }
        .table-row:hover { background: var(--bg-tertiary); }
        
        /* Badges */
        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 9999px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge-blue { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
        .badge-green { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
        .badge-yellow { background: rgba(234, 179, 8, 0.15); color: var(--accent-yellow); }
        .badge-purple { background: rgba(168, 85, 247, 0.15); color: var(--accent-purple); }
        .badge-orange { background: rgba(249, 115, 22, 0.15); color: var(--accent-orange); }
        .badge-pink { background: rgba(236, 72, 153, 0.15); color: var(--accent-pink); }
        
        /* Animations */
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 2s ease-in-out infinite; }
        .animate-in { animation: fadeIn 0.4s ease forwards; }
        
        /* Live indicator */
        .live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent-green); animation: pulse 2s ease-in-out infinite; }
        
        /* Tabs */
        .tab { padding: 8px 16px; border-radius: 8px; font-weight: 500; font-size: 0.875rem; color: var(--text-secondary); transition: all 0.2s; cursor: pointer; }
        .tab:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .tab.active { color: var(--text-primary); background: var(--bg-tertiary); }
        
        /* Button */
        .btn { padding: 8px 16px; border-radius: 8px; font-weight: 500; font-size: 0.875rem; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background: var(--accent-blue); color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-ghost { background: transparent; color: var(--text-secondary); border: 1px solid var(--border); }
        .btn-ghost:hover { background: var(--bg-tertiary); color: var(--text-primary); }
        
        /* Input */
        .input { background: var(--bg-primary); border: 1px solid var(--border); border-radius: 8px; padding: 10px 14px; color: var(--text-primary); font-size: 0.875rem; width: 100%; }
        .input:focus { outline: none; border-color: var(--accent-blue); }
        .input::placeholder { color: var(--text-muted); }
        
        /* Activity dot */
        .activity-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
        .activity-dot.quest { background: var(--accent-blue); }
        .activity-dot.chore { background: var(--accent-green); }
        .activity-dot.purchase { background: var(--accent-yellow); }
        .activity-dot.signup { background: var(--accent-purple); }
        
        /* Sidebar */
        .sidebar { width: 240px; background: var(--bg-secondary); border-right: 1px solid var(--border); height: 100vh; position: fixed; left: 0; top: 0; }
        .main-content { margin-left: 240px; min-height: 100vh; }
        
        @media (max-width: 1024px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
const { useState, useEffect, useMemo, useCallback } = React;

// ============================================
// UTILITY FUNCTIONS
// ============================================

function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
    if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
    return num.toLocaleString();
}

function formatDate(timestamp) {
    if (!timestamp) return 'N/A';
    const date = new Date(timestamp);
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function formatTimeAgo(timestamp) {
    const diff = Date.now() - timestamp;
    const mins = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (mins < 1) return 'Just now';
    if (mins < 60) return `${mins}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    return formatDate(timestamp);
}

function calculateAge(dob) {
    if (!dob) return null;
    const birth = new Date(dob);
    const today = new Date();
    let age = today.getFullYear() - birth.getFullYear();
    const m = today.getMonth() - birth.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
    return age;
}

function getTodayString() {
    return new Date().toDateString();
}

function getDateString(daysAgo) {
    return new Date(Date.now() - daysAgo * 86400000).toDateString();
}

// ============================================
// ANALYTICS ENGINE
// ============================================

function calculatePlatformAnalytics(allParents) {
    const now = Date.now();
    const today = getTodayString();
    const dayMs = 86400000;
    
    // Initialize counters
    let totalUsers = allParents.length;
    let totalKids = 0;
    let totalSparks = 0;
    let totalXp = 0;
    let totalQuestsCompleted = 0;
    let totalChoresCompleted = 0;
    let totalItemsOwned = 0;
    let totalActiveChores = 0;
    let totalRealRewards = 0;
    
    let activeToday = 0;
    let activeThisWeek = 0;
    let activeThisMonth = 0;
    
    let maxStreak = 0;
    let totalStreaks = 0;
    let streakCount = 0;
    
    const allActivities = [];
    const signupsByDay = {};
    const activityByDay = {};
    const questsByCategory = { blaze: 0, flow: 0, terra: 0, breeze: 0 };
    const itemPopularity = {};
    const ageDistribution = {};
    const userDetails = [];
    const kidDetails = [];
    
    // Process each parent
    allParents.forEach((parent, parentIndex) => {
        const kids = parent.kids || [];
        const rewards = parent.rewards || [];
        const createdAt = parent.createdAt?.toDate?.() || parent.createdAt;
        
        totalKids += kids.length;
        totalRealRewards += rewards.length;
        
        // Track signups
        if (createdAt) {
            const signupDate = new Date(createdAt).toDateString();
            signupsByDay[signupDate] = (signupsByDay[signupDate] || 0) + 1;
        }
        
        let parentLastActive = null;
        let parentTotalSparks = 0;
        let parentTotalQuests = 0;
        let parentTotalChores = 0;
        
        // Process each kid
        kids.forEach(kid => {
            const kidSparks = kid.sparks || 0;
            const kidXp = kid.xp || 0;
            const kidQuests = kid.completedQuests || [];
            const kidChores = kid.choreHistory || [];
            const kidInventory = kid.inventory || [];
            const kidActiveChores = kid.chores || [];
            const kidStreak = kid.streak || 0;
            const kidAge = calculateAge(kid.dob);
            
            totalSparks += kidSparks;
            totalXp += kidXp;
            totalQuestsCompleted += kidQuests.length;
            totalChoresCompleted += kidChores.length;
            totalItemsOwned += kidInventory.length;
            totalActiveChores += kidActiveChores.length;
            
            parentTotalSparks += kidSparks;
            parentTotalQuests += kidQuests.length;
            parentTotalChores += kidChores.length;
            
            // Streak tracking
            if (kidStreak > 0) {
                totalStreaks += kidStreak;
                streakCount++;
                maxStreak = Math.max(maxStreak, kidStreak);
            }
            
            // Age distribution
            if (kidAge) {
                ageDistribution[kidAge] = (ageDistribution[kidAge] || 0) + 1;
            }
            
            // Item popularity
            kidInventory.forEach(itemId => {
                itemPopularity[itemId] = (itemPopularity[itemId] || 0) + 1;
            });
            
            // Activity tracking
            const lastPlayed = kid.lastPlayedDate;
            if (lastPlayed) {
                if (lastPlayed === today) activeToday++;
                const lastPlayedDate = new Date(lastPlayed);
                const daysDiff = Math.floor((now - lastPlayedDate.getTime()) / dayMs);
                if (daysDiff <= 7) activeThisWeek++;
                if (daysDiff <= 30) activeThisMonth++;
                
                if (!parentLastActive || new Date(lastPlayed) > new Date(parentLastActive)) {
                    parentLastActive = lastPlayed;
                }
            }
            
            // Quest activities
            kidQuests.forEach(q => {
                const questDate = new Date(q.timestamp).toDateString();
                activityByDay[questDate] = activityByDay[questDate] || { quests: 0, chores: 0 };
                activityByDay[questDate].quests++;
                
                if (q.category && questsByCategory.hasOwnProperty(q.category)) {
                    questsByCategory[q.category]++;
                }
                
                if (now - q.timestamp < 7 * dayMs) {
                    allActivities.push({
                        type: 'quest',
                        userId: parent.id,
                        kidName: kid.name,
                        category: q.category,
                        timestamp: q.timestamp
                    });
                }
            });
            
            // Chore activities
            kidChores.forEach(c => {
                const choreDate = new Date(c.timestamp).toDateString();
                activityByDay[choreDate] = activityByDay[choreDate] || { quests: 0, chores: 0 };
                activityByDay[choreDate].chores++;
                
                if (now - c.timestamp < 7 * dayMs) {
                    allActivities.push({
                        type: 'chore',
                        userId: parent.id,
                        kidName: kid.name,
                        choreName: c.choreName,
                        sparks: c.sparks,
                        timestamp: c.timestamp
                    });
                }
            });
            
            // Kid details for table
            kidDetails.push({
                id: kid.id,
                name: kid.name,
                parentId: parent.id,
                parentEmail: parent.email || parent.id,
                age: kidAge,
                level: Math.floor(kidXp / 100) + 1,
                sparks: kidSparks,
                xp: kidXp,
                streak: kidStreak,
                questsCompleted: kidQuests.length,
                choresCompleted: kidChores.length,
                itemsOwned: kidInventory.length,
                lastActive: kid.lastPlayedDate
            });
        });
        
        // User details for table
        userDetails.push({
            id: parent.id,
            email: parent.email || parent.id,
            kidsCount: kids.length,
            totalSparks: parentTotalSparks,
            totalQuests: parentTotalQuests,
            totalChores: parentTotalChores,
            rewardsCount: rewards.length,
            createdAt: createdAt,
            lastActive: parentLastActive
        });
    });
    
    // Sort activities by time
    allActivities.sort((a, b) => b.timestamp - a.timestamp);
    
    // Build 30-day chart data
    const chartData30Days = [];
    for (let i = 29; i >= 0; i--) {
        const date = new Date(now - i * dayMs);
        const dateStr = date.toDateString();
        const activity = activityByDay[dateStr] || { quests: 0, chores: 0 };
        chartData30Days.push({
            date: dateStr,
            day: date.getDate(),
            month: date.toLocaleDateString('en-US', { month: 'short' }),
            quests: activity.quests,
            chores: activity.chores,
            signups: signupsByDay[dateStr] || 0
        });
    }
    
    // Build 7-day chart data
    const chartData7Days = chartData30Days.slice(-7).map((d, i) => ({
        ...d,
        label: i === 6 ? 'Today' : i === 5 ? 'Yesterday' : new Date(d.date).toLocaleDateString('en-US', { weekday: 'short' })
    }));
    
    // Calculate trends (last 7 days vs previous 7 days)
    const last7 = chartData30Days.slice(-7);
    const prev7 = chartData30Days.slice(-14, -7);
    
    const last7Quests = last7.reduce((s, d) => s + d.quests, 0);
    const prev7Quests = prev7.reduce((s, d) => s + d.quests, 0);
    const questTrend = prev7Quests === 0 ? (last7Quests > 0 ? 100 : 0) : Math.round(((last7Quests - prev7Quests) / prev7Quests) * 100);
    
    const last7Chores = last7.reduce((s, d) => s + d.chores, 0);
    const prev7Chores = prev7.reduce((s, d) => s + d.chores, 0);
    const choreTrend = prev7Chores === 0 ? (last7Chores > 0 ? 100 : 0) : Math.round(((last7Chores - prev7Chores) / prev7Chores) * 100);
    
    const last7Signups = last7.reduce((s, d) => s + d.signups, 0);
    const prev7Signups = prev7.reduce((s, d) => s + d.signups, 0);
    const signupTrend = prev7Signups === 0 ? (last7Signups > 0 ? 100 : 0) : Math.round(((last7Signups - prev7Signups) / prev7Signups) * 100);
    
    // Popular items
    const popularItems = Object.entries(itemPopularity)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10)
        .map(([id, count]) => ({ id, count }));
    
    // Retention calculations
    const retentionRate = totalKids > 0 ? Math.round((activeThisWeek / totalKids) * 100) : 0;
    const avgSparksPerKid = totalKids > 0 ? Math.round(totalSparks / totalKids) : 0;
    const avgQuestsPerKid = totalKids > 0 ? (totalQuestsCompleted / totalKids).toFixed(1) : 0;
    const avgChoresPerKid = totalKids > 0 ? (totalChoresCompleted / totalKids).toFixed(1) : 0;
    const avgStreak = streakCount > 0 ? (totalStreaks / streakCount).toFixed(1) : 0;
    const avgKidsPerUser = totalUsers > 0 ? (totalKids / totalUsers).toFixed(1) : 0;
    
    return {
        overview: {
            totalUsers,
            totalKids,
            totalSparks,
            totalXp,
            totalQuestsCompleted,
            totalChoresCompleted,
            totalItemsOwned,
            totalActiveChores,
            totalRealRewards,
            maxStreak
        },
        activity: {
            activeToday,
            activeThisWeek,
            activeThisMonth,
            retentionRate
        },
        trends: {
            questTrend,
            choreTrend,
            signupTrend
        },
        averages: {
            sparksPerKid: avgSparksPerKid,
            questsPerKid: avgQuestsPerKid,
            choresPerKid: avgChoresPerKid,
            avgStreak,
            kidsPerUser: avgKidsPerUser
        },
        questsByCategory,
        ageDistribution,
        popularItems,
        chartData7Days,
        chartData30Days,
        recentActivities: allActivities.slice(0, 50),
        userDetails: userDetails.sort((a, b) => (b.totalQuests + b.totalChores) - (a.totalQuests + a.totalChores)),
        kidDetails: kidDetails.sort((a, b) => b.sparks - a.sparks)
    };
}

// ============================================
// COMPONENTS
// ============================================

function Sidebar({ activeSection, onSectionChange }) {
    const sections = [
        { id: 'overview', icon: 'üìä', label: 'Overview' },
        { id: 'users', icon: 'üë•', label: 'Users' },
        { id: 'kids', icon: 'üë∂', label: 'Kids' },
        { id: 'activity', icon: 'üìà', label: 'Activity' },
        { id: 'engagement', icon: 'üéØ', label: 'Engagement' },
        { id: 'shop', icon: 'üõçÔ∏è', label: 'Shop Analytics' }
    ];
    
    return (
        <div className="sidebar flex flex-col">
            <div className="p-4 border-b border-[var(--border)]">
                <div className="flex items-center gap-2">
                    <span className="text-2xl">‚ö°</span>
                    <div>
                        <div className="font-bold text-sm">Spark Quest</div>
                        <div className="text-xs text-[var(--text-muted)]">Admin Dashboard</div>
                    </div>
                </div>
            </div>
            
            <nav className="flex-1 p-3 space-y-1">
                {sections.map(s => (
                    <button
                        key={s.id}
                        onClick={() => onSectionChange(s.id)}
                        className={`w-full flex items-center gap-3 px-3 py-2 rounded-lg text-sm font-medium transition-colors ${
                            activeSection === s.id 
                                ? 'bg-[var(--accent-blue)] text-white' 
                                : 'text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--bg-tertiary)]'
                        }`}
                    >
                        <span>{s.icon}</span>
                        <span>{s.label}</span>
                    </button>
                ))}
            </nav>
            
            <div className="p-4 border-t border-[var(--border)]">
                <a href="parent-hub.html" className="flex items-center gap-2 text-sm text-[var(--text-muted)] hover:text-[var(--text-primary)]">
                    <span>‚Üê</span>
                    <span>Back to App</span>
                </a>
            </div>
        </div>
    );
}

function MetricCard({ label, value, icon, trend, color = 'blue', subtitle }) {
    const trendClass = trend > 0 ? 'trend-up' : trend < 0 ? 'trend-down' : 'trend-neutral';
    const trendIcon = trend > 0 ? '‚Üë' : trend < 0 ? '‚Üì' : '‚Üí';
    
    return (
        <div className={`card metric-card ${color} p-4`}>
            <div className="flex items-start justify-between mb-2">
                <span className="text-xl">{icon}</span>
                {trend !== undefined && (
                    <span className={`trend ${trendClass}`}>
                        {trendIcon} {Math.abs(trend)}%
                    </span>
                )}
            </div>
            <div className="metric-value mb-1">{typeof value === 'number' ? formatNumber(value) : value}</div>
            <div className="text-sm text-[var(--text-secondary)]">{label}</div>
            {subtitle && <div className="text-xs text-[var(--text-muted)] mt-1">{subtitle}</div>}
        </div>
    );
}

function ActivityChart({ data, title = "Activity Overview", showSignups = false }) {
    const maxValue = Math.max(...data.flatMap(d => [d.quests, d.chores, showSignups ? d.signups * 5 : 0]), 1);
    
    return (
        <div className="card p-5">
            <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold">{title}</h3>
                <div className="flex items-center gap-4 text-xs">
                    <span className="flex items-center gap-1.5">
                        <span className="w-2.5 h-2.5 rounded-sm bg-[var(--accent-blue)]"></span>
                        Quests
                    </span>
                    <span className="flex items-center gap-1.5">
                        <span className="w-2.5 h-2.5 rounded-sm bg-[var(--accent-green)]"></span>
                        Chores
                    </span>
                    {showSignups && (
                        <span className="flex items-center gap-1.5">
                            <span className="w-2.5 h-2.5 rounded-sm bg-[var(--accent-purple)]"></span>
                            Signups
                        </span>
                    )}
                </div>
            </div>
            
            <div className="flex items-end gap-1 h-40">
                {data.map((d, i) => (
                    <div key={i} className="flex-1 flex flex-col items-center gap-1">
                        <div className="w-full flex items-end justify-center gap-0.5 h-32">
                            <div 
                                className="chart-bar flex-1 max-w-3 bg-[var(--accent-blue)]"
                                style={{ height: `${Math.max((d.quests / maxValue) * 100, 0)}%`, minHeight: d.quests > 0 ? '4px' : '0' }}
                                title={`${d.quests} quests`}
                            />
                            <div 
                                className="chart-bar flex-1 max-w-3 bg-[var(--accent-green)]"
                                style={{ height: `${Math.max((d.chores / maxValue) * 100, 0)}%`, minHeight: d.chores > 0 ? '4px' : '0' }}
                                title={`${d.chores} chores`}
                            />
                            {showSignups && (
                                <div 
                                    className="chart-bar flex-1 max-w-3 bg-[var(--accent-purple)]"
                                    style={{ height: `${Math.max((d.signups * 5 / maxValue) * 100, 0)}%`, minHeight: d.signups > 0 ? '4px' : '0' }}
                                    title={`${d.signups} signups`}
                                />
                            )}
                        </div>
                        <span className="text-[10px] text-[var(--text-muted)]">{d.label || d.day}</span>
                    </div>
                ))}
            </div>
        </div>
    );
}

function CategoryBreakdown({ questsByCategory }) {
    const categories = [
        { id: 'blaze', label: 'Blaze', emoji: 'üî•', color: 'var(--accent-yellow)' },
        { id: 'flow', label: 'Flow', emoji: 'üé®', color: 'var(--accent-blue)' },
        { id: 'terra', label: 'Terra', emoji: 'üåø', color: 'var(--accent-green)' },
        { id: 'breeze', label: 'Breeze', emoji: 'üí®', color: 'var(--accent-purple)' }
    ];
    
    const total = Object.values(questsByCategory).reduce((a, b) => a + b, 0) || 1;
    
    return (
        <div className="card p-5">
            <h3 className="font-semibold mb-4">Quest Categories</h3>
            <div className="space-y-3">
                {categories.map(cat => {
                    const count = questsByCategory[cat.id] || 0;
                    const pct = Math.round((count / total) * 100);
                    return (
                        <div key={cat.id}>
                            <div className="flex items-center justify-between mb-1.5 text-sm">
                                <span className="flex items-center gap-2">
                                    <span>{cat.emoji}</span>
                                    <span>{cat.label}</span>
                                </span>
                                <span className="mono text-xs" style={{color: cat.color}}>{count} ({pct}%)</span>
                            </div>
                            <div className="progress-track">
                                <div className="progress-fill" style={{ width: `${pct}%`, background: cat.color }} />
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );
}

function AgeDistribution({ ageDistribution }) {
    const ages = Object.entries(ageDistribution).sort((a, b) => parseInt(a[0]) - parseInt(b[0]));
    const maxCount = Math.max(...ages.map(a => a[1]), 1);
    
    return (
        <div className="card p-5">
            <h3 className="font-semibold mb-4">Age Distribution</h3>
            {ages.length === 0 ? (
                <p className="text-sm text-[var(--text-muted)]">No age data available</p>
            ) : (
                <div className="flex items-end gap-2 h-32">
                    {ages.map(([age, count]) => (
                        <div key={age} className="flex-1 flex flex-col items-center gap-1">
                            <div 
                                className="w-full bg-[var(--accent-cyan)] rounded-t"
                                style={{ height: `${(count / maxCount) * 100}%`, minHeight: '4px' }}
                            />
                            <span className="text-xs text-[var(--text-muted)]">{age}</span>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

function RecentActivity({ activities }) {
    if (activities.length === 0) {
        return (
            <div className="card p-5">
                <h3 className="font-semibold mb-4">Recent Activity</h3>
                <p className="text-sm text-[var(--text-muted)] text-center py-8">No recent activity</p>
            </div>
        );
    }
    
    return (
        <div className="card p-5">
            <div className="flex items-center justify-between mb-4">
                <h3 className="font-semibold">Recent Activity</h3>
                <div className="flex items-center gap-2 text-xs text-[var(--text-muted)]">
                    <span className="live-dot"></span>
                    <span>Live</span>
                </div>
            </div>
            
            <div className="space-y-2 max-h-80 overflow-y-auto">
                {activities.map((a, i) => (
                    <div key={i} className="flex items-center gap-3 p-2 rounded-lg hover:bg-[var(--bg-tertiary)] transition-colors">
                        <div className={`activity-dot ${a.type}`}></div>
                        <div className="flex-1 min-w-0">
                            <div className="text-sm truncate">
                                {a.type === 'quest' && `Completed ${a.category || 'a'} quest`}
                                {a.type === 'chore' && (a.choreName || 'Completed chore')}
                            </div>
                            <div className="text-xs text-[var(--text-muted)]">{a.kidName}</div>
                        </div>
                        <div className="text-xs text-[var(--text-muted)] mono">{formatTimeAgo(a.timestamp)}</div>
                    </div>
                ))}
            </div>
        </div>
    );
}

function UsersTable({ users }) {
    const [sortBy, setSortBy] = useState('totalQuests');
    const [sortDir, setSortDir] = useState('desc');
    const [search, setSearch] = useState('');
    
    const sorted = useMemo(() => {
        let filtered = users.filter(u => 
            u.email?.toLowerCase().includes(search.toLowerCase())
        );
        
        return filtered.sort((a, b) => {
            const aVal = a[sortBy] || 0;
            const bVal = b[sortBy] || 0;
            return sortDir === 'desc' ? bVal - aVal : aVal - bVal;
        });
    }, [users, sortBy, sortDir, search]);
    
    const handleSort = (field) => {
        if (sortBy === field) {
            setSortDir(sortDir === 'desc' ? 'asc' : 'desc');
        } else {
            setSortBy(field);
            setSortDir('desc');
        }
    };
    
    return (
        <div className="card overflow-hidden">
            <div className="p-4 border-b border-[var(--border)] flex items-center justify-between">
                <h3 className="font-semibold">Registered Users ({users.length})</h3>
                <input 
                    type="text"
                    placeholder="Search by email..."
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    className="input w-64"
                />
            </div>
            
            <div className="overflow-x-auto">
                <table className="w-full text-sm">
                    <thead>
                        <tr className="border-b border-[var(--border)] text-left text-[var(--text-muted)]">
                            <th className="p-3 font-medium">Email</th>
                            <th className="p-3 font-medium cursor-pointer hover:text-[var(--text-primary)]" onClick={() => handleSort('kidsCount')}>Kids</th>
                            <th className="p-3 font-medium cursor-pointer hover:text-[var(--text-primary)]" onClick={() => handleSort('totalSparks')}>Sparks</th>
                            <th className="p-3 font-medium cursor-pointer hover:text-[var(--text-primary)]" onClick={() => handleSort('totalQuests')}>Quests</th>
                            <th className="p-3 font-medium cursor-pointer hover:text-[var(--text-primary)]" onClick={() => handleSort('totalChores')}>Chores</th>
                            <th className="p-3 font-medium">Last Active</th>
                            <th className="p-3 font-medium">Joined</th>
                        </tr>
                    </thead>
                    <tbody>
                        {sorted.slice(0, 50).map(u => (
                            <tr key={u.id} className="table-row border-b border-[var(--border)]">
                                <td className="p-3 font-medium">{u.email || u.id}</td>
                                <td className="p-3">{u.kidsCount}</td>
                                <td className="p-3 mono text-[var(--accent-yellow)]">{formatNumber(u.totalSparks)}</td>
                                <td className="p-3">{u.totalQuests}</td>
                                <td className="p-3">{u.totalChores}</td>
                                <td className="p-3 text-[var(--text-muted)]">{u.lastActive || 'Never'}</td>
                                <td className="p-3 text-[var(--text-muted)]">{formatDate(u.createdAt)}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            
            {sorted.length > 50 && (
                <div className="p-3 text-center text-sm text-[var(--text-muted)] border-t border-[var(--border)]">
                    Showing 50 of {sorted.length} users
                </div>
            )}
        </div>
    );
}

function KidsTable({ kids }) {
    const [sortBy, setSortBy] = useState('sparks');
    const [sortDir, setSortDir] = useState('desc');
    const [search, setSearch] = useState('');
    
    const sorted = useMemo(() => {
        let filtered = kids.filter(k => 
            k.name?.toLowerCase().includes(search.toLowerCase())
        );
        
        return filtered.sort((a, b) => {
            const aVal = a[sortBy] || 0;
            const bVal = b[sortBy] || 0;
            return sortDir === 'desc' ? bVal - aVal : aVal - bVal;
        });
    }, [kids, sortBy, sortDir, search]);
    
    const handleSort = (field) => {
        if (sortBy === field) {
            setSortDir(sortDir === 'desc' ? 'asc' : 'desc');
        } else {
            setSortBy(field);
            setSortDir('desc');
        }
    };
    
    return (
        <div className="card overflow-hidden">
            <div className="p-4 border-b border-[var(--border)] flex items-center justify-between">
                <h3 className="font-semibold">All Kids ({kids.length})</h3>
                <input 
                    type="text"
                    placeholder="Search by name..."
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    className="input w-64"
                />
            </div>
            
            <div className="overflow-x-auto">
                <table className="w-full text-sm">
                    <thead>
                        <tr className="border-b border-[var(--border)] text-left text-[var(--text-muted)]">
                            <th className="p-3 font-medium">Name</th>
                            <th className="p-3 font-medium cursor-pointer hover:text-[var(--text-primary)]" onClick={() => handleSort('age')}>Age</th>
                            <th className="p-3 font-medium cursor-pointer hover:text-[var(--text-primary)]" onClick={() => handleSort('level')}>Level</th>
                            <th className="p-3 font-medium cursor-pointer hover:text-[var(--text-primary)]" onClick={() => handleSort('sparks')}>Sparks</th>
                            <th className="p-3 font-medium cursor-pointer hover:text-[var(--text-primary)]" onClick={() => handleSort('questsCompleted')}>Quests</th>
                            <th className="p-3 font-medium cursor-pointer hover:text-[var(--text-primary)]" onClick={() => handleSort('choresCompleted')}>Chores</th>
                            <th className="p-3 font-medium cursor-pointer hover:text-[var(--text-primary)]" onClick={() => handleSort('streak')}>Streak</th>
                            <th className="p-3 font-medium">Last Active</th>
                        </tr>
                    </thead>
                    <tbody>
                        {sorted.slice(0, 50).map(k => (
                            <tr key={k.id} className="table-row border-b border-[var(--border)]">
                                <td className="p-3 font-medium">{k.name}</td>
                                <td className="p-3">{k.age || '-'}</td>
                                <td className="p-3"><span className="badge badge-purple">Lvl {k.level}</span></td>
                                <td className="p-3 mono text-[var(--accent-yellow)]">{formatNumber(k.sparks)}</td>
                                <td className="p-3">{k.questsCompleted}</td>
                                <td className="p-3">{k.choresCompleted}</td>
                                <td className="p-3">{k.streak > 0 ? <span className="text-[var(--accent-orange)]">üî• {k.streak}</span> : '-'}</td>
                                <td className="p-3 text-[var(--text-muted)]">{k.lastActive || 'Never'}</td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
            
            {sorted.length > 50 && (
                <div className="p-3 text-center text-sm text-[var(--text-muted)] border-t border-[var(--border)]">
                    Showing 50 of {sorted.length} kids
                </div>
            )}
        </div>
    );
}

function PopularItems({ items }) {
    // Simple item name lookup - you could expand this
    const itemNames = {
        'hat_crown_gold': 'üëë Golden Crown',
        'hat_wizard': 'üßô Wizard Hat',
        'hat_astronaut': 'üöÄ Space Helmet',
        'acc_wings_angel': 'üëº Angel Wings',
        'acc_pet_dragon': 'üêâ Baby Dragon',
        'glasses_cool': 'üòé Cool Shades',
        'hat_party': 'üéâ Party Hat',
        'sticker_star': '‚≠ê Gold Star',
        'outfit_armor': 'üõ°Ô∏è Knight Armor',
        'acc_cape_red': 'ü¶∏ Red Cape'
    };
    
    return (
        <div className="card p-5">
            <h3 className="font-semibold mb-4">Popular Shop Items</h3>
            {items.length === 0 ? (
                <p className="text-sm text-[var(--text-muted)]">No purchases yet</p>
            ) : (
                <div className="space-y-2">
                    {items.map((item, i) => (
                        <div key={item.id} className="flex items-center justify-between p-2 rounded-lg hover:bg-[var(--bg-tertiary)]">
                            <span className="text-sm">{itemNames[item.id] || item.id}</span>
                            <span className="text-sm mono text-[var(--text-muted)]">{item.count} owned</span>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
}

// ============================================
// SECTION VIEWS
// ============================================

function OverviewSection({ analytics }) {
    const { overview, activity, trends, averages, questsByCategory, chartData7Days, recentActivities } = analytics;
    
    return (
        <div className="space-y-6 animate-in">
            {/* Key Metrics */}
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <MetricCard 
                    label="Total Users" 
                    value={overview.totalUsers} 
                    icon="üë•" 
                    color="blue"
                    trend={trends.signupTrend}
                    subtitle="Registered parents"
                />
                <MetricCard 
                    label="Total Kids" 
                    value={overview.totalKids} 
                    icon="üë∂" 
                    color="purple"
                    subtitle={`${averages.kidsPerUser} avg per user`}
                />
                <MetricCard 
                    label="Active Today" 
                    value={activity.activeToday} 
                    icon="üü¢" 
                    color="green"
                    subtitle={`${activity.retentionRate}% weekly retention`}
                />
                <MetricCard 
                    label="Total Sparks" 
                    value={overview.totalSparks} 
                    icon="‚ö°" 
                    color="yellow"
                    subtitle={`${averages.sparksPerKid} avg per kid`}
                />
            </div>
            
            {/* Activity Metrics */}
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <MetricCard 
                    label="Quests Completed" 
                    value={overview.totalQuestsCompleted} 
                    icon="üéØ" 
                    color="blue"
                    trend={trends.questTrend}
                />
                <MetricCard 
                    label="Chores Done" 
                    value={overview.totalChoresCompleted} 
                    icon="‚úÖ" 
                    color="green"
                    trend={trends.choreTrend}
                />
                <MetricCard 
                    label="Items Owned" 
                    value={overview.totalItemsOwned} 
                    icon="üõçÔ∏è" 
                    color="pink"
                />
                <MetricCard 
                    label="Best Streak" 
                    value={`${overview.maxStreak} days`} 
                    icon="üî•" 
                    color="orange"
                    subtitle={`${averages.avgStreak} avg streak`}
                />
            </div>
            
            {/* Charts Row */}
            <div className="grid lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2">
                    <ActivityChart data={chartData7Days} title="Last 7 Days Activity" />
                </div>
                <CategoryBreakdown questsByCategory={questsByCategory} />
            </div>
            
            {/* Activity Feed */}
            <RecentActivity activities={recentActivities} />
        </div>
    );
}

function UsersSection({ analytics }) {
    return (
        <div className="space-y-6 animate-in">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <MetricCard label="Total Users" value={analytics.overview.totalUsers} icon="üë•" color="blue" />
                <MetricCard label="Active This Week" value={analytics.activity.activeThisWeek} icon="üìÖ" color="green" />
                <MetricCard label="Active This Month" value={analytics.activity.activeThisMonth} icon="üìÜ" color="purple" />
                <MetricCard label="Retention Rate" value={`${analytics.activity.retentionRate}%`} icon="üìà" color="cyan" />
            </div>
            <UsersTable users={analytics.userDetails} />
        </div>
    );
}

function KidsSection({ analytics }) {
    return (
        <div className="space-y-6 animate-in">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <MetricCard label="Total Kids" value={analytics.overview.totalKids} icon="üë∂" color="purple" />
                <MetricCard label="Avg per Family" value={analytics.averages.kidsPerUser} icon="üë®‚Äçüë©‚Äçüëß‚Äçüë¶" color="blue" />
                <MetricCard label="Total XP Earned" value={analytics.overview.totalXp} icon="‚ú®" color="yellow" />
                <MetricCard label="Active Chores" value={analytics.overview.totalActiveChores} icon="üìã" color="green" />
            </div>
            <div className="grid lg:grid-cols-3 gap-6">
                <div className="lg:col-span-2">
                    <KidsTable kids={analytics.kidDetails} />
                </div>
                <AgeDistribution ageDistribution={analytics.ageDistribution} />
            </div>
        </div>
    );
}

function ActivitySection({ analytics }) {
    return (
        <div className="space-y-6 animate-in">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <MetricCard label="Quests (7 days)" value={analytics.chartData7Days.reduce((s,d) => s + d.quests, 0)} icon="üéØ" color="blue" trend={analytics.trends.questTrend} />
                <MetricCard label="Chores (7 days)" value={analytics.chartData7Days.reduce((s,d) => s + d.chores, 0)} icon="‚úÖ" color="green" trend={analytics.trends.choreTrend} />
                <MetricCard label="Avg Quests/Kid" value={analytics.averages.questsPerKid} icon="üìä" color="purple" />
                <MetricCard label="Avg Chores/Kid" value={analytics.averages.choresPerKid} icon="üìã" color="orange" />
            </div>
            <ActivityChart data={analytics.chartData30Days.slice(-14)} title="Last 14 Days Activity" showSignups={true} />
            <div className="grid lg:grid-cols-2 gap-6">
                <CategoryBreakdown questsByCategory={analytics.questsByCategory} />
                <RecentActivity activities={analytics.recentActivities.slice(0, 20)} />
            </div>
        </div>
    );
}

function EngagementSection({ analytics }) {
    return (
        <div className="space-y-6 animate-in">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <MetricCard label="Weekly Retention" value={`${analytics.activity.retentionRate}%`} icon="üîÑ" color="green" />
                <MetricCard label="Avg Streak" value={`${analytics.averages.avgStreak} days`} icon="üî•" color="orange" />
                <MetricCard label="Best Streak" value={`${analytics.overview.maxStreak} days`} icon="üèÜ" color="yellow" />
                <MetricCard label="Real Rewards Set" value={analytics.overview.totalRealRewards} icon="üéÅ" color="pink" />
            </div>
            <div className="grid lg:grid-cols-2 gap-6">
                <div className="card p-5">
                    <h3 className="font-semibold mb-4">Engagement Funnel</h3>
                    <div className="space-y-4">
                        <div>
                            <div className="flex justify-between text-sm mb-1">
                                <span>Registered Users</span>
                                <span className="mono">{analytics.overview.totalUsers}</span>
                            </div>
                            <div className="progress-track"><div className="progress-fill bg-[var(--accent-blue)]" style={{width: '100%'}} /></div>
                        </div>
                        <div>
                            <div className="flex justify-between text-sm mb-1">
                                <span>Added Kids</span>
                                <span className="mono">{analytics.userDetails.filter(u => u.kidsCount > 0).length}</span>
                            </div>
                            <div className="progress-track"><div className="progress-fill bg-[var(--accent-purple)]" style={{width: `${(analytics.userDetails.filter(u => u.kidsCount > 0).length / Math.max(analytics.overview.totalUsers, 1)) * 100}%`}} /></div>
                        </div>
                        <div>
                            <div className="flex justify-between text-sm mb-1">
                                <span>Completed Activity</span>
                                <span className="mono">{analytics.userDetails.filter(u => u.totalQuests + u.totalChores > 0).length}</span>
                            </div>
                            <div className="progress-track"><div className="progress-fill bg-[var(--accent-green)]" style={{width: `${(analytics.userDetails.filter(u => u.totalQuests + u.totalChores > 0).length / Math.max(analytics.overview.totalUsers, 1)) * 100}%`}} /></div>
                        </div>
                        <div>
                            <div className="flex justify-between text-sm mb-1">
                                <span>Active This Week</span>
                                <span className="mono">{analytics.activity.activeThisWeek}</span>
                            </div>
                            <div className="progress-track"><div className="progress-fill bg-[var(--accent-cyan)]" style={{width: `${(analytics.activity.activeThisWeek / Math.max(analytics.overview.totalKids, 1)) * 100}%`}} /></div>
                        </div>
                    </div>
                </div>
                <AgeDistribution ageDistribution={analytics.ageDistribution} />
            </div>
        </div>
    );
}

function ShopSection({ analytics }) {
    return (
        <div className="space-y-6 animate-in">
            <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <MetricCard label="Items Owned" value={analytics.overview.totalItemsOwned} icon="üõçÔ∏è" color="pink" />
                <MetricCard label="Total Sparks" value={analytics.overview.totalSparks} icon="‚ö°" color="yellow" />
                <MetricCard label="Avg Sparks/Kid" value={analytics.averages.sparksPerKid} icon="üìä" color="orange" />
                <MetricCard label="Real Rewards" value={analytics.overview.totalRealRewards} icon="üéÅ" color="purple" />
            </div>
            <div className="grid lg:grid-cols-2 gap-6">
                <PopularItems items={analytics.popularItems} />
                <div className="card p-5">
                    <h3 className="font-semibold mb-4">Economy Overview</h3>
                    <div className="space-y-4">
                        <div className="flex items-center justify-between p-3 bg-[var(--bg-tertiary)] rounded-lg">
                            <span className="text-sm">Total Sparks in Circulation</span>
                            <span className="mono text-[var(--accent-yellow)] font-bold">{formatNumber(analytics.overview.totalSparks)}</span>
                        </div>
                        <div className="flex items-center justify-between p-3 bg-[var(--bg-tertiary)] rounded-lg">
                            <span className="text-sm">Total XP Earned</span>
                            <span className="mono text-[var(--accent-purple)] font-bold">{formatNumber(analytics.overview.totalXp)}</span>
                        </div>
                        <div className="flex items-center justify-between p-3 bg-[var(--bg-tertiary)] rounded-lg">
                            <span className="text-sm">Items per Kid (avg)</span>
                            <span className="mono font-bold">{(analytics.overview.totalItemsOwned / Math.max(analytics.overview.totalKids, 1)).toFixed(1)}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}

// ============================================
// LOGIN SCREEN
// ============================================

function LoginScreen() {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    
    const handleLogin = async (e) => {
        e.preventDefault();
        setLoading(true);
        setError(null);
        
        try {
            const result = await auth.signInWithEmailAndPassword(email, password);
            
            // Check if admin
            if (result.user.email !== ADMIN_EMAIL) {
                await auth.signOut();
                setError('Access denied. Admin only.');
                setLoading(false);
                return;
            }
        } catch (err) {
            setError(err.message);
            setLoading(false);
        }
    };
    
    return (
        <div className="min-h-screen flex items-center justify-center p-4">
            <div className="card p-8 w-full max-w-md">
                <div className="text-center mb-8">
                    <span className="text-5xl block mb-4">üîê</span>
                    <h1 className="text-2xl font-bold mb-2">Admin Dashboard</h1>
                    <p className="text-[var(--text-muted)]">Spark Quest Platform Analytics</p>
                </div>
                
                <form onSubmit={handleLogin} className="space-y-4">
                    <div>
                        <label className="text-sm text-[var(--text-muted)] mb-1.5 block">Email</label>
                        <input
                            type="email"
                            value={email}
                            onChange={(e) => setEmail(e.target.value)}
                            className="input"
                            placeholder="admin@email.com"
                            required
                        />
                    </div>
                    <div>
                        <label className="text-sm text-[var(--text-muted)] mb-1.5 block">Password</label>
                        <input
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="input"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                            required
                        />
                    </div>
                    
                    {error && (
                        <div className="bg-red-500/10 border border-red-500/20 text-red-400 rounded-lg p-3 text-sm">
                            {error}
                        </div>
                    )}
                    
                    <button type="submit" disabled={loading} className="btn btn-primary w-full">
                        {loading ? 'Signing in...' : 'Sign In'}
                    </button>
                </form>
            </div>
        </div>
    );
}

// ============================================
// MAIN APP
// ============================================

function AdminDashboard() {
    const [user, setUser] = useState(null);
    const [loading, setLoading] = useState(true);
    const [allParents, setAllParents] = useState([]);
    const [analytics, setAnalytics] = useState(null);
    const [activeSection, setActiveSection] = useState('overview');
    const [lastUpdate, setLastUpdate] = useState(null);
    
    // Auth listener
    useEffect(() => {
        const unsub = auth.onAuthStateChanged(u => {
            if (u && u.email === ADMIN_EMAIL) {
                setUser(u);
            } else {
                setUser(null);
                setLoading(false);
            }
        });
        return () => unsub();
    }, []);
    
    // Fetch all parents data
    useEffect(() => {
        if (!user) return;
        
        console.log('Fetching all parents data...');
        
        const unsub = db.collection('parents').onSnapshot(
            (snapshot) => {
                const parents = [];
                snapshot.forEach(doc => {
                    parents.push({ id: doc.id, ...doc.data() });
                });
                console.log(`Loaded ${parents.length} parent documents`);
                setAllParents(parents);
                setLastUpdate(new Date());
                setLoading(false);
            },
            (error) => {
                console.error('Firestore error:', error);
                setLoading(false);
            }
        );
        
        return () => unsub();
    }, [user]);
    
    // Calculate analytics when data changes
    useEffect(() => {
        if (allParents.length > 0) {
            const computed = calculatePlatformAnalytics(allParents);
            setAnalytics(computed);
        }
    }, [allParents]);
    
    // Loading
    if (loading) {
        return (
            <div className="min-h-screen flex items-center justify-center">
                <div className="text-center">
                    <div className="w-10 h-10 border-2 border-[var(--border)] border-t-[var(--accent-blue)] rounded-full animate-spin mx-auto mb-4"></div>
                    <p className="text-[var(--text-muted)]">Loading dashboard...</p>
                </div>
            </div>
        );
    }
    
    // Not logged in or not admin
    if (!user) {
        return <LoginScreen />;
    }
    
    // No data yet
    if (!analytics) {
        return (
            <div className="min-h-screen flex items-center justify-center">
                <div className="text-center">
                    <span className="text-5xl block mb-4">üì≠</span>
                    <h2 className="text-xl font-bold mb-2">No Data Yet</h2>
                    <p className="text-[var(--text-muted)]">Waiting for users to sign up...</p>
                </div>
            </div>
        );
    }
    
    return (
        <div className="min-h-screen">
            <Sidebar activeSection={activeSection} onSectionChange={setActiveSection} />
            
            <div className="main-content">
                {/* Header */}
                <header className="sticky top-0 z-10 bg-[var(--bg-primary)]/80 backdrop-blur-lg border-b border-[var(--border)] px-6 py-4">
                    <div className="flex items-center justify-between">
                        <div className="lg:hidden flex items-center gap-2 mr-4">
                            <span className="text-xl">‚ö°</span>
                            <span className="font-bold">Spark Quest</span>
                        </div>
                        <div className="flex-1">
                            <h1 className="text-lg font-semibold capitalize">{activeSection}</h1>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-2 text-sm text-[var(--text-muted)]">
                                <span className="live-dot"></span>
                                <span className="hidden sm:inline">Live ‚Ä¢ {lastUpdate?.toLocaleTimeString()}</span>
                            </div>
                            <button onClick={() => auth.signOut()} className="btn btn-ghost text-red-400">
                                Sign Out
                            </button>
                        </div>
                    </div>
                </header>
                
                {/* Content */}
                <main className="p-6">
                    {activeSection === 'overview' && <OverviewSection analytics={analytics} />}
                    {activeSection === 'users' && <UsersSection analytics={analytics} />}
                    {activeSection === 'kids' && <KidsSection analytics={analytics} />}
                    {activeSection === 'activity' && <ActivitySection analytics={analytics} />}
                    {activeSection === 'engagement' && <EngagementSection analytics={analytics} />}
                    {activeSection === 'shop' && <ShopSection analytics={analytics} />}
                </main>
            </div>
        </div>
    );
}

// Mount
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<AdminDashboard />);
    </script>
</body>
</html>
