<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Spark Quest</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAR4wofIoYwrDMC7jr_GGFYPvZoPgGgbIk",
            authDomain: "spark-quest.firebaseapp.com",
            projectId: "spark-quest",
            storageBucket: "spark-quest.firebasestorage.app",
            messagingSenderId: "113841238943",
            appId: "1:113841238943:web:fd6b69669fb891afcd43aa"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // ========================================
        // DASHBOARD CONFIG - CHANGE PASSWORD HERE
        // ========================================
        const DASHBOARD_PASSWORD = "SparkAdmin2025!";
        const ADMIN_EMAIL = "chadramsey01@gmail.com";
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root{--bg:#09090b;--bg2:#18181b;--bg3:#27272a;--border:#3f3f46;--text:#fafafa;--muted:#71717a;--blue:#3b82f6;--green:#22c55e;--yellow:#eab308;--purple:#a855f7;--orange:#f97316;--pink:#ec4899;--cyan:#06b6d4}
        *{box-sizing:border-box;margin:0;padding:0}body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
        .card{background:var(--bg2);border:1px solid var(--border);border-radius:12px}
        .metric{font-size:2rem;font-weight:800;line-height:1}
        .btn{padding:10px 20px;border-radius:8px;font-weight:500;border:none;cursor:pointer;transition:all .2s}
        .btn-blue{background:var(--blue);color:#fff}.btn-blue:hover{background:#2563eb}
        .btn-google{background:#fff;color:#333;display:flex;align-items:center;justify-content:center;gap:8px}
        .btn-ghost{background:transparent;color:var(--muted);border:1px solid var(--border)}
        .input{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;color:var(--text);width:100%}.input:focus{outline:none;border-color:var(--blue)}
        .progress{height:6px;background:var(--bg3);border-radius:3px;overflow:hidden}.progress-bar{height:100%;border-radius:3px}
        .chart-bar{border-radius:4px 4px 0 0;transition:all .3s}.chart-bar:hover{filter:brightness(1.2)}
        .live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);animation:pulse 2s infinite}
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}@keyframes spin{to{transform:rotate(360deg)}}
        .sidebar{width:220px;background:var(--bg2);border-right:1px solid var(--border);height:100vh;position:fixed;left:0;top:0}
        .main{margin-left:220px;min-height:100vh}
        @media(max-width:1024px){.sidebar{display:none}.main{margin-left:0}}
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const {useState,useEffect,useMemo}=React;

const fmt=n=>{if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return n.toLocaleString()};
const fmtDate=ts=>ts?new Date(ts).toLocaleDateString('en-US',{month:'short',day:'numeric'}):'-';
const fmtAgo=ts=>{const d=Date.now()-ts,m=~~(d/6e4),h=~~(d/36e5),dy=~~(d/864e5);if(m<1)return'Now';if(m<60)return m+'m';if(h<24)return h+'h';return dy+'d'};
const calcAge=dob=>{if(!dob)return null;const b=new Date(dob),t=new Date();let a=t.getFullYear()-b.getFullYear();if(t.getMonth()<b.getMonth()||(t.getMonth()===b.getMonth()&&t.getDate()<b.getDate()))a--;return a};

function calcAnalytics(parents){
    const now=Date.now(),today=new Date().toDateString(),dayMs=864e5;
    let tUsers=parents.length,tKids=0,tSparks=0,tXp=0,tQuests=0,tChores=0,tItems=0,activeToday=0,activeWeek=0,maxStreak=0;
    const actByDay={},questsByCat={blaze:0,flow:0,terra:0,breeze:0},ageDist={},users=[],kids=[],activities=[];

    parents.forEach(p=>{
        const pKids=p.kids||[];tKids+=pKids.length;
        let pSparks=0,pQuests=0,pChores=0,pLast=null;
        pKids.forEach(k=>{
            const kSparks=k.sparks||0,kXp=k.xp||0,kQuests=k.completedQuests||[],kChores=k.choreHistory||[],kInv=k.inventory||[],kStreak=k.streak||0,kAge=calcAge(k.dob);
            tSparks+=kSparks;tXp+=kXp;tQuests+=kQuests.length;tChores+=kChores.length;tItems+=kInv.length;
            pSparks+=kSparks;pQuests+=kQuests.length;pChores+=kChores.length;
            if(kStreak>maxStreak)maxStreak=kStreak;
            if(kAge)ageDist[kAge]=(ageDist[kAge]||0)+1;
            const lp=k.lastPlayedDate;
            if(lp){if(lp===today)activeToday++;const dd=~~((now-new Date(lp).getTime())/dayMs);if(dd<=7)activeWeek++;if(!pLast||new Date(lp)>new Date(pLast))pLast=lp}
            kQuests.forEach(q=>{const d=new Date(q.timestamp).toDateString();actByDay[d]=actByDay[d]||{q:0,c:0};actByDay[d].q++;if(q.category&&questsByCat[q.category]!==undefined)questsByCat[q.category]++;if(now-q.timestamp<7*dayMs)activities.push({type:'quest',kid:k.name,cat:q.category,ts:q.timestamp})});
            kChores.forEach(c=>{const d=new Date(c.timestamp).toDateString();actByDay[d]=actByDay[d]||{q:0,c:0};actByDay[d].c++;if(now-c.timestamp<7*dayMs)activities.push({type:'chore',kid:k.name,name:c.choreName,ts:c.timestamp})});
            kids.push({id:k.id,name:k.name,age:kAge,level:~~(kXp/100)+1,sparks:kSparks,quests:kQuests.length,chores:kChores.length,streak:kStreak,last:k.lastPlayedDate});
        });
        users.push({id:p.id,email:p.email||p.id,kids:pKids.length,sparks:pSparks,quests:pQuests,chores:pChores,last:pLast});
    });

    activities.sort((a,b)=>b.ts-a.ts);
    const chart=[];for(let i=6;i>=0;i--){const dt=new Date(now-i*dayMs),ds=dt.toDateString(),act=actByDay[ds]||{q:0,c:0};chart.push({label:i===0?'Today':i===1?'Yday':dt.toLocaleDateString('en-US',{weekday:'short'}),q:act.q,c:act.c})}
    const ret=tKids>0?~~((activeWeek/tKids)*100):0;

    return{tUsers,tKids,tSparks,tXp,tQuests,tChores,tItems,activeToday,activeWeek,maxStreak,ret,chart,questsByCat,ageDist,activities:activities.slice(0,30),users:users.sort((a,b)=>(b.quests+b.chores)-(a.quests+a.chores)),kids:kids.sort((a,b)=>b.sparks-a.sparks)};
}

function Sidebar({active,onChange}){
    const items=[{id:'overview',icon:'ðŸ“Š',label:'Overview'},{id:'users',icon:'ðŸ‘¥',label:'Users'},{id:'kids',icon:'ðŸ‘¶',label:'Kids'},{id:'activity',icon:'ðŸ“ˆ',label:'Activity'}];
    return(<div className="sidebar flex flex-col"><div className="p-4 border-b border-[var(--border)]"><div className="flex items-center gap-2"><span className="text-2xl">âš¡</span><div><div className="font-bold text-sm">Spark Quest</div><div className="text-xs text-[var(--muted)]">Admin</div></div></div></div><nav className="flex-1 p-2">{items.map(s=><button key={s.id} onClick={()=>onChange(s.id)} className={`w-full flex items-center gap-2 px-3 py-2 rounded-lg text-sm mb-1 ${active===s.id?'bg-[var(--blue)] text-white':'text-[var(--muted)] hover:bg-[var(--bg3)]'}`}>{s.icon} {s.label}</button>)}</nav></div>);
}

function Metric({label,value,icon,color='blue'}){return(<div className="card p-4"><div className="text-xl mb-2">{icon}</div><div className="metric" style={{color:`var(--${color})`}}>{typeof value==='number'?fmt(value):value}</div><div className="text-sm text-[var(--muted)] mt-1">{label}</div></div>)}

function Chart({data}){const max=Math.max(...data.flatMap(d=>[d.q,d.c]),1);return(<div className="card p-4"><h3 className="font-semibold mb-4">Last 7 Days</h3><div className="flex items-end gap-1 h-32">{data.map((d,i)=><div key={i} className="flex-1 flex flex-col items-center gap-1"><div className="w-full flex items-end justify-center gap-0.5 h-24"><div className="chart-bar flex-1 bg-[var(--blue)]" style={{height:`${(d.q/max)*100}%`,minHeight:d.q?'4px':'0'}}/><div className="chart-bar flex-1 bg-[var(--green)]" style={{height:`${(d.c/max)*100}%`,minHeight:d.c?'4px':'0'}}/></div><span className="text-[10px] text-[var(--muted)]">{d.label}</span></div>)}</div><div className="flex gap-4 mt-3 text-xs"><span className="flex items-center gap-1"><span className="w-2 h-2 rounded-sm bg-[var(--blue)]"/>Quests</span><span className="flex items-center gap-1"><span className="w-2 h-2 rounded-sm bg-[var(--green)]"/>Chores</span></div></div>)}

function Activity({items}){return(<div className="card p-4"><div className="flex items-center justify-between mb-3"><h3 className="font-semibold">Recent Activity</h3><div className="flex items-center gap-1 text-xs text-[var(--muted)]"><span className="live-dot"/>Live</div></div><div className="space-y-2 max-h-64 overflow-y-auto">{items.length===0?<p className="text-sm text-[var(--muted)]">No activity yet</p>:items.map((a,i)=><div key={i} className="flex items-center gap-2 p-2 rounded hover:bg-[var(--bg3)]"><span className={`w-2 h-2 rounded-full ${a.type==='quest'?'bg-[var(--blue)]':'bg-[var(--green)]'}`}/><div className="flex-1 min-w-0"><div className="text-sm truncate">{a.type==='quest'?`${a.cat||''} quest`:a.name||'Chore'}</div><div className="text-xs text-[var(--muted)]">{a.kid}</div></div><span className="text-xs text-[var(--muted)]">{fmtAgo(a.ts)}</span></div>)}</div></div>)}

function UsersTable({users}){const[search,setSearch]=useState('');const filtered=users.filter(u=>u.email.toLowerCase().includes(search.toLowerCase()));return(<div className="card overflow-hidden"><div className="p-3 border-b border-[var(--border)] flex items-center justify-between gap-2"><h3 className="font-semibold">Users ({users.length})</h3><input className="input w-48 text-sm" placeholder="Search..." value={search} onChange={e=>setSearch(e.target.value)}/></div><div className="overflow-x-auto"><table className="w-full text-sm"><thead><tr className="border-b border-[var(--border)] text-[var(--muted)]"><th className="p-2 text-left">Email</th><th className="p-2">Kids</th><th className="p-2">Sparks</th><th className="p-2">Quests</th><th className="p-2">Chores</th><th className="p-2">Last</th></tr></thead><tbody>{filtered.slice(0,30).map(u=><tr key={u.id} className="border-b border-[var(--border)] hover:bg-[var(--bg3)]"><td className="p-2">{u.email}</td><td className="p-2 text-center">{u.kids}</td><td className="p-2 text-center text-[var(--yellow)]">{fmt(u.sparks)}</td><td className="p-2 text-center">{u.quests}</td><td className="p-2 text-center">{u.chores}</td><td className="p-2 text-center text-[var(--muted)]">{u.last||'-'}</td></tr>)}</tbody></table></div></div>)}

function KidsTable({kids}){const[search,setSearch]=useState('');const filtered=kids.filter(k=>k.name.toLowerCase().includes(search.toLowerCase()));return(<div className="card overflow-hidden"><div className="p-3 border-b border-[var(--border)] flex items-center justify-between gap-2"><h3 className="font-semibold">Kids ({kids.length})</h3><input className="input w-48 text-sm" placeholder="Search..." value={search} onChange={e=>setSearch(e.target.value)}/></div><div className="overflow-x-auto"><table className="w-full text-sm"><thead><tr className="border-b border-[var(--border)] text-[var(--muted)]"><th className="p-2 text-left">Name</th><th className="p-2">Age</th><th className="p-2">Level</th><th className="p-2">Sparks</th><th className="p-2">Quests</th><th className="p-2">Chores</th><th className="p-2">Streak</th></tr></thead><tbody>{filtered.slice(0,30).map(k=><tr key={k.id} className="border-b border-[var(--border)] hover:bg-[var(--bg3)]"><td className="p-2">{k.name}</td><td className="p-2 text-center">{k.age||'-'}</td><td className="p-2 text-center"><span className="px-2 py-0.5 rounded-full text-xs bg-[var(--purple)]/20 text-[var(--purple)]">Lvl {k.level}</span></td><td className="p-2 text-center text-[var(--yellow)]">{fmt(k.sparks)}</td><td className="p-2 text-center">{k.quests}</td><td className="p-2 text-center">{k.chores}</td><td className="p-2 text-center">{k.streak>0?<span className="text-[var(--orange)]">ðŸ”¥{k.streak}</span>:'-'}</td></tr>)}</tbody></table></div></div>)}

function Categories({data}){const cats=[{id:'blaze',e:'ðŸ”¥',c:'yellow'},{id:'flow',e:'ðŸŽ¨',c:'blue'},{id:'terra',e:'ðŸŒ¿',c:'green'},{id:'breeze',e:'ðŸ’¨',c:'purple'}];const total=Object.values(data).reduce((a,b)=>a+b,0)||1;return(<div className="card p-4"><h3 className="font-semibold mb-3">Categories</h3><div className="space-y-2">{cats.map(c=>{const v=data[c.id]||0,pct=~~((v/total)*100);return<div key={c.id}><div className="flex justify-between text-sm mb-1"><span>{c.e} {c.id}</span><span style={{color:`var(--${c.c})`}}>{v} ({pct}%)</span></div><div className="progress"><div className="progress-bar" style={{width:`${pct}%`,background:`var(--${c.c})`}}/></div></div>})}</div></div>)}

function Overview({a}){return(<div className="space-y-4"><div className="grid grid-cols-2 lg:grid-cols-4 gap-3"><Metric label="Total Users" value={a.tUsers} icon="ðŸ‘¥" color="blue"/><Metric label="Total Kids" value={a.tKids} icon="ðŸ‘¶" color="purple"/><Metric label="Active Today" value={a.activeToday} icon="ðŸŸ¢" color="green"/><Metric label="Total Sparks" value={a.tSparks} icon="âš¡" color="yellow"/></div><div className="grid grid-cols-2 lg:grid-cols-4 gap-3"><Metric label="Quests Done" value={a.tQuests} icon="ðŸŽ¯" color="blue"/><Metric label="Chores Done" value={a.tChores} icon="âœ…" color="green"/><Metric label="Items Owned" value={a.tItems} icon="ðŸ›ï¸" color="pink"/><Metric label="Best Streak" value={`${a.maxStreak}d`} icon="ðŸ”¥" color="orange"/></div><div className="grid lg:grid-cols-3 gap-4"><div className="lg:col-span-2"><Chart data={a.chart}/></div><Categories data={a.questsByCat}/></div><Activity items={a.activities}/></div>)}

function PasswordScreen({onSuccess}){const[pw,setPw]=useState('');const[err,setErr]=useState('');const submit=e=>{e.preventDefault();if(pw===DASHBOARD_PASSWORD){sessionStorage.setItem('spark_admin','1');onSuccess()}else setErr('Wrong password')};return(<div className="min-h-screen flex items-center justify-center p-4"><div className="card p-8 w-full max-w-sm"><div className="text-center mb-6"><span className="text-5xl">ðŸ”</span><h1 className="text-xl font-bold mt-3">Admin Dashboard</h1><p className="text-sm text-[var(--muted)]">Enter password</p></div><form onSubmit={submit}><input type="password" className="input text-center mb-3" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" value={pw} onChange={e=>{setPw(e.target.value);setErr('')}} autoFocus/>{err&&<p className="text-red-400 text-sm text-center mb-3">{err}</p>}<button type="submit" className="btn btn-blue w-full">Enter</button></form></div></div>)}

function GoogleScreen({onSuccess}){const[loading,setLoading]=useState(false);const[err,setErr]=useState('');const signIn=async()=>{setLoading(true);try{const r=await auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());if(r.user.email!==ADMIN_EMAIL){await auth.signOut();setErr('Access denied');setLoading(false);return}onSuccess(r.user)}catch(e){setErr(e.message);setLoading(false)}};return(<div className="min-h-screen flex items-center justify-center p-4"><div className="card p-8 w-full max-w-sm"><div className="text-center mb-6"><span className="text-5xl">âœ…</span><h1 className="text-xl font-bold mt-3">Password OK</h1><p className="text-sm text-[var(--muted)]">Sign in with Google to load data</p></div>{err&&<p className="text-red-400 text-sm text-center mb-3">{err}</p>}<button onClick={signIn} disabled={loading} className="btn btn-google w-full">{loading?'Signing in...':'Sign in with Google'}</button><p className="text-xs text-[var(--muted)] text-center mt-3">Only {ADMIN_EMAIL}</p></div></div>)}

function App(){
    const[pwOk,setPwOk]=useState(()=>sessionStorage.getItem('spark_admin')==='1');
    const[user,setUser]=useState(null);
    const[loading,setLoading]=useState(true);
    const[parents,setParents]=useState([]);
    const[section,setSection]=useState('overview');
    const[lastUpd,setLastUpd]=useState(null);

    useEffect(()=>{const u=auth.onAuthStateChanged(u=>{if(u&&u.email===ADMIN_EMAIL&&pwOk)setUser(u);else{setUser(null);setLoading(false)}});return()=>u()},[pwOk]);

    useEffect(()=>{if(!user)return;const u=db.collection('parents').onSnapshot(s=>{const p=[];s.forEach(d=>p.push({id:d.id,...d.data()}));setParents(p);setLastUpd(new Date());setLoading(false)},e=>{console.error(e);setLoading(false)});return()=>u()},[user]);

    const analytics=useMemo(()=>parents.length?calcAnalytics(parents):null,[parents]);
    const signOut=()=>{auth.signOut();sessionStorage.removeItem('spark_admin');setPwOk(false);setUser(null)};

    if(!pwOk)return<PasswordScreen onSuccess={()=>setPwOk(true)}/>;
    if(!user)return<GoogleScreen onSuccess={setUser}/>;
    if(loading)return<div className="min-h-screen flex items-center justify-center"><div className="w-8 h-8 border-2 border-[var(--border)] border-t-[var(--blue)] rounded-full animate-spin"/></div>;
    if(!analytics)return<div className="min-h-screen flex items-center justify-center text-center"><div><span className="text-5xl">ðŸ“­</span><h2 className="text-xl font-bold mt-3">No Data Yet</h2></div></div>;

    return(<div className="min-h-screen"><Sidebar active={section} onChange={setSection}/><div className="main"><header className="sticky top-0 z-10 bg-[var(--bg)]/80 backdrop-blur border-b border-[var(--border)] px-4 py-3 flex items-center justify-between"><div className="lg:hidden flex items-center gap-2"><span className="text-xl">âš¡</span><span className="font-bold">Admin</span></div><h1 className="text-lg font-semibold capitalize hidden lg:block">{section}</h1><div className="flex items-center gap-3"><div className="flex items-center gap-1 text-xs text-[var(--muted)]"><span className="live-dot"/><span className="hidden sm:inline">{lastUpd?.toLocaleTimeString()}</span></div><button onClick={signOut} className="btn btn-ghost text-red-400 text-sm">Sign Out</button></div></header><main className="p-4">{section==='overview'&&<Overview a={analytics}/>}{section==='users'&&<UsersTable users={analytics.users}/>}{section==='kids'&&<KidsTable kids={analytics.kids}/>}{section==='activity'&&<div className="space-y-4"><div className="grid grid-cols-2 lg:grid-cols-4 gap-3"><Metric label="Quests (7d)" value={analytics.chart.reduce((s,d)=>s+d.q,0)} icon="ðŸŽ¯" color="blue"/><Metric label="Chores (7d)" value={analytics.chart.reduce((s,d)=>s+d.c,0)} icon="âœ…" color="green"/><Metric label="Weekly Active" value={analytics.activeWeek} icon="ðŸ“…" color="purple"/><Metric label="Retention" value={`${analytics.ret}%`} icon="ðŸ“ˆ" color="cyan"/></div><Chart data={analytics.chart}/><Activity items={analytics.activities}/></div>}</main></div></div>);
}

ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
