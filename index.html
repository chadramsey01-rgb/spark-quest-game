<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spark Quest ‚öîÔ∏è</title>
    
    <!-- External Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* ========================================
           BASE STYLES & FONTS
           ======================================== */
        * { box-sizing: border-box; }
        body { 
            font-family: 'Fredoka', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            background: linear-gradient(135deg, #e0f2fe 0%, #fae8ff 100%);
            min-height: 100vh;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* ========================================
           ANIMATIONS
           ======================================== */
        @keyframes bounce-in { 
            0% { transform: scale(0.3); opacity: 0; } 
            50% { transform: scale(1.05); } 
            100% { transform: scale(1); opacity: 1; } 
        }
        @keyframes float { 
            0%, 100% { transform: translateY(0); } 
            50% { transform: translateY(-10px); } 
        }
        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(250, 204, 21, 0.5); }
            50% { box-shadow: 0 0 20px rgba(250, 204, 21, 0.8), 0 0 30px rgba(250, 204, 21, 0.4); }
        }
        @keyframes spin-wheel {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(1800deg); }
        }
        @keyframes confetti-fall {
            0% { transform: translateY(-100%) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        @keyframes sparkle {
            0%, 100% { opacity: 0; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1) rotate(180deg); }
        }
        @keyframes flame-flicker {
            0%, 100% { transform: scaleY(1) scaleX(1); }
            25% { transform: scaleY(1.1) scaleX(0.95); }
            50% { transform: scaleY(0.95) scaleX(1.05); }
            75% { transform: scaleY(1.05) scaleX(0.98); }
        }
        
        .animate-bounce-in { animation: bounce-in 0.5s ease-out forwards; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        .animate-shimmer { 
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
        }

        /* ========================================
           RARITY GLOW EFFECTS
           ======================================== */
        .glow-common { box-shadow: 0 0 10px rgba(148, 163, 184, 0.5); }
        .glow-rare { box-shadow: 0 0 15px rgba(59, 130, 246, 0.6); }
        .glow-epic { box-shadow: 0 0 20px rgba(168, 85, 247, 0.7); }
        .glow-legendary { 
            box-shadow: 0 0 25px rgba(250, 204, 21, 0.8);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        /* ========================================
           QUEST CATEGORY COLORS
           ======================================== */
        .quest-blaze { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #f59e0b; }
        .quest-flow { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-color: #3b82f6; }
        .quest-terra { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-color: #22c55e; }
        .quest-breeze { background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border-color: #a855f7; }

        /* ========================================
           COMPONENT STYLES
           ======================================== */
        .card {
            background: white;
            border-radius: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            border-bottom: 4px solid #e2e8f0;
        }
        .card-elevated {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            font-weight: 700;
            padding: 0.75rem 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4);
            transition: all 0.2s;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .spark-counter {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-weight: 700;
            color: #92400e;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
// ============================================================================
// SPARK QUEST - COMPLETE SINGLE-FILE APPLICATION
// Version: 5.0 (Consolidated Edition)
// ============================================================================

const { useState, useEffect, useContext, createContext, useCallback, useMemo } = React;

// ============================================================================
// SECTION 1: CONFIGURATION & CONSTANTS
// ============================================================================

// Level progression configuration
const LEVEL_CONFIG = {
    xpPerLevel: 100,
    getLevel: (xp) => Math.floor(xp / 100) + 1,
    getProgress: (xp) => (xp % 100),
    getXpToNext: (xp) => 100 - (xp % 100)
};

// Rarity configuration for shop items
const RARITY_CONFIG = {
    common: { label: 'Common', color: 'slate', glow: 'glow-common', chance: 0.6 },
    rare: { label: 'Rare', color: 'blue', glow: 'glow-rare', chance: 0.25 },
    epic: { label: 'Epic', color: 'purple', glow: 'glow-epic', chance: 0.12 },
    legendary: { label: 'Legendary', color: 'yellow', glow: 'glow-legendary', chance: 0.03 }
};

// Quest category configuration
const CATEGORY_CONFIG = {
    blaze: { emoji: 'üî•', label: 'Blaze', desc: 'Physical activities', color: 'amber' },
    flow: { emoji: 'üé®', label: 'Flow', desc: 'Creative tasks', color: 'blue' },
    terra: { emoji: 'üåø', label: 'Terra', desc: 'Household & nature', color: 'green' },
    breeze: { emoji: 'üí®', label: 'Breeze', desc: 'Quick & easy', color: 'purple' }
};

// Difficulty configuration
const DIFFICULTY_CONFIG = {
    Easy: { sparks: 5, xp: 10, color: 'green', label: '‚≠ê Easy' },
    Medium: { sparks: 10, xp: 20, color: 'blue', label: '‚≠ê‚≠ê Medium' },
    Hard: { sparks: 20, xp: 40, color: 'purple', label: '‚≠ê‚≠ê‚≠ê Hard' },
    Epic: { sparks: 50, xp: 100, color: 'yellow', label: 'üèÜ EPIC' }
};

// ============================================================================
// SECTION 2: WORD BANKS FOR QUEST GENERATION
// ============================================================================

const WORD_BANKS = {
    // Numbers
    number_small: ['3', '4', '5', '6', '7', '8'],
    number_large: ['10', '12', '15', '20', '25'],
    
    // Time durations
    time_short: ['10 seconds', '15 seconds', '20 seconds', '30 seconds'],
    time_long: ['1 minute', '2 minutes', '3 minutes', '5 minutes'],
    
    // Exercises
    exercise_easy: ['jumping jacks', 'hops', 'spins', 'claps', 'toe touches', 'arm circles'],
    exercise_hard: ['push-ups', 'squats', 'burpees', 'lunges', 'mountain climbers', 'plank holds'],
    
    // Animals
    animal: ['dragon', 'unicorn', 'robot', 'dinosaur', 'superhero', 'wizard', 'cat', 'dog', 'bunny', 'owl', 'fox', 'bear', 'penguin', 'butterfly', 'lion', 'elephant'],
    
    // Colors
    color: ['red', 'blue', 'green', 'yellow', 'purple', 'orange', 'pink', 'rainbow'],
    
    // Objects
    object_easy: ['toy', 'book', 'sock', 'shoe', 'cup', 'spoon', 'pillow', 'blanket'],
    object_hard: ['something round', 'something soft', 'something that makes noise', 'something from nature'],
    
    // Locations
    location: ['kitchen', 'living room', 'bedroom', 'backyard', 'front door', 'bathroom', 'hallway'],
    room: ['your room', 'the bathroom', 'the kitchen', 'the living room'],
    
    // Creative prompts
    creative: ['your dream house', 'an alien planet', 'your favorite food as a character', 'yourself as a superhero', 'a magical creature', 'your dream pet'],
    
    // Letters for scavenger hunts
    letter: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'L', 'M', 'P', 'R', 'S', 'T']
};

// ============================================================================
// SECTION 3: QUEST TEMPLATES (50+ templates per category)
// ============================================================================

const QUEST_TEMPLATES = {
    // üî• BLAZE - Physical activity quests
    blaze: {
        Easy: [
            { text: "Do [number_small] [exercise_easy]!", minAge: 4 },
            { text: "Jump up and down [number_small] times!", minAge: 4 },
            { text: "Touch your toes [number_small] times!", minAge: 4 },
            { text: "Spin around [number_small] times!", minAge: 4 },
            { text: "Hop on one foot [number_small] times!", minAge: 4 },
            { text: "Run to the [location] and back!", minAge: 5 },
            { text: "Do [number_small] silly walks around the room!", minAge: 4 },
            { text: "Stretch your arms up high for [time_short]!", minAge: 4 },
            { text: "March in place for [time_short]!", minAge: 4 },
            { text: "Do [number_small] big arm circles!", minAge: 4 },
            { text: "Wiggle your whole body for [time_short]!", minAge: 4 },
            { text: "Clap your hands [number_large] times!", minAge: 4 }
        ],
        Medium: [
            { text: "Do [number_large] [exercise_easy]!", minAge: 6 },
            { text: "Hold a plank for [time_short]!", minAge: 7 },
            { text: "Do [number_small] [exercise_hard]!", minAge: 7 },
            { text: "Create a [number_small]-move dance and perform it!", minAge: 6 },
            { text: "Do jumping jacks for [time_long]!", minAge: 6 },
            { text: "Run in place as fast as you can for [time_short]!", minAge: 6 },
            { text: "Do [number_small] laps around the [location]!", minAge: 6 },
            { text: "Balance on one foot for [time_short]!", minAge: 6 },
            { text: "Do [number_small] jumping jacks, then [number_small] spins!", minAge: 6 },
            { text: "Crab walk across the room [number_small] times!", minAge: 6 },
            { text: "Bear crawl to the [location] and back!", minAge: 6 },
            { text: "Skip around the room for [time_long]!", minAge: 5 }
        ],
        Hard: [
            { text: "Complete [number_large] [exercise_hard]!", minAge: 9 },
            { text: "Do a fitness circuit: [number_small] jumps, [number_small] squats, [number_small] spins!", minAge: 8 },
            { text: "Hold a wall sit for [time_short]!", minAge: 9 },
            { text: "Create and complete your own [number_small]-exercise workout!", minAge: 10 },
            { text: "Do [number_small] burpees without stopping!", minAge: 9 },
            { text: "Run in place for [time_long] without slowing down!", minAge: 8 },
            { text: "Complete [number_large] mountain climbers!", minAge: 9 },
            { text: "Do [number_small] sets of [number_small] push-ups!", minAge: 9 },
            { text: "Hold a plank while counting to [number_large]!", minAge: 8 },
            { text: "Jump rope (real or pretend) for [time_long]!", minAge: 8 }
        ],
        Epic: [
            { text: "EPIC: Complete 50 total exercises of your choice!", minAge: 10 },
            { text: "LEGENDARY: Do [exercise_hard] until you can't anymore and record your max!", minAge: 11 },
            { text: "ULTIMATE: Complete a 10-minute workout without stopping!", minAge: 11 },
            { text: "HERO CHALLENGE: Do 100 jumping jacks!", minAge: 10 }
        ]
    },

    // üé® FLOW - Creative quests
    flow: {
        Easy: [
            { text: "Draw a [animal]!", minAge: 4 },
            { text: "Draw [creative]!", minAge: 4 },
            { text: "Make a silly face and hold it for [time_short]!", minAge: 4 },
            { text: "Build something cool with [number_small] toys!", minAge: 4 },
            { text: "Tell a joke to someone!", minAge: 5 },
            { text: "Draw a [color] [animal]!", minAge: 4 },
            { text: "Make up a silly song about a [animal]!", minAge: 4 },
            { text: "Use [number_small] different colors in one drawing!", minAge: 4 },
            { text: "Draw your family as [animal]s!", minAge: 5 },
            { text: "Build the tallest tower you can with blocks!", minAge: 4 },
            { text: "Act like a [animal] for [time_short]!", minAge: 4 },
            { text: "Draw something that makes you happy!", minAge: 4 }
        ],
        Medium: [
            { text: "Draw a [animal] doing [exercise_easy]!", minAge: 5 },
            { text: "Write a short story about a [animal]!", minAge: 7 },
            { text: "Create a paper airplane and fly it [number_small] times!", minAge: 6 },
            { text: "Make up a song about a [object_easy]!", minAge: 5 },
            { text: "Build the tallest tower you can!", minAge: 5 },
            { text: "Draw a map of your home!", minAge: 6 },
            { text: "Create a secret handshake with someone!", minAge: 6 },
            { text: "Make a card for someone you love!", minAge: 5 },
            { text: "Invent a new game and write the rules!", minAge: 7 },
            { text: "Create [number_small] different paper airplanes!", minAge: 6 },
            { text: "Draw a comic with [number_small] panels!", minAge: 7 },
            { text: "Build an obstacle course and complete it!", minAge: 6 }
        ],
        Hard: [
            { text: "Draw a detailed scene with [number_small] different [animal]s!", minAge: 8 },
            { text: "Write a poem with at least [number_small] lines!", minAge: 9 },
            { text: "Create a comic strip with [number_small] panels!", minAge: 8 },
            { text: "Design your dream treehouse and draw it!", minAge: 7 },
            { text: "Write a story with a beginning, middle, and end!", minAge: 8 },
            { text: "Create a puppet show and perform it!", minAge: 8 },
            { text: "Design a new superhero with powers and a costume!", minAge: 8 },
            { text: "Build something amazing using only household items!", minAge: 8 },
            { text: "Create a board game with rules!", minAge: 9 },
            { text: "Draw a detailed map of an imaginary world!", minAge: 8 }
        ],
        Epic: [
            { text: "EPIC: Create a complete illustrated story with beginning, middle, and end!", minAge: 9 },
            { text: "LEGENDARY: Build an invention from household items and explain what it does!", minAge: 10 },
            { text: "ULTIMATE: Write and perform a short play!", minAge: 10 },
            { text: "MASTER ARTIST: Create a gallery of [number_small] different artworks!", minAge: 10 }
        ]
    },

    // üåø TERRA - Household and nature quests
    terra: {
        Easy: [
            { text: "Find something [color]!", minAge: 4 },
            { text: "Find [number_small] different [object_easy]s!", minAge: 4 },
            { text: "Put away [number_small] toys!", minAge: 4 },
            { text: "Water a plant!", minAge: 4 },
            { text: "Help set the table!", minAge: 5 },
            { text: "Find [number_small] things that are soft!", minAge: 4 },
            { text: "Match [number_small] pairs of socks!", minAge: 4 },
            { text: "Put your shoes in the right place!", minAge: 4 },
            { text: "Help fold [number_small] small towels!", minAge: 5 },
            { text: "Find something that starts with the letter [letter]!", minAge: 5 },
            { text: "Pick up [number_small] things from the floor!", minAge: 4 },
            { text: "Put [number_small] books on the shelf!", minAge: 4 }
        ],
        Medium: [
            { text: "Clean up the [location]!", minAge: 5 },
            { text: "Find [number_small] things that start with the letter [letter]!", minAge: 6 },
            { text: "Organize your [object_easy] collection!", minAge: 6 },
            { text: "Make your bed perfectly!", minAge: 6 },
            { text: "Sort laundry by color!", minAge: 7 },
            { text: "Wipe down the table after a meal!", minAge: 6 },
            { text: "Help put away groceries!", minAge: 6 },
            { text: "Organize your bookshelf!", minAge: 6 },
            { text: "Help sweep the floor!", minAge: 7 },
            { text: "Clean your desk or workspace!", minAge: 6 },
            { text: "Feed a pet (with permission)!", minAge: 6 },
            { text: "Help sort the recycling!", minAge: 6 }
        ],
        Hard: [
            { text: "Deep clean [room] - make it sparkle!", minAge: 8 },
            { text: "Organize a drawer or closet!", minAge: 8 },
            { text: "Help prepare a meal or snack!", minAge: 9 },
            { text: "Complete [number_small] different chores!", minAge: 8 },
            { text: "Vacuum or sweep an entire room!", minAge: 8 },
            { text: "Help wash and dry the dishes!", minAge: 8 },
            { text: "Organize the pantry or fridge!", minAge: 9 },
            { text: "Clean the bathroom sink and mirror!", minAge: 9 },
            { text: "Help with yard work for [time_long]!", minAge: 9 },
            { text: "Sort through old toys to donate!", minAge: 8 }
        ],
        Epic: [
            { text: "EPIC: Clean and organize an entire room!", minAge: 10 },
            { text: "LEGENDARY: Plan and prepare a simple meal for the family!", minAge: 11 },
            { text: "ULTIMATE: Complete a full house cleaning checklist!", minAge: 11 },
            { text: "NATURE HERO: Create and maintain a small garden for a week!", minAge: 10 }
        ]
    },

    // üí® BREEZE - Quick and easy quests
    breeze: {
        Easy: [
            { text: "Give someone a high five!", minAge: 4 },
            { text: "Smile at yourself in the mirror!", minAge: 4 },
            { text: "Take [number_small] deep breaths!", minAge: 4 },
            { text: "Say something nice to someone!", minAge: 4 },
            { text: "Drink a glass of water!", minAge: 4 },
            { text: "Give someone a hug!", minAge: 4 },
            { text: "Say 'I love you' to someone!", minAge: 4 },
            { text: "Name [number_small] things you're thankful for!", minAge: 4 },
            { text: "Do [number_small] deep breaths with your eyes closed!", minAge: 4 },
            { text: "Tell someone about your day!", minAge: 4 },
            { text: "Wash your hands really well!", minAge: 4 },
            { text: "Brush your teeth for [time_short]!", minAge: 4 }
        ],
        Medium: [
            { text: "Read for [time_long]!", minAge: 6 },
            { text: "Practice writing your name [number_small] times!", minAge: 5 },
            { text: "Learn [number_small] new words and what they mean!", minAge: 7 },
            { text: "Help someone with something they're doing!", minAge: 5 },
            { text: "Sit quietly and think about your day for [time_short]!", minAge: 6 },
            { text: "Tell someone [number_small] things that made you happy today!", minAge: 5 },
            { text: "Practice a skill you're learning for [time_long]!", minAge: 6 },
            { text: "Write down [number_small] goals for tomorrow!", minAge: 7 },
            { text: "Do a random act of kindness!", minAge: 6 },
            { text: "Call or video chat with a family member!", minAge: 6 },
            { text: "Write a thank-you note to someone!", minAge: 7 },
            { text: "Meditate or sit quietly for [time_short]!", minAge: 7 }
        ],
        Hard: [
            { text: "Read a chapter of a book!", minAge: 8 },
            { text: "Practice a skill for [time_long] without stopping!", minAge: 8 },
            { text: "Teach someone something you know how to do!", minAge: 8 },
            { text: "Write in a journal for [time_long]!", minAge: 8 },
            { text: "Learn [number_small] facts about a topic that interests you!", minAge: 8 },
            { text: "Complete a homework assignment without help!", minAge: 8 },
            { text: "Read to a younger sibling or pet!", minAge: 8 },
            { text: "Practice math facts for [time_long]!", minAge: 8 },
            { text: "Write a letter to a friend or family member!", minAge: 8 },
            { text: "Research and present [number_small] facts about any topic!", minAge: 9 }
        ],
        Epic: [
            { text: "EPIC: Complete a puzzle with 100+ pieces!", minAge: 9 },
            { text: "LEGENDARY: Learn and demonstrate a brand new skill!", minAge: 10 },
            { text: "ULTIMATE: Read an entire book in one day!", minAge: 10 },
            { text: "MINDFULNESS MASTER: Meditate for 10 minutes!", minAge: 10 }
        ]
    }
};

// ============================================================================
// SECTION 4: SHOP ITEMS DATABASE
// ============================================================================

const SHOP_ITEMS = [
    // Avatar Parts - Hats
    { id: 'hat_1', name: 'Crown', type: 'avatar_part', slot: 'hat', rarity: 'rare', price: 100, emoji: 'üëë' },
    { id: 'hat_2', name: 'Wizard Hat', type: 'avatar_part', slot: 'hat', rarity: 'epic', price: 200, emoji: 'üßô' },
    { id: 'hat_3', name: 'Party Hat', type: 'avatar_part', slot: 'hat', rarity: 'common', price: 30, emoji: 'üéâ' },
    { id: 'hat_4', name: 'Pirate Hat', type: 'avatar_part', slot: 'hat', rarity: 'rare', price: 120, emoji: 'üè¥‚Äç‚ò†Ô∏è' },
    { id: 'hat_5', name: 'Viking Helmet', type: 'avatar_part', slot: 'hat', rarity: 'epic', price: 250, emoji: '‚öîÔ∏è' },
    { id: 'hat_6', name: 'Baseball Cap', type: 'avatar_part', slot: 'hat', rarity: 'common', price: 25, emoji: 'üß¢' },
    
    // Avatar Parts - Accessories
    { id: 'acc_1', name: 'Cool Shades', type: 'avatar_part', slot: 'accessory', rarity: 'common', price: 40, emoji: 'üòé' },
    { id: 'acc_2', name: 'Magic Wand', type: 'avatar_part', slot: 'accessory', rarity: 'epic', price: 180, emoji: '‚ú®' },
    { id: 'acc_3', name: 'Hero Cape', type: 'avatar_part', slot: 'accessory', rarity: 'legendary', price: 500, emoji: 'ü¶∏' },
    { id: 'acc_4', name: 'Bow Tie', type: 'avatar_part', slot: 'accessory', rarity: 'common', price: 35, emoji: 'üéÄ' },
    { id: 'acc_5', name: 'Sword', type: 'avatar_part', slot: 'accessory', rarity: 'rare', price: 150, emoji: '‚öîÔ∏è' },
    
    // Stickers
    { id: 'sticker_1', name: 'Gold Star', type: 'sticker', rarity: 'common', price: 15, emoji: '‚≠ê' },
    { id: 'sticker_2', name: 'Rainbow', type: 'sticker', rarity: 'rare', price: 50, emoji: 'üåà' },
    { id: 'sticker_3', name: 'Dragon', type: 'sticker', rarity: 'epic', price: 150, emoji: 'üêâ' },
    { id: 'sticker_4', name: 'Unicorn', type: 'sticker', rarity: 'legendary', price: 300, emoji: 'ü¶Ñ' },
    { id: 'sticker_5', name: 'Rocket', type: 'sticker', rarity: 'rare', price: 60, emoji: 'üöÄ' },
    { id: 'sticker_6', name: 'Heart', type: 'sticker', rarity: 'common', price: 10, emoji: '‚ù§Ô∏è' },
    { id: 'sticker_7', name: 'Fire', type: 'sticker', rarity: 'common', price: 20, emoji: 'üî•' },
    { id: 'sticker_8', name: 'Lightning', type: 'sticker', rarity: 'rare', price: 75, emoji: '‚ö°' },
    
    // Mystery Boxes
    { id: 'box_1', name: 'Mystery Box', type: 'mystery_box', rarity: 'rare', price: 100, emoji: 'üì¶' },
    { id: 'box_2', name: 'Premium Box', type: 'mystery_box', rarity: 'epic', price: 250, emoji: 'üéÅ' },
    { id: 'box_3', name: 'Legendary Chest', type: 'mystery_box', rarity: 'legendary', price: 500, emoji: 'üëë' }
];

// ============================================================================
// SECTION 5: DEFAULT AVATAR CONFIGURATION
// ============================================================================

const DEFAULT_AVATAR = {
    skinTone: '#FFD5B8',
    hairStyle: 'spiky',
    hairColor: '#4A3728',
    eyeStyle: 'happy',
    eyeColor: '#4A90D9',
    outfit: 'tshirt',
    outfitColor: '#3B82F6',
    hat: null,
    accessory: null
};

// Skin tone options
const SKIN_TONES = [
    '#FFDBAC', '#F5CBA7', '#FFD5B8', '#E8BEAC', '#D4A574',
    '#C68642', '#8D5524', '#6B4423', '#4A3728', '#3B2F2F'
];

// Hair style options
const HAIR_STYLES = ['spiky', 'wavy', 'curly', 'short', 'long', 'ponytail', 'mohawk', 'bald'];

// Hair colors
const HAIR_COLORS = [
    '#4A3728', '#8B4513', '#2C1810', '#FFD700', '#FF6B35',
    '#9B59B6', '#3498DB', '#E74C3C', '#1ABC9C', '#F39C12'
];

// Eye styles
const EYE_STYLES = ['happy', 'cool', 'surprised', 'sleepy', 'wink'];

// Eye colors
const EYE_COLORS = ['#4A90D9', '#2ECC71', '#8B4513', '#1A1A2E', '#9B59B6'];

// Outfit styles
const OUTFIT_STYLES = ['tshirt', 'hoodie', 'dress', 'superhero', 'wizard', 'sporty'];

// Outfit colors
const OUTFIT_COLORS = [
    '#3B82F6', '#EF4444', '#22C55E', '#F59E0B', '#8B5CF6',
    '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1'
];

// ============================================================================
// SECTION 6: UTILITY FUNCTIONS
// ============================================================================

// Calculate age from date of birth
function calculateAge(dob) {
    if (!dob) return 8; // Default age
    const birth = new Date(dob);
    const today = new Date();
    let age = today.getFullYear() - birth.getFullYear();
    const monthDiff = today.getMonth() - birth.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    return Math.max(4, Math.min(13, age)); // Clamp between 4-13
}

// Weighted random selection
function weightedRandomChoice(options, weights) {
    const total = options.reduce((sum, opt) => sum + (weights[opt] || 0), 0);
    let random = Math.random() * total;
    for (const option of options) {
        random -= weights[option] || 0;
        if (random <= 0) return option;
    }
    return options[0];
}

// Replace template placeholders with random values
function fillTemplate(template) {
    return template.replace(/\[(\w+)\]/g, (match, key) => {
        const bank = WORD_BANKS[key];
        if (bank && bank.length > 0) {
            return bank[Math.floor(Math.random() * bank.length)];
        }
        return match; // Return original if no match
    });
}

// Generate a quest for a player
function generateQuest(playerAge = 8, preferredCategory = null) {
    // Clamp age
    const age = Math.max(4, Math.min(13, playerAge || 8));
    
    // Determine available difficulties based on age
    let availableDifficulties = ['Easy', 'Medium'];
    if (age >= 8) availableDifficulties.push('Hard');
    if (age >= 10) availableDifficulties.push('Epic');
    
    // Weight difficulties (easier ones more common for younger kids)
    const difficultyWeights = {
        'Easy': age < 7 ? 60 : 35,
        'Medium': age < 7 ? 35 : 45,
        'Hard': 15,
        'Epic': 5
    };
    
    // Pick category
    const categories = ['blaze', 'flow', 'terra', 'breeze'];
    const category = preferredCategory && categories.includes(preferredCategory)
        ? preferredCategory
        : categories[Math.floor(Math.random() * categories.length)];
    
    // Pick difficulty
    const difficulty = weightedRandomChoice(availableDifficulties, difficultyWeights);
    
    // Get templates and filter by age
    const templates = QUEST_TEMPLATES[category][difficulty] || QUEST_TEMPLATES[category]['Easy'];
    const ageAppropriate = templates.filter(t => (t.minAge || 4) <= age);
    
    // Fallback to Easy if no age-appropriate templates
    const finalTemplates = ageAppropriate.length > 0
        ? ageAppropriate
        : QUEST_TEMPLATES[category]['Easy'].filter(t => (t.minAge || 4) <= age);
    
    // Pick random template
    const template = finalTemplates[Math.floor(Math.random() * finalTemplates.length)] || { text: "Do something fun!", minAge: 4 };
    
    // Fill in the template
    const questText = fillTemplate(template.text);
    
    // Get rewards
    const rewards = DIFFICULTY_CONFIG[difficulty] || DIFFICULTY_CONFIG['Easy'];
    
    return {
        id: `quest_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
        text: questText,
        category,
        difficulty,
        rewards: {
            sparks: rewards.sparks,
            xp: rewards.xp
        }
    };
}

// ============================================================================
// SECTION 7: GAME CONTEXT (STATE MANAGEMENT)
// ============================================================================

const GameContext = createContext();

function useGame() {
    const context = useContext(GameContext);
    if (!context) {
        throw new Error('useGame must be used within a GameProvider');
    }
    return context;
}

function GameProvider({ children }) {
    // Load state from localStorage
    const loadState = () => {
        try {
            const saved = localStorage.getItem('sparkquest_data');
            if (saved) {
                return JSON.parse(saved);
            }
        } catch (e) {
            console.error('Error loading state:', e);
        }
        return null;
    };

    const savedState = loadState();

    // Players state
    const [players, setPlayers] = useState(savedState?.players || []);
    const [activePlayerIndex, setActivePlayerIndex] = useState(savedState?.activePlayerIndex || 0);
    
    // UI state
    const [currentView, setCurrentView] = useState('home');
    const [currentQuest, setCurrentQuest] = useState(null);
    const [isSpinning, setIsSpinning] = useState(false);
    const [showCompletion, setShowCompletion] = useState(false);

    // Get active player
    const activePlayer = players[activePlayerIndex] || null;

    // Save state to localStorage
    useEffect(() => {
        const state = {
            players,
            activePlayerIndex
        };
        localStorage.setItem('sparkquest_data', JSON.stringify(state));
    }, [players, activePlayerIndex]);

    // Create a new player
    const createPlayer = useCallback((playerData) => {
        const newPlayer = {
            id: `player_${Date.now()}`,
            username: playerData.username || 'Hero',
            dob: playerData.dob || null,
            sparks: 0,
            xp: 0,
            level: 1,
            streak: 0,
            lastPlayedDate: null,
            inventory: [],
            completedQuests: [],
            avatar: { ...DEFAULT_AVATAR, ...playerData.avatar }
        };
        setPlayers(prev => [...prev, newPlayer]);
        setActivePlayerIndex(players.length);
        return newPlayer;
    }, [players.length]);

    // Update player data
    const updatePlayer = useCallback((playerId, updates) => {
        setPlayers(prev => prev.map(p => 
            p.id === playerId ? { ...p, ...updates } : p
        ));
    }, []);

    // Delete player
    const deletePlayer = useCallback((playerId) => {
        setPlayers(prev => prev.filter(p => p.id !== playerId));
        if (activePlayerIndex >= players.length - 1) {
            setActivePlayerIndex(Math.max(0, activePlayerIndex - 1));
        }
    }, [activePlayerIndex, players.length]);

    // Generate a new quest
    const spinQuest = useCallback(() => {
        if (!activePlayer || isSpinning) return;
        
        setIsSpinning(true);
        const playerAge = calculateAge(activePlayer.dob);
        
        // Simulate spinner delay
        setTimeout(() => {
            const quest = generateQuest(playerAge);
            setCurrentQuest(quest);
            setIsSpinning(false);
        }, 1500);
    }, [activePlayer, isSpinning]);

    // Complete a quest
    const completeQuest = useCallback((quest) => {
        if (!activePlayer || !quest) return;

        const today = new Date().toDateString();
        const lastPlayed = activePlayer.lastPlayedDate;
        const yesterday = new Date(Date.now() - 86400000).toDateString();
        
        // Calculate streak
        let newStreak = activePlayer.streak;
        if (lastPlayed === yesterday) {
            newStreak += 1;
        } else if (lastPlayed !== today) {
            newStreak = 1;
        }

        // Calculate bonus multiplier for streaks
        const streakBonus = Math.min(newStreak * 0.1, 0.5); // Max 50% bonus
        const bonusMultiplier = 1 + streakBonus;

        const sparksEarned = Math.round(quest.rewards.sparks * bonusMultiplier);
        const xpEarned = Math.round(quest.rewards.xp * bonusMultiplier);

        // Update player
        const newXp = activePlayer.xp + xpEarned;
        const newLevel = LEVEL_CONFIG.getLevel(newXp);

        updatePlayer(activePlayer.id, {
            sparks: activePlayer.sparks + sparksEarned,
            xp: newXp,
            level: newLevel,
            streak: newStreak,
            lastPlayedDate: today,
            completedQuests: [
                { questId: quest.id, timestamp: Date.now() },
                ...activePlayer.completedQuests.slice(0, 99) // Keep last 100
            ]
        });

        setShowCompletion(true);
        
        // Return earned amounts for display
        return { sparksEarned, xpEarned, streakBonus: streakBonus > 0 };
    }, [activePlayer, updatePlayer]);

    // Buy an item from the shop
    const buyItem = useCallback((itemId) => {
        if (!activePlayer) return { success: false, message: 'No active player' };
        
        const item = SHOP_ITEMS.find(i => i.id === itemId);
        if (!item) return { success: false, message: 'Item not found' };
        
        if (activePlayer.sparks < item.price) {
            return { success: false, message: 'Not enough Sparks!' };
        }
        
        if (activePlayer.inventory.includes(itemId)) {
            return { success: false, message: 'You already own this!' };
        }

        updatePlayer(activePlayer.id, {
            sparks: activePlayer.sparks - item.price,
            inventory: [...activePlayer.inventory, itemId]
        });

        return { success: true, message: `You got ${item.name}!` };
    }, [activePlayer, updatePlayer]);

    // Equip an item
    const equipItem = useCallback((itemId) => {
        if (!activePlayer) return;
        
        const item = SHOP_ITEMS.find(i => i.id === itemId);
        if (!item || item.type !== 'avatar_part') return;
        
        const slot = item.slot; // 'hat' or 'accessory'
        updatePlayer(activePlayer.id, {
            avatar: {
                ...activePlayer.avatar,
                [slot]: activePlayer.avatar[slot] === itemId ? null : itemId
            }
        });
    }, [activePlayer, updatePlayer]);

    const value = {
        // State
        players,
        activePlayer,
        activePlayerIndex,
        currentView,
        currentQuest,
        isSpinning,
        showCompletion,
        
        // Actions
        setActivePlayerIndex,
        setCurrentView,
        setCurrentQuest,
        setShowCompletion,
        createPlayer,
        updatePlayer,
        deletePlayer,
        spinQuest,
        completeQuest,
        buyItem,
        equipItem
    };

    return (
        <GameContext.Provider value={value}>
            {children}
        </GameContext.Provider>
    );
}

// ============================================================================
// SECTION 8: AVATAR COMPONENT
// ============================================================================

function BlockyAvatar({ config, size = 'md' }) {
    const sizes = {
        xs: { width: 48, scale: 0.4 },
        sm: { width: 64, scale: 0.5 },
        md: { width: 96, scale: 0.8 },
        lg: { width: 128, scale: 1 },
        xl: { width: 192, scale: 1.5 }
    };
    
    const { width, scale } = sizes[size] || sizes.md;
    const c = { ...DEFAULT_AVATAR, ...config };
    
    // Hair styles as SVG paths
    const hairPaths = {
        spiky: "M30,35 L35,15 L45,30 L55,10 L65,30 L75,15 L80,35",
        wavy: "M25,40 Q35,20 50,35 Q65,20 80,40",
        curly: "M25,40 Q30,25 40,35 Q45,20 55,35 Q60,20 70,35 Q75,25 85,40",
        short: "M30,40 L30,30 L80,30 L80,40",
        long: "M25,35 L25,80 L35,80 L35,45 L75,45 L75,80 L85,80 L85,35",
        ponytail: "M30,35 L30,30 L80,30 L80,35 M75,30 L85,50 L75,70",
        mohawk: "M48,40 L48,5 L52,5 L58,5 L62,5 L62,40",
        bald: ""
    };

    return (
        <svg width={width} height={width} viewBox="0 0 110 130" style={{ display: 'block' }}>
            {/* Background circle */}
            <circle cx="55" cy="65" r="50" fill="#E0F2FE" />
            
            {/* Body */}
            <rect x="35" y="85" width="40" height="35" rx="5" fill={c.outfitColor} />
            
            {/* Head */}
            <rect x="30" y="30" width="50" height="55" rx="10" fill={c.skinTone} />
            
            {/* Hair */}
            {c.hairStyle !== 'bald' && (
                <path d={hairPaths[c.hairStyle] || hairPaths.spiky} fill={c.hairColor} />
            )}
            
            {/* Eyes */}
            <g>
                {c.eyeStyle === 'happy' && (
                    <>
                        <ellipse cx="42" cy="55" rx="5" ry="6" fill="white" />
                        <ellipse cx="68" cy="55" rx="5" ry="6" fill="white" />
                        <circle cx="43" cy="56" r="3" fill={c.eyeColor} />
                        <circle cx="69" cy="56" r="3" fill={c.eyeColor} />
                        <circle cx="44" cy="55" r="1" fill="white" />
                        <circle cx="70" cy="55" r="1" fill="white" />
                    </>
                )}
                {c.eyeStyle === 'cool' && (
                    <>
                        <rect x="35" y="52" width="15" height="6" rx="2" fill="#1A1A2E" />
                        <rect x="60" y="52" width="15" height="6" rx="2" fill="#1A1A2E" />
                    </>
                )}
                {c.eyeStyle === 'surprised' && (
                    <>
                        <circle cx="42" cy="55" r="7" fill="white" stroke="#333" strokeWidth="2" />
                        <circle cx="68" cy="55" r="7" fill="white" stroke="#333" strokeWidth="2" />
                        <circle cx="42" cy="55" r="4" fill={c.eyeColor} />
                        <circle cx="68" cy="55" r="4" fill={c.eyeColor} />
                    </>
                )}
                {c.eyeStyle === 'sleepy' && (
                    <>
                        <path d="M37,55 Q42,52 47,55" stroke="#333" strokeWidth="3" fill="none" strokeLinecap="round" />
                        <path d="M63,55 Q68,52 73,55" stroke="#333" strokeWidth="3" fill="none" strokeLinecap="round" />
                    </>
                )}
                {c.eyeStyle === 'wink' && (
                    <>
                        <ellipse cx="42" cy="55" rx="5" ry="6" fill="white" />
                        <circle cx="43" cy="56" r="3" fill={c.eyeColor} />
                        <path d="M63,55 Q68,52 73,55" stroke="#333" strokeWidth="3" fill="none" strokeLinecap="round" />
                    </>
                )}
            </g>
            
            {/* Mouth */}
            <path d="M45,70 Q55,78 65,70" stroke="#333" strokeWidth="2" fill="none" strokeLinecap="round" />
            
            {/* Hat (if equipped) */}
            {c.hat && (
                <text x="55" y="25" textAnchor="middle" fontSize="24">
                    {SHOP_ITEMS.find(i => i.id === c.hat)?.emoji || ''}
                </text>
            )}
            
            {/* Accessory (if equipped) */}
            {c.accessory && (
                <text x="90" y="60" textAnchor="middle" fontSize="20">
                    {SHOP_ITEMS.find(i => i.id === c.accessory)?.emoji || ''}
                </text>
            )}
        </svg>
    );
}

// ============================================================================
// SECTION 9: UI COMPONENTS
// ============================================================================

// Spark Counter with animation
function SparkCounter({ amount }) {
    return (
        <div className="spark-counter flex items-center gap-2">
            <span className="text-xl">‚ö°</span>
            <span className="text-lg">{amount}</span>
        </div>
    );
}

// Level progress bar
function LevelProgress({ xp, level }) {
    const progress = LEVEL_CONFIG.getProgress(xp);
    const toNext = LEVEL_CONFIG.getXpToNext(xp);
    
    return (
        <div className="flex items-center gap-3">
            <div className="bg-purple-100 px-3 py-1 rounded-full">
                <span className="text-purple-700 font-bold text-sm">Lvl {level}</span>
            </div>
            <div className="flex-1">
                <div className="h-2 bg-slate-200 rounded-full overflow-hidden">
                    <div 
                        className="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-500"
                        style={{ width: `${progress}%` }}
                    />
                </div>
                <p className="text-xs text-slate-400 mt-1">{toNext} XP to next level</p>
            </div>
        </div>
    );
}

// Streak flame display
function StreakFlame({ streak }) {
    if (streak <= 0) return null;
    
    return (
        <div className="flex items-center gap-1 bg-orange-100 px-3 py-1 rounded-full">
            <span className="text-lg" style={{ animation: 'flame-flicker 0.5s ease-in-out infinite' }}>üî•</span>
            <span className="text-orange-700 font-bold text-sm">{streak} day streak!</span>
        </div>
    );
}

// Quest card display
function QuestCard({ quest, onComplete }) {
    const catConfig = CATEGORY_CONFIG[quest.category];
    const diffConfig = DIFFICULTY_CONFIG[quest.difficulty];
    
    return (
        <div className={`card card-elevated p-6 quest-${quest.category} border-l-4 animate-bounce-in`}>
            <div className="flex items-center gap-2 mb-3">
                <span className="text-2xl">{catConfig.emoji}</span>
                <span className={`text-xs font-bold uppercase text-${catConfig.color}-600`}>
                    {catConfig.label}
                </span>
                <span className={`ml-auto text-xs font-bold px-2 py-1 rounded-full bg-${diffConfig.color}-100 text-${diffConfig.color}-700`}>
                    {diffConfig.label}
                </span>
            </div>
            
            <h3 className="text-xl font-bold text-slate-800 mb-4">{quest.text}</h3>
            
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <span className="text-sm font-bold text-yellow-600">‚ö° {quest.rewards.sparks}</span>
                    <span className="text-sm font-bold text-purple-600">‚ú® {quest.rewards.xp} XP</span>
                </div>
                
                <button 
                    onClick={() => onComplete(quest)}
                    className="btn-primary"
                >
                    Complete! ‚úì
                </button>
            </div>
        </div>
    );
}

// Completion modal with confetti
function CompletionModal({ rewards, onClose }) {
    const [confetti, setConfetti] = useState([]);
    
    useEffect(() => {
        // Generate confetti
        const pieces = Array.from({ length: 50 }, (_, i) => ({
            id: i,
            left: Math.random() * 100,
            delay: Math.random() * 0.5,
            color: ['#FFD700', '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7'][Math.floor(Math.random() * 6)]
        }));
        setConfetti(pieces);
    }, []);
    
    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            {/* Confetti */}
            {confetti.map(piece => (
                <div
                    key={piece.id}
                    className="absolute w-3 h-3 rounded-sm"
                    style={{
                        left: `${piece.left}%`,
                        top: '-20px',
                        backgroundColor: piece.color,
                        animation: `confetti-fall 2s ease-in forwards`,
                        animationDelay: `${piece.delay}s`
                    }}
                />
            ))}
            
            <div className="card card-elevated p-8 text-center max-w-sm w-full animate-bounce-in">
                <div className="text-6xl mb-4">üéâ</div>
                <h2 className="text-2xl font-bold text-slate-800 mb-2">Quest Complete!</h2>
                
                <div className="bg-gradient-to-r from-yellow-100 to-purple-100 rounded-2xl p-4 mb-4">
                    <div className="flex justify-center gap-6">
                        <div>
                            <div className="text-3xl font-bold text-yellow-600">+{rewards.sparks}</div>
                            <div className="text-sm text-slate-500">Sparks</div>
                        </div>
                        <div>
                            <div className="text-3xl font-bold text-purple-600">+{rewards.xp}</div>
                            <div className="text-sm text-slate-500">XP</div>
                        </div>
                    </div>
                </div>
                
                {rewards.streakBonus && (
                    <div className="bg-orange-100 rounded-xl p-2 mb-4">
                        <span className="text-orange-700 font-bold text-sm">üî• Streak Bonus Applied!</span>
                    </div>
                )}
                
                <button onClick={onClose} className="btn-primary w-full">
                    Awesome! üöÄ
                </button>
            </div>
        </div>
    );
}

// ============================================================================
// SECTION 10: MAIN SCREENS
// ============================================================================

// Player Setup Screen
function PlayerSetupScreen() {
    const { createPlayer, setCurrentView } = useGame();
    const [step, setStep] = useState(1);
    const [username, setUsername] = useState('');
    const [dob, setDob] = useState('');
    const [avatar, setAvatar] = useState({ ...DEFAULT_AVATAR });
    
    const handleComplete = () => {
        createPlayer({ username, dob, avatar });
        setCurrentView('home');
    };
    
    return (
        <div className="min-h-screen p-4 flex flex-col items-center justify-center">
            <div className="card p-6 w-full max-w-md">
                {step === 1 && (
                    <div className="text-center">
                        <h2 className="text-2xl font-bold text-slate-800 mb-4">üëã What's your name?</h2>
                        <input
                            type="text"
                            value={username}
                            onChange={(e) => setUsername(e.target.value)}
                            placeholder="Enter your name..."
                            className="w-full p-4 text-lg border-2 border-slate-200 rounded-xl focus:border-sky-400 focus:outline-none mb-4"
                            maxLength={20}
                        />
                        <button 
                            onClick={() => setStep(2)}
                            disabled={!username.trim()}
                            className="btn-primary w-full disabled:opacity-50"
                        >
                            Next ‚Üí
                        </button>
                    </div>
                )}
                
                {step === 2 && (
                    <div className="text-center">
                        <h2 className="text-2xl font-bold text-slate-800 mb-2">üéÇ When's your birthday?</h2>
                        <p className="text-slate-500 text-sm mb-4">This helps us pick the right quests for you!</p>
                        <input
                            type="date"
                            value={dob}
                            onChange={(e) => setDob(e.target.value)}
                            className="w-full p-4 text-lg border-2 border-slate-200 rounded-xl focus:border-sky-400 focus:outline-none mb-4"
                        />
                        <div className="flex gap-2">
                            <button onClick={() => setStep(1)} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-600">
                                ‚Üê Back
                            </button>
                            <button 
                                onClick={() => setStep(3)}
                                className="flex-1 btn-primary"
                            >
                                Next ‚Üí
                            </button>
                        </div>
                    </div>
                )}
                
                {step === 3 && (
                    <div>
                        <h2 className="text-2xl font-bold text-slate-800 mb-4 text-center">üé® Create Your Avatar!</h2>
                        
                        <div className="flex justify-center mb-4">
                            <div className="bg-sky-50 rounded-2xl p-4">
                                <BlockyAvatar config={avatar} size="lg" />
                            </div>
                        </div>
                        
                        {/* Skin Tone */}
                        <div className="mb-4">
                            <label className="text-sm font-bold text-slate-600 mb-2 block">Skin Tone</label>
                            <div className="flex flex-wrap gap-2">
                                {SKIN_TONES.map(tone => (
                                    <button
                                        key={tone}
                                        onClick={() => setAvatar(a => ({ ...a, skinTone: tone }))}
                                        className={`w-8 h-8 rounded-full border-2 ${avatar.skinTone === tone ? 'border-sky-500 ring-2 ring-sky-200' : 'border-slate-200'}`}
                                        style={{ backgroundColor: tone }}
                                    />
                                ))}
                            </div>
                        </div>
                        
                        {/* Hair Style */}
                        <div className="mb-4">
                            <label className="text-sm font-bold text-slate-600 mb-2 block">Hair Style</label>
                            <div className="flex flex-wrap gap-2">
                                {HAIR_STYLES.map(style => (
                                    <button
                                        key={style}
                                        onClick={() => setAvatar(a => ({ ...a, hairStyle: style }))}
                                        className={`px-3 py-1 rounded-full text-sm font-medium capitalize ${avatar.hairStyle === style ? 'bg-sky-500 text-white' : 'bg-slate-100 text-slate-600'}`}
                                    >
                                        {style}
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        {/* Hair Color */}
                        <div className="mb-4">
                            <label className="text-sm font-bold text-slate-600 mb-2 block">Hair Color</label>
                            <div className="flex flex-wrap gap-2">
                                {HAIR_COLORS.map(color => (
                                    <button
                                        key={color}
                                        onClick={() => setAvatar(a => ({ ...a, hairColor: color }))}
                                        className={`w-8 h-8 rounded-full border-2 ${avatar.hairColor === color ? 'border-sky-500 ring-2 ring-sky-200' : 'border-slate-200'}`}
                                        style={{ backgroundColor: color }}
                                    />
                                ))}
                            </div>
                        </div>
                        
                        {/* Outfit Color */}
                        <div className="mb-4">
                            <label className="text-sm font-bold text-slate-600 mb-2 block">Outfit Color</label>
                            <div className="flex flex-wrap gap-2">
                                {OUTFIT_COLORS.map(color => (
                                    <button
                                        key={color}
                                        onClick={() => setAvatar(a => ({ ...a, outfitColor: color }))}
                                        className={`w-8 h-8 rounded-full border-2 ${avatar.outfitColor === color ? 'border-sky-500 ring-2 ring-sky-200' : 'border-slate-200'}`}
                                        style={{ backgroundColor: color }}
                                    />
                                ))}
                            </div>
                        </div>
                        
                        <div className="flex gap-2 mt-6">
                            <button onClick={() => setStep(2)} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-600">
                                ‚Üê Back
                            </button>
                            <button onClick={handleComplete} className="flex-1 btn-primary">
                                Let's Go! üöÄ
                            </button>
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
}

// Home Screen (Quest Hub)
function HomeScreen() {
    const { activePlayer, currentQuest, isSpinning, spinQuest, completeQuest, showCompletion, setShowCompletion, setCurrentQuest } = useGame();
    const [lastRewards, setLastRewards] = useState(null);
    
    const handleComplete = (quest) => {
        const rewards = completeQuest(quest);
        setLastRewards(rewards);
    };
    
    const handleCloseCompletion = () => {
        setShowCompletion(false);
        setCurrentQuest(null);
        setLastRewards(null);
    };
    
    return (
        <div className="p-4 pb-24">
            {/* Player Header */}
            <div className="card p-4 mb-4 flex items-center gap-4">
                <div className="bg-sky-50 rounded-xl p-2">
                    <BlockyAvatar config={activePlayer.avatar} size="sm" />
                </div>
                <div className="flex-1">
                    <h2 className="text-xl font-bold text-slate-800">{activePlayer.username}</h2>
                    <LevelProgress xp={activePlayer.xp} level={activePlayer.level} />
                </div>
                <SparkCounter amount={activePlayer.sparks} />
            </div>
            
            {/* Streak Display */}
            {activePlayer.streak > 0 && (
                <div className="flex justify-center mb-4">
                    <StreakFlame streak={activePlayer.streak} />
                </div>
            )}
            
            {/* Quest Spinner Area */}
            <div className="card p-6 text-center">
                <h3 className="text-lg font-bold text-slate-700 mb-4">üéØ Today's Quest</h3>
                
                {!currentQuest && !isSpinning && (
                    <div>
                        <div className="text-6xl mb-4 animate-float">üé∞</div>
                        <p className="text-slate-500 mb-4">Ready for an adventure?</p>
                        <button onClick={spinQuest} className="btn-primary text-lg px-8 py-4">
                            Spin for a Quest! üé≤
                        </button>
                    </div>
                )}
                
                {isSpinning && (
                    <div>
                        <div className="text-6xl mb-4" style={{ animation: 'spin-wheel 1.5s ease-out' }}>üé°</div>
                        <p className="text-slate-500">Finding your quest...</p>
                    </div>
                )}
                
                {currentQuest && !isSpinning && (
                    <div>
                        <QuestCard quest={currentQuest} onComplete={handleComplete} />
                        <button 
                            onClick={() => setCurrentQuest(null)}
                            className="mt-4 text-sm text-slate-400 hover:text-slate-600"
                        >
                            Skip this quest ‚Üí
                        </button>
                    </div>
                )}
            </div>
            
            {/* Completion Modal */}
            {showCompletion && lastRewards && (
                <CompletionModal rewards={lastRewards} onClose={handleCloseCompletion} />
            )}
        </div>
    );
}

// Shop Screen
function ShopScreen() {
    const { activePlayer, buyItem } = useGame();
    const [selectedCategory, setSelectedCategory] = useState('all');
    const [notification, setNotification] = useState(null);
    
    const categories = [
        { id: 'all', label: 'All', emoji: 'üõí' },
        { id: 'avatar_part', label: 'Avatar', emoji: 'üë§' },
        { id: 'sticker', label: 'Stickers', emoji: '‚≠ê' },
        { id: 'mystery_box', label: 'Mystery', emoji: 'üì¶' }
    ];
    
    const filteredItems = selectedCategory === 'all' 
        ? SHOP_ITEMS 
        : SHOP_ITEMS.filter(i => i.type === selectedCategory);
    
    const handleBuy = (item) => {
        const result = buyItem(item.id);
        setNotification(result);
        setTimeout(() => setNotification(null), 2000);
    };
    
    return (
        <div className="p-4 pb-24">
            <div className="flex items-center justify-between mb-4">
                <h2 className="text-2xl font-bold text-slate-800">üè™ Shop</h2>
                <SparkCounter amount={activePlayer.sparks} />
            </div>
            
            {/* Category Tabs */}
            <div className="flex gap-2 mb-4 overflow-x-auto scrollbar-hide pb-2">
                {categories.map(cat => (
                    <button
                        key={cat.id}
                        onClick={() => setSelectedCategory(cat.id)}
                        className={`flex items-center gap-1 px-4 py-2 rounded-full font-bold text-sm whitespace-nowrap transition-all ${
                            selectedCategory === cat.id 
                                ? 'bg-sky-500 text-white shadow-lg' 
                                : 'bg-white text-slate-500 shadow'
                        }`}
                    >
                        <span>{cat.emoji}</span>
                        <span>{cat.label}</span>
                    </button>
                ))}
            </div>
            
            {/* Items Grid */}
            <div className="grid grid-cols-2 gap-3">
                {filteredItems.map(item => {
                    const owned = activePlayer.inventory.includes(item.id);
                    const canAfford = activePlayer.sparks >= item.price;
                    const rarity = RARITY_CONFIG[item.rarity];
                    
                    return (
                        <div 
                            key={item.id}
                            className={`card p-4 text-center ${rarity.glow} ${!canAfford && !owned ? 'opacity-60' : ''}`}
                        >
                            <div className="text-4xl mb-2">{item.emoji}</div>
                            <h3 className="font-bold text-slate-800 text-sm">{item.name}</h3>
                            <span className={`text-xs font-bold text-${rarity.color}-500 uppercase`}>
                                {rarity.label}
                            </span>
                            
                            {owned ? (
                                <div className="mt-2 py-2 bg-green-100 rounded-lg text-green-700 font-bold text-sm">
                                    ‚úì Owned
                                </div>
                            ) : (
                                <button
                                    onClick={() => handleBuy(item)}
                                    disabled={!canAfford}
                                    className={`mt-2 w-full py-2 rounded-lg font-bold text-sm transition-all ${
                                        canAfford 
                                            ? 'bg-sky-500 text-white hover:bg-sky-600' 
                                            : 'bg-slate-200 text-slate-400 cursor-not-allowed'
                                    }`}
                                >
                                    ‚ö° {item.price}
                                </button>
                            )}
                        </div>
                    );
                })}
            </div>
            
            {/* Notification Toast */}
            {notification && (
                <div className={`fixed bottom-24 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full font-bold shadow-lg animate-bounce-in ${
                    notification.success ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
                }`}>
                    {notification.message}
                </div>
            )}
        </div>
    );
}

// Profile Screen
function ProfileScreen() {
    const { activePlayer, players, setActivePlayerIndex, equipItem, setCurrentView } = useGame();
    const [showInventory, setShowInventory] = useState(true);
    
    const ownedItems = SHOP_ITEMS.filter(i => activePlayer.inventory.includes(i.id));
    const avatarItems = ownedItems.filter(i => i.type === 'avatar_part');
    
    return (
        <div className="p-4 pb-24">
            {/* Player Switcher */}
            {players.length > 1 && (
                <div className="flex gap-2 mb-4 overflow-x-auto scrollbar-hide pb-2">
                    {players.map((p, i) => (
                        <button
                            key={p.id}
                            onClick={() => setActivePlayerIndex(i)}
                            className={`flex items-center gap-2 px-4 py-2 rounded-full font-bold text-sm whitespace-nowrap ${
                                i === players.indexOf(activePlayer)
                                    ? 'bg-sky-500 text-white shadow-lg'
                                    : 'bg-white text-slate-500 shadow'
                            }`}
                        >
                            <BlockyAvatar config={p.avatar} size="xs" />
                            <span>{p.username}</span>
                        </button>
                    ))}
                </div>
            )}
            
            {/* Profile Card */}
            <div className="card p-6 mb-4">
                <div className="flex items-center gap-4">
                    <div className="bg-sky-50 rounded-2xl p-3">
                        <BlockyAvatar config={activePlayer.avatar} size="lg" />
                    </div>
                    <div className="flex-1">
                        <h2 className="text-2xl font-bold text-slate-800">{activePlayer.username}</h2>
                        <div className="flex gap-2 mt-2">
                            <span className="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-bold">
                                Level {activePlayer.level}
                            </span>
                            <SparkCounter amount={activePlayer.sparks} />
                        </div>
                        <div className="mt-3">
                            <LevelProgress xp={activePlayer.xp} level={activePlayer.level} />
                        </div>
                    </div>
                </div>
                
                {activePlayer.streak > 0 && (
                    <div className="mt-4 flex justify-center">
                        <StreakFlame streak={activePlayer.streak} />
                    </div>
                )}
            </div>
            
            {/* Stats */}
            <div className="grid grid-cols-3 gap-3 mb-4">
                <div className="card p-4 text-center">
                    <div className="text-2xl font-bold text-sky-600">{activePlayer.completedQuests.length}</div>
                    <div className="text-xs text-slate-500">Quests Done</div>
                </div>
                <div className="card p-4 text-center">
                    <div className="text-2xl font-bold text-yellow-600">{activePlayer.sparks}</div>
                    <div className="text-xs text-slate-500">Total Sparks</div>
                </div>
                <div className="card p-4 text-center">
                    <div className="text-2xl font-bold text-purple-600">{ownedItems.length}</div>
                    <div className="text-xs text-slate-500">Items Owned</div>
                </div>
            </div>
            
            {/* Tabs */}
            <div className="flex bg-white rounded-xl p-1 shadow mb-4">
                <button
                    onClick={() => setShowInventory(true)}
                    className={`flex-1 py-2 rounded-lg font-bold text-sm ${showInventory ? 'bg-sky-100 text-sky-700' : 'text-slate-400'}`}
                >
                    üéí Inventory
                </button>
                <button
                    onClick={() => setShowInventory(false)}
                    className={`flex-1 py-2 rounded-lg font-bold text-sm ${!showInventory ? 'bg-sky-100 text-sky-700' : 'text-slate-400'}`}
                >
                    üìú Quest Log
                </button>
            </div>
            
            {/* Content */}
            {showInventory ? (
                <div>
                    {avatarItems.length > 0 ? (
                        <div className="grid grid-cols-2 gap-3">
                            {avatarItems.map(item => {
                                const equipped = activePlayer.avatar[item.slot] === item.id;
                                return (
                                    <button
                                        key={item.id}
                                        onClick={() => equipItem(item.id)}
                                        className={`card p-4 text-center ${equipped ? 'ring-2 ring-green-400 bg-green-50' : ''}`}
                                    >
                                        <div className="text-3xl mb-2">{item.emoji}</div>
                                        <div className="font-bold text-sm text-slate-800">{item.name}</div>
                                        <div className={`text-xs mt-1 ${equipped ? 'text-green-600 font-bold' : 'text-slate-400'}`}>
                                            {equipped ? '‚úì Equipped' : 'Tap to equip'}
                                        </div>
                                    </button>
                                );
                            })}
                        </div>
                    ) : (
                        <div className="card p-8 text-center">
                            <div className="text-4xl mb-2">üõí</div>
                            <p className="text-slate-500">No items yet! Visit the shop to get some.</p>
                        </div>
                    )}
                </div>
            ) : (
                <div className="space-y-2">
                    {activePlayer.completedQuests.length > 0 ? (
                        activePlayer.completedQuests.slice(0, 10).map((q, i) => (
                            <div key={i} className="card p-3 flex items-center justify-between">
                                <span className="text-sm text-slate-600">Quest completed</span>
                                <span className="text-xs text-slate-400">
                                    {new Date(q.timestamp).toLocaleDateString()}
                                </span>
                            </div>
                        ))
                    ) : (
                        <div className="card p-8 text-center">
                            <div className="text-4xl mb-2">üìú</div>
                            <p className="text-slate-500">No quests completed yet!</p>
                        </div>
                    )}
                </div>
            )}
            
            {/* Add Player Button */}
            <button
                onClick={() => setCurrentView('setup')}
                className="mt-6 w-full py-3 bg-slate-100 rounded-xl font-bold text-slate-600 hover:bg-slate-200"
            >
                + Add Another Player
            </button>
        </div>
    );
}

// Bottom Navigation
function BottomNav() {
    const { currentView, setCurrentView } = useGame();
    
    const navItems = [
        { id: 'home', icon: 'üéØ', label: 'Quests' },
        { id: 'shop', icon: 'üè™', label: 'Shop' },
        { id: 'profile', icon: 'üë§', label: 'Profile' }
    ];
    
    return (
        <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 safe-area-bottom">
            <div className="flex justify-around items-center h-16 max-w-lg mx-auto">
                {navItems.map(item => (
                    <button
                        key={item.id}
                        onClick={() => setCurrentView(item.id)}
                        className={`flex flex-col items-center justify-center flex-1 h-full transition-all ${
                            currentView === item.id ? 'text-sky-500' : 'text-slate-400'
                        }`}
                    >
                        <span className="text-2xl">{item.icon}</span>
                        <span className="text-xs font-bold mt-1">{item.label}</span>
                    </button>
                ))}
            </div>
        </nav>
    );
}

// ============================================================================
// SECTION 11: MAIN APP COMPONENT
// ============================================================================

function App() {
    const { players, activePlayer, currentView } = useGame();
    
    // Show setup if no players exist
    if (players.length === 0 || currentView === 'setup') {
        return <PlayerSetupScreen />;
    }
    
    // Show main app
    return (
        <div className="min-h-screen max-w-lg mx-auto">
            {currentView === 'home' && <HomeScreen />}
            {currentView === 'shop' && <ShopScreen />}
            {currentView === 'profile' && <ProfileScreen />}
            <BottomNav />
        </div>
    );
}

// ============================================================================
// SECTION 12: RENDER
// ============================================================================

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
    <GameProvider>
        <App />
    </GameProvider>
);
    </script>
</body>
</html>
