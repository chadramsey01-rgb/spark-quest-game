<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Spark Quest ‚öîÔ∏è</title>
    <script>
        window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
    </script>
    <script defer src="/_vercel/insights/script.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { box-sizing: border-box; }
        body { font-family: 'Fredoka', sans-serif; -webkit-tap-highlight-color: transparent; background: linear-gradient(135deg, #e0f2fe 0%, #fae8ff 100%); min-height: 100vh; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        @keyframes bounce-in { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse-glow { 0%, 100% { box-shadow: 0 0 5px rgba(250, 204, 21, 0.5); } 50% { box-shadow: 0 0 20px rgba(250, 204, 21, 0.8), 0 0 30px rgba(250, 204, 21, 0.4); } }
        @keyframes spin-wheel { 0% { transform: rotate(0deg); } 100% { transform: rotate(1800deg); } }
        @keyframes confetti-fall { 0% { transform: translateY(-100%) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        @keyframes flame-flicker { 0%, 100% { transform: scaleY(1) scaleX(1); } 25% { transform: scaleY(1.1) scaleX(0.95); } 50% { transform: scaleY(0.95) scaleX(1.05); } 75% { transform: scaleY(1.05) scaleX(0.98); } }
        @keyframes stagger-in { 0% { transform: translateY(20px); opacity: 0; } 100% { transform: translateY(0); opacity: 1; } }
        @keyframes shimmer { 0% { background-position: -200% 0; } 100% { background-position: 200% 0; } }
        .animate-bounce-in { animation: bounce-in 0.5s ease-out forwards; }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-pulse-glow { animation: pulse-glow 2s ease-in-out infinite; }
        .animate-stagger { animation: stagger-in 0.4s ease-out forwards; }
        .glow-common { box-shadow: 0 0 10px rgba(148, 163, 184, 0.5); }
        .glow-rare { box-shadow: 0 0 15px rgba(59, 130, 246, 0.6); }
        .glow-epic { box-shadow: 0 0 20px rgba(168, 85, 247, 0.7); }
        .glow-legendary { box-shadow: 0 0 25px rgba(250, 204, 21, 0.8); animation: pulse-glow 2s ease-in-out infinite; }
        .quest-blaze { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-color: #f59e0b; }
        .quest-flow { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-color: #3b82f6; }
        .quest-terra { background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); border-color: #22c55e; }
        .quest-breeze { background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border-color: #a855f7; }
        .card { background: white; border-radius: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); border-bottom: 4px solid #e2e8f0; }
        .card-elevated { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1); }
        .btn-primary { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; font-weight: 700; padding: 0.75rem 1.5rem; border-radius: 1rem; box-shadow: 0 4px 14px rgba(59, 130, 246, 0.4); transition: all 0.2s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5); }
        .btn-success { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; font-weight: 700; padding: 0.75rem 1.5rem; border-radius: 1rem; box-shadow: 0 4px 14px rgba(34, 197, 94, 0.4); }
        .btn-family { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; font-weight: 700; padding: 0.75rem 1.5rem; border-radius: 1rem; box-shadow: 0 4px 14px rgba(139, 92, 246, 0.4); transition: all 0.2s; }
        .btn-family:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5); }
        .spark-counter { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 700; color: #92400e; }
        .chore-item { transition: all 0.2s; }
        .chore-item.completed { opacity: 0.6; background: #f0fdf4; }
        .chore-checkbox { width: 28px; height: 28px; border: 3px solid #d1d5db; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .chore-checkbox.checked { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); border-color: #16a34a; }
        .challenge-card { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fbbf24 100%); border: 2px solid #f59e0b; position: relative; overflow: hidden; }
        .challenge-card::before { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent); animation: shimmer 3s infinite; }
        .parent-mode-badge { background: linear-gradient(135deg, #7c3aed 0%, #5b21b6 100%); color: white; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 700; }
        .player-pill { transition: all 0.2s; }
        .player-pill.active { transform: scale(1.05); }
        .family-quest-card { position: relative; overflow: hidden; }
        .family-quest-card.quest-done { opacity: 0.7; }
        .family-quest-card.quest-done::after { content: '‚úì'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 4rem; color: rgba(34, 197, 94, 0.3); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useEffect, useContext, createContext, useCallback } = React;

const LEVEL_CONFIG = { xpPerLevel: 100, getLevel: (xp) => Math.floor(xp / 100) + 1, getProgress: (xp) => (xp % 100), getXpToNext: (xp) => 100 - (xp % 100) };
const RARITY_CONFIG = { common: { label: 'Common', color: 'slate', glow: 'glow-common' }, rare: { label: 'Rare', color: 'blue', glow: 'glow-rare' }, epic: { label: 'Epic', color: 'purple', glow: 'glow-epic' }, legendary: { label: 'Legendary', color: 'yellow', glow: 'glow-legendary' } };
const CATEGORY_CONFIG = { blaze: { emoji: 'üî•', label: 'Blaze', color: 'amber' }, flow: { emoji: 'üé®', label: 'Flow', color: 'blue' }, terra: { emoji: 'üåø', label: 'Terra', color: 'green' }, breeze: { emoji: 'üí®', label: 'Breeze', color: 'purple' } };
const DIFFICULTY_CONFIG = { Easy: { sparks: 5, xp: 10, color: 'green', label: '‚≠ê Easy' }, Medium: { sparks: 10, xp: 20, color: 'blue', label: '‚≠ê‚≠ê Medium' }, Hard: { sparks: 20, xp: 40, color: 'purple', label: '‚≠ê‚≠ê‚≠ê Hard' }, Epic: { sparks: 50, xp: 100, color: 'yellow', label: 'üèÜ EPIC' } };
const RECURRENCE_OPTIONS = [{ id: 'daily', label: 'Daily', emoji: 'üìÖ' }, { id: 'weekly', label: 'Weekly', emoji: 'üìÜ' }, { id: 'once', label: 'One-time', emoji: '1Ô∏è‚É£' }];

const CHORE_TEMPLATES = [
    { name: 'Make your bed', sparks: 5, xp: 10, emoji: 'üõèÔ∏è' },
    { name: 'Brush teeth (morning)', sparks: 3, xp: 5, emoji: 'ü™•' },
    { name: 'Brush teeth (night)', sparks: 3, xp: 5, emoji: 'ü™•' },
    { name: 'Clean your room', sparks: 15, xp: 30, emoji: 'üßπ' },
    { name: 'Put away toys', sparks: 8, xp: 15, emoji: 'üß∏' },
    { name: 'Set the table', sparks: 5, xp: 10, emoji: 'üçΩÔ∏è' },
    { name: 'Clear the table', sparks: 5, xp: 10, emoji: 'üçΩÔ∏è' },
    { name: 'Load dishwasher', sparks: 10, xp: 20, emoji: 'ü´ß' },
    { name: 'Feed pet', sparks: 5, xp: 10, emoji: 'üêï' },
    { name: 'Walk the dog', sparks: 15, xp: 30, emoji: 'üêï‚Äçü¶∫' },
    { name: 'Take out trash', sparks: 8, xp: 15, emoji: 'üóëÔ∏è' },
    { name: 'Fold laundry', sparks: 12, xp: 25, emoji: 'üëï' },
    { name: 'Do homework', sparks: 20, xp: 40, emoji: 'üìö' },
    { name: 'Read for 20 minutes', sparks: 10, xp: 20, emoji: 'üìñ' },
    { name: 'Practice instrument', sparks: 15, xp: 30, emoji: 'üéπ' }
];

const DAILY_CHALLENGE_TEMPLATES = [
    { id: 'chore_master', name: 'Chore Master', description: 'Complete ALL your chores today!', type: 'complete_all_chores', bonusSparks: 25, bonusXp: 50, emoji: 'üèÜ' },
    { id: 'quest_warrior', name: 'Quest Warrior', description: 'Complete 3 random quests!', type: 'complete_quests', target: 3, bonusSparks: 20, bonusXp: 40, emoji: '‚öîÔ∏è' },
    { id: 'early_bird', name: 'Early Bird', description: 'Complete a chore before 9 AM!', type: 'early_completion', beforeHour: 9, bonusSparks: 15, bonusXp: 30, emoji: 'üåÖ' },
    { id: 'streak_keeper', name: 'Streak Keeper', description: 'Keep your streak alive!', type: 'maintain_streak', bonusSparks: 10, bonusXp: 20, emoji: 'üî•' }
];

const WORD_BANKS = {
    number_small: ['3', '4', '5', '6', '7', '8'], number_large: ['10', '12', '15', '20'],
    time_short: ['10 seconds', '15 seconds', '20 seconds', '30 seconds'], time_long: ['1 minute', '2 minutes', '3 minutes'],
    exercise_easy: ['jumping jacks', 'hops', 'spins', 'claps', 'toe touches'], exercise_hard: ['push-ups', 'squats', 'burpees', 'lunges'],
    animal: ['dragon', 'unicorn', 'robot', 'dinosaur', 'superhero', 'cat', 'dog', 'bunny', 'owl', 'lion'],
    color: ['red', 'blue', 'green', 'yellow', 'purple', 'orange', 'pink'], object_easy: ['toy', 'book', 'sock', 'shoe', 'cup'],
    location: ['kitchen', 'living room', 'bedroom', 'backyard'], room: ['your room', 'the bathroom', 'the kitchen'],
    creative: ['your dream house', 'an alien planet', 'yourself as a superhero', 'a magical creature'], letter: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H']
};

const QUEST_TEMPLATES = {
    blaze: {
        Easy: [{ text: "Do [number_small] [exercise_easy]!", minAge: 4 }, { text: "Jump up and down [number_small] times!", minAge: 4 }, { text: "Run to the [location] and back!", minAge: 5 }, { text: "Spin around [number_small] times!", minAge: 4 }],
        Medium: [{ text: "Do [number_large] [exercise_easy]!", minAge: 6 }, { text: "Hold a plank for [time_short]!", minAge: 7 }, { text: "Create a [number_small]-move dance!", minAge: 6 }],
        Hard: [{ text: "Complete [number_large] [exercise_hard]!", minAge: 9 }, { text: "Do a fitness circuit: [number_small] jumps, [number_small] squats, [number_small] spins!", minAge: 8 }],
        Epic: [{ text: "EPIC: Complete 50 total exercises!", minAge: 10 }]
    },
    flow: {
        Easy: [{ text: "Draw a [animal]!", minAge: 4 }, { text: "Draw [creative]!", minAge: 4 }, { text: "Build something with [number_small] toys!", minAge: 4 }],
        Medium: [{ text: "Draw a [animal] doing [exercise_easy]!", minAge: 5 }, { text: "Write a short story about a [animal]!", minAge: 7 }, { text: "Make up a song!", minAge: 5 }],
        Hard: [{ text: "Create a comic strip with [number_small] panels!", minAge: 8 }, { text: "Write a poem with [number_small] lines!", minAge: 9 }],
        Epic: [{ text: "EPIC: Create a complete illustrated story!", minAge: 9 }]
    },
    terra: {
        Easy: [{ text: "Find something [color]!", minAge: 4 }, { text: "Put away [number_small] toys!", minAge: 4 }, { text: "Water a plant!", minAge: 4 }],
        Medium: [{ text: "Clean up the [location]!", minAge: 5 }, { text: "Find [number_small] things that start with [letter]!", minAge: 6 }, { text: "Make your bed perfectly!", minAge: 6 }],
        Hard: [{ text: "Deep clean [room]!", minAge: 8 }, { text: "Organize a drawer or closet!", minAge: 8 }],
        Epic: [{ text: "EPIC: Clean and organize an entire room!", minAge: 10 }]
    },
    breeze: {
        Easy: [{ text: "Give someone a high five!", minAge: 4 }, { text: "Take [number_small] deep breaths!", minAge: 4 }, { text: "Say something nice to someone!", minAge: 4 }],
        Medium: [{ text: "Read for [time_long]!", minAge: 6 }, { text: "Help someone with something!", minAge: 5 }, { text: "Do a random act of kindness!", minAge: 6 }],
        Hard: [{ text: "Read a chapter of a book!", minAge: 8 }, { text: "Teach someone something you know!", minAge: 8 }],
        Epic: [{ text: "EPIC: Complete a 100+ piece puzzle!", minAge: 9 }]
    }
};

const SHOP_ITEMS = [
    { id: 'hat_1', name: 'Crown', type: 'avatar_part', slot: 'hat', rarity: 'rare', price: 100, emoji: 'üëë' },
    { id: 'hat_2', name: 'Wizard Hat', type: 'avatar_part', slot: 'hat', rarity: 'epic', price: 200, emoji: 'üßô' },
    { id: 'hat_3', name: 'Party Hat', type: 'avatar_part', slot: 'hat', rarity: 'common', price: 30, emoji: 'üéâ' },
    { id: 'acc_1', name: 'Cool Shades', type: 'avatar_part', slot: 'accessory', rarity: 'common', price: 40, emoji: 'üòé' },
    { id: 'acc_2', name: 'Magic Wand', type: 'avatar_part', slot: 'accessory', rarity: 'epic', price: 180, emoji: '‚ú®' },
    { id: 'acc_3', name: 'Hero Cape', type: 'avatar_part', slot: 'accessory', rarity: 'legendary', price: 500, emoji: 'ü¶∏' },
    { id: 'sticker_1', name: 'Gold Star', type: 'sticker', rarity: 'common', price: 15, emoji: '‚≠ê' },
    { id: 'sticker_2', name: 'Rainbow', type: 'sticker', rarity: 'rare', price: 50, emoji: 'üåà' },
    { id: 'sticker_3', name: 'Dragon', type: 'sticker', rarity: 'epic', price: 150, emoji: 'üêâ' },
    { id: 'sticker_4', name: 'Unicorn', type: 'sticker', rarity: 'legendary', price: 300, emoji: 'ü¶Ñ' }
];

const DEFAULT_AVATAR = { skinTone: '#FFD5B8', hairStyle: 'spiky', hairColor: '#4A3728', eyeStyle: 'happy', eyeColor: '#4A90D9', outfitColor: '#3B82F6', hat: null, accessory: null };
const SKIN_TONES = ['#FFDBAC', '#F5CBA7', '#FFD5B8', '#E8BEAC', '#D4A574', '#C68642', '#8D5524', '#6B4423', '#4A3728', '#3B2F2F'];
const HAIR_STYLES = ['spiky', 'wavy', 'curly', 'short', 'long', 'ponytail', 'mohawk', 'bald'];
const HAIR_COLORS = ['#4A3728', '#8B4513', '#2C1810', '#FFD700', '#FF6B35', '#9B59B6', '#3498DB', '#E74C3C'];
const OUTFIT_COLORS = ['#3B82F6', '#EF4444', '#22C55E', '#F59E0B', '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16'];

function calculateAge(dob) { if (!dob) return 8; const birth = new Date(dob); const today = new Date(); let age = today.getFullYear() - birth.getFullYear(); if (today.getMonth() < birth.getMonth() || (today.getMonth() === birth.getMonth() && today.getDate() < birth.getDate())) age--; return Math.max(4, Math.min(13, age)); }
function getTodayString() { return new Date().toDateString(); }
function fillTemplate(template) { return template.replace(/\[(\w+)\]/g, (m, key) => { const bank = WORD_BANKS[key]; return bank ? bank[Math.floor(Math.random() * bank.length)] : m; }); }
function weightedRandomChoice(options, weights) { const total = options.reduce((s, o) => s + (weights[o] || 0), 0); let r = Math.random() * total; for (const o of options) { r -= weights[o] || 0; if (r <= 0) return o; } return options[0]; }

function generateQuest(playerAge = 8) {
    const age = Math.max(4, Math.min(13, playerAge || 8));
    let diffs = ['Easy', 'Medium']; if (age >= 8) diffs.push('Hard'); if (age >= 10) diffs.push('Epic');
    const weights = { Easy: age < 7 ? 60 : 35, Medium: age < 7 ? 35 : 45, Hard: 15, Epic: 5 };
    const cats = ['blaze', 'flow', 'terra', 'breeze'];
    const cat = cats[Math.floor(Math.random() * cats.length)];
    const diff = weightedRandomChoice(diffs, weights);
    const templates = (QUEST_TEMPLATES[cat][diff] || QUEST_TEMPLATES[cat]['Easy']).filter(t => (t.minAge || 4) <= age);
    const tmpl = templates[Math.floor(Math.random() * templates.length)] || { text: "Do something fun!", minAge: 4 };
    const rewards = DIFFICULTY_CONFIG[diff] || DIFFICULTY_CONFIG['Easy'];
    return { id: 'quest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9), text: fillTemplate(tmpl.text), category: cat, difficulty: diff, rewards: { sparks: rewards.sparks, xp: rewards.xp } };
}

function generateDailyChallenge(player) {
    const today = getTodayString(); const seed = today + (player?.id || '');
    let hash = 0; for (let i = 0; i < seed.length; i++) { hash = ((hash << 5) - hash) + seed.charCodeAt(i); hash = hash & hash; }
    const tmpl = DAILY_CHALLENGE_TEMPLATES[Math.abs(hash) % DAILY_CHALLENGE_TEMPLATES.length];
    return { ...tmpl, date: today, completed: false, progress: 0 };
}

const GameContext = createContext();
function useGame() { const ctx = useContext(GameContext); if (!ctx) throw new Error('useGame must be within GameProvider'); return ctx; }

function GameProvider({ children }) {
    const loadState = () => { try { const s = localStorage.getItem('sparkquest_v2'); return s ? JSON.parse(s) : null; } catch (e) { return null; } };
    const saved = loadState();
    const [players, setPlayers] = useState(saved?.players || []);
    const [activePlayerIndex, setActivePlayerIndex] = useState(saved?.activePlayerIndex || 0);
    const [parentPin, setParentPin] = useState(saved?.parentPin || null);
    const [isParentMode, setIsParentMode] = useState(false);
    const [realRewards, setRealRewards] = useState(saved?.realRewards || []);
    const [currentView, setCurrentView] = useState('home');
    const [currentQuest, setCurrentQuest] = useState(null);
    const [isSpinning, setIsSpinning] = useState(false);
    const [showCompletion, setShowCompletion] = useState(false);
    const [notification, setNotification] = useState(null);
    const [familyQuests, setFamilyQuests] = useState({});
    const [isFamilySpinning, setIsFamilySpinning] = useState(false);
    const [familyMode, setFamilyMode] = useState(false);
    
    const activePlayer = players[activePlayerIndex] || null;
    
    useEffect(() => { localStorage.setItem('sparkquest_v2', JSON.stringify({ players, activePlayerIndex, parentPin, realRewards })); }, [players, activePlayerIndex, parentPin, realRewards]);
    
    const showNotif = useCallback((msg, type = 'success') => { setNotification({ message: msg, type }); setTimeout(() => setNotification(null), 3000); }, []);
    
    const createPlayer = useCallback((data) => {
        const p = { id: 'p_' + Date.now(), username: data.username || 'Hero', dob: data.dob, sparks: 0, xp: 0, level: 1, streak: 0, lastPlayedDate: null, inventory: [], completedQuests: [], chores: [], choreHistory: [], dailyChallenge: null, questsCompletedToday: 0, lastQuestDate: null, avatar: { ...DEFAULT_AVATAR, ...data.avatar } };
        setPlayers(prev => [...prev, p]); setActivePlayerIndex(players.length); return p;
    }, [players.length]);
    
    const updatePlayer = useCallback((id, updates) => { setPlayers(prev => prev.map(p => p.id === id ? { ...p, ...updates } : p)); }, []);
    
    const addChore = useCallback((playerId, data) => {
        const chore = { id: 'c_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5), name: data.name, sparks: data.sparks || 5, xp: data.xp || 10, emoji: data.emoji || '‚úÖ', recurrence: data.recurrence || 'daily', lastCompleted: null, completedDates: [] };
        setPlayers(prev => prev.map(p => p.id === playerId ? { ...p, chores: [...(p.chores || []), chore] } : p));
        showNotif('Added "' + chore.name + '"!'); return chore;
    }, [showNotif]);
    
    const removeChore = useCallback((playerId, choreId) => {
        setPlayers(prev => prev.map(p => p.id === playerId ? { ...p, chores: (p.chores || []).filter(c => c.id !== choreId) } : p));
        showNotif('Chore removed');
    }, [showNotif]);
    
    const completeChore = useCallback((choreId, playerId = null) => {
        const targetPlayer = playerId ? players.find(p => p.id === playerId) : activePlayer;
        if (!targetPlayer) return null;
        const chore = (targetPlayer.chores || []).find(c => c.id === choreId);
        if (!chore) return null;
        const today = getTodayString();
        if (chore.recurrence === 'daily' && chore.lastCompleted === today) { showNotif('Already done today!', 'error'); return null; }
        
        const lastPlayed = targetPlayer.lastPlayedDate;
        const yesterday = new Date(Date.now() - 86400000).toDateString();
        let streak = targetPlayer.streak;
        if (lastPlayed === yesterday) streak += 1; else if (lastPlayed !== today) streak = 1;
        const bonus = Math.min(streak * 0.1, 0.5);
        const sparksEarned = Math.round(chore.sparks * (1 + bonus));
        const xpEarned = Math.round(chore.xp * (1 + bonus));
        const newXp = targetPlayer.xp + xpEarned;
        
        let updatedChores = (targetPlayer.chores || []).map(c => c.id === choreId ? { ...c, lastCompleted: today, completedDates: [...(c.completedDates || []), today] } : c);
        if (chore.recurrence === 'once') updatedChores = updatedChores.filter(c => c.id !== choreId);
        
        updatePlayer(targetPlayer.id, { sparks: targetPlayer.sparks + sparksEarned, xp: newXp, level: LEVEL_CONFIG.getLevel(newXp), streak, lastPlayedDate: today, chores: updatedChores, choreHistory: [{ choreId, choreName: chore.name, timestamp: Date.now(), sparks: sparksEarned, xp: xpEarned }, ...(targetPlayer.choreHistory || []).slice(0, 99)] });
        return { sparksEarned, xpEarned, streakBonus: bonus > 0 };
    }, [activePlayer, players, updatePlayer, showNotif]);
    
    const getTodayChores = useCallback((playerId = null) => {
        const targetPlayer = playerId ? players.find(p => p.id === playerId) : activePlayer;
        if (!targetPlayer) return [];
        const today = getTodayString();
        return (targetPlayer.chores || []).map(c => ({ ...c, isCompleted: c.recurrence === 'daily' ? c.lastCompleted === today : !!c.lastCompleted }));
    }, [activePlayer, players]);
    
    const getDailyChallenge = useCallback(() => {
        if (!activePlayer) return null;
        const today = getTodayString();
        if (activePlayer.dailyChallenge?.date === today) return activePlayer.dailyChallenge;
        const challenge = generateDailyChallenge(activePlayer);
        updatePlayer(activePlayer.id, { dailyChallenge: challenge });
        return challenge;
    }, [activePlayer, updatePlayer]);
    
    const spinQuest = useCallback(() => {
        if (!activePlayer || isSpinning) return;
        setFamilyMode(false);
        setIsSpinning(true);
        setTimeout(() => { setCurrentQuest(generateQuest(calculateAge(activePlayer.dob))); setIsSpinning(false); }, 1500);
    }, [activePlayer, isSpinning]);
    
    const spinAllQuests = useCallback(() => {
        if (players.length === 0 || isFamilySpinning) return;
        setFamilyMode(true);
        setIsFamilySpinning(true);
        setCurrentQuest(null);
        
        setTimeout(() => {
            const newFamilyQuests = {};
            players.forEach(player => {
                const playerAge = calculateAge(player.dob);
                const quest = generateQuest(playerAge);
                newFamilyQuests[player.id] = { quest, completed: false, rewards: null, playerAge };
            });
            setFamilyQuests(newFamilyQuests);
            setIsFamilySpinning(false);
        }, 1500);
    }, [players, isFamilySpinning]);
    
    const completeQuest = useCallback((quest, playerId = null) => {
        const targetPlayer = playerId ? players.find(p => p.id === playerId) : activePlayer;
        if (!targetPlayer || !quest) return null;
        
        const today = getTodayString();
        const lastPlayed = targetPlayer.lastPlayedDate;
        const yesterday = new Date(Date.now() - 86400000).toDateString();
        let streak = targetPlayer.streak;
        if (lastPlayed === yesterday) streak += 1; else if (lastPlayed !== today) streak = 1;
        const bonus = Math.min(streak * 0.1, 0.5);
        const sparksEarned = Math.round(quest.rewards.sparks * (1 + bonus));
        const xpEarned = Math.round(quest.rewards.xp * (1 + bonus));
        const newXp = targetPlayer.xp + xpEarned;
        const questsToday = targetPlayer.lastQuestDate === today ? (targetPlayer.questsCompletedToday || 0) + 1 : 1;
        
        updatePlayer(targetPlayer.id, { sparks: targetPlayer.sparks + sparksEarned, xp: newXp, level: LEVEL_CONFIG.getLevel(newXp), streak, lastPlayedDate: today, lastQuestDate: today, questsCompletedToday: questsToday, completedQuests: [{ questId: quest.id, category: quest.category, timestamp: Date.now() }, ...targetPlayer.completedQuests.slice(0, 99)] });
        
        const rewards = { sparksEarned, xpEarned, streakBonus: bonus > 0 };
        
        if (familyMode && playerId) {
            setFamilyQuests(prev => ({ ...prev, [playerId]: { ...prev[playerId], completed: true, rewards } }));
        } else {
            setShowCompletion(true);
        }
        
        return rewards;
    }, [activePlayer, players, updatePlayer, familyMode]);
    
    const clearFamilyQuests = useCallback(() => { setFamilyQuests({}); setFamilyMode(false); }, []);
    
    const buyItem = useCallback((itemId) => {
        if (!activePlayer) return { success: false, message: 'No player' };
        const item = SHOP_ITEMS.find(i => i.id === itemId);
        if (!item) return { success: false, message: 'Not found' };
        if (activePlayer.sparks < item.price) return { success: false, message: 'Not enough Sparks!' };
        if (activePlayer.inventory.includes(itemId)) return { success: false, message: 'Already owned!' };
        updatePlayer(activePlayer.id, { sparks: activePlayer.sparks - item.price, inventory: [...activePlayer.inventory, itemId] });
        return { success: true, message: 'Got ' + item.name + '!' };
    }, [activePlayer, updatePlayer]);
    
    const equipItem = useCallback((itemId) => {
        if (!activePlayer) return;
        const item = SHOP_ITEMS.find(i => i.id === itemId);
        if (!item || item.type !== 'avatar_part') return;
        updatePlayer(activePlayer.id, { avatar: { ...activePlayer.avatar, [item.slot]: activePlayer.avatar[item.slot] === itemId ? null : itemId } });
    }, [activePlayer, updatePlayer]);
    
    const addRealReward = useCallback((data) => {
        const r = { id: 'r_' + Date.now(), name: data.name, cost: data.cost || 100, emoji: data.emoji || 'üéÅ', description: data.description || '' };
        setRealRewards(prev => [...prev, r]); showNotif('Added "' + r.name + '"!'); return r;
    }, [showNotif]);
    
    const removeRealReward = useCallback((id) => { setRealRewards(prev => prev.filter(r => r.id !== id)); showNotif('Removed'); }, [showNotif]);
    
    const redeemReward = useCallback((id) => {
        if (!activePlayer) return { success: false };
        const r = realRewards.find(x => x.id === id);
        if (!r) return { success: false, message: 'Not found' };
        if (activePlayer.sparks < r.cost) return { success: false, message: 'Not enough Sparks!' };
        updatePlayer(activePlayer.id, { sparks: activePlayer.sparks - r.cost });
        showNotif('üéâ Redeemed "' + r.name + '"!');
        return { success: true, reward: r };
    }, [activePlayer, realRewards, updatePlayer, showNotif]);
    
    const setupParentPin = useCallback((pin) => { setParentPin(pin); showNotif('PIN set!'); }, [showNotif]);
    const verifyParentPin = useCallback((pin) => { if (pin === parentPin) { setIsParentMode(true); return true; } return false; }, [parentPin]);
    const exitParentMode = useCallback(() => { setIsParentMode(false); setCurrentView('home'); }, []);
    
    return React.createElement(GameContext.Provider, { value: { 
        players, activePlayer, activePlayerIndex, currentView, currentQuest, isSpinning, showCompletion, isParentMode, parentPin, realRewards, notification,
        familyQuests, isFamilySpinning, familyMode,
        setActivePlayerIndex, setCurrentView, setCurrentQuest, setShowCompletion, 
        createPlayer, updatePlayer, showNotif, spinQuest, spinAllQuests, completeQuest, clearFamilyQuests,
        buyItem, equipItem, addChore, removeChore, completeChore, getTodayChores, getDailyChallenge, 
        addRealReward, removeRealReward, redeemReward, setupParentPin, verifyParentPin, exitParentMode 
    }}, children);
}

function BlockyAvatar({ config, size = 'md' }) {
    const sizes = { xs: 48, sm: 64, md: 96, lg: 128 };
    const w = sizes[size] || 96;
    const c = { ...DEFAULT_AVATAR, ...config };
    const hairPaths = { spiky: "M30,35 L35,15 L45,30 L55,10 L65,30 L75,15 L80,35", wavy: "M25,40 Q35,20 50,35 Q65,20 80,40", curly: "M25,40 Q30,25 40,35 Q45,20 55,35 Q60,20 70,35 Q75,25 85,40", short: "M30,40 L30,30 L80,30 L80,40", long: "M25,35 L25,80 L35,80 L35,45 L75,45 L75,80 L85,80 L85,35", ponytail: "M30,35 L30,30 L80,30 L80,35 M75,30 L85,50 L75,70", mohawk: "M48,40 L48,5 L62,5 L62,40", bald: "" };
    const hatItem = c.hat ? SHOP_ITEMS.find(i=>i.id===c.hat) : null;
    const accItem = c.accessory ? SHOP_ITEMS.find(i=>i.id===c.accessory) : null;
    return (
        <svg width={w} height={w} viewBox="0 0 110 130" style={{display:'block'}}>
            <circle cx="55" cy="65" r="50" fill="#E0F2FE"/>
            <rect x="35" y="85" width="40" height="35" rx="5" fill={c.outfitColor}/>
            <rect x="30" y="30" width="50" height="55" rx="10" fill={c.skinTone}/>
            {c.hairStyle !== 'bald' && <path d={hairPaths[c.hairStyle] || hairPaths.spiky} fill={c.hairColor}/>}
            <ellipse cx="42" cy="55" rx="5" ry="6" fill="white"/><ellipse cx="68" cy="55" rx="5" ry="6" fill="white"/>
            <circle cx="43" cy="56" r="3" fill={c.eyeColor}/><circle cx="69" cy="56" r="3" fill={c.eyeColor}/>
            <circle cx="44" cy="55" r="1" fill="white"/><circle cx="70" cy="55" r="1" fill="white"/>
            <path d="M45,70 Q55,78 65,70" stroke="#333" strokeWidth="2" fill="none" strokeLinecap="round"/>
            {hatItem && <text x="55" y="25" textAnchor="middle" fontSize="24">{hatItem.emoji}</text>}
            {accItem && <text x="90" y="60" textAnchor="middle" fontSize="20">{accItem.emoji}</text>}
        </svg>
    );
}

function SparkCounter({ amount }) { return <div className="spark-counter flex items-center gap-2"><span className="text-xl">‚ö°</span><span className="text-lg">{amount}</span></div>; }

function LevelProgress({ xp, level }) {
    const progress = LEVEL_CONFIG.getProgress(xp), toNext = LEVEL_CONFIG.getXpToNext(xp);
    return (
        <div className="flex items-center gap-3">
            <div className="bg-purple-100 px-3 py-1 rounded-full"><span className="text-purple-700 font-bold text-sm">Lvl {level}</span></div>
            <div className="flex-1">
                <div className="h-2 bg-slate-200 rounded-full overflow-hidden"><div className="h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all" style={{width: progress + '%'}}/></div>
                <p className="text-xs text-slate-400 mt-1">{toNext} XP to next</p>
            </div>
        </div>
    );
}

function StreakFlame({ streak }) {
    if (streak <= 0) return null;
    return <div className="flex items-center gap-1 bg-orange-100 px-3 py-1 rounded-full"><span className="text-lg" style={{animation:'flame-flicker 0.5s ease-in-out infinite'}}>üî•</span><span className="text-orange-700 font-bold text-sm">{streak} day streak!</span></div>;
}

function PlayerSelector() {
    const { players, setActivePlayerIndex, activePlayerIndex } = useGame();
    if (players.length <= 1) return null;
    return (
        <div className="flex gap-2 overflow-x-auto scrollbar-hide pb-2">
            {players.map((p, i) => {
                const isActive = i === activePlayerIndex;
                const age = calculateAge(p.dob);
                return (
                    <button key={p.id} onClick={() => setActivePlayerIndex(i)} className={'player-pill flex items-center gap-2 px-3 py-2 rounded-2xl font-bold text-sm whitespace-nowrap border-2 transition-all ' + (isActive ? 'bg-sky-500 text-white border-sky-600 shadow-lg active' : 'bg-white text-slate-600 border-slate-200 shadow hover:border-sky-300')}>
                        <BlockyAvatar config={p.avatar} size="xs"/>
                        <div className="text-left">
                            <div className={isActive ? 'text-white' : 'text-slate-800'}>{p.username}</div>
                            <div className={'text-xs ' + (isActive ? 'text-sky-100' : 'text-slate-400')}>Age {age}</div>
                        </div>
                    </button>
                );
            })}
        </div>
    );
}

function FamilyQuestCard({ player, questData, onComplete, index, totalPlayers }) {
    const { quest, completed, rewards } = questData;
    const cat = CATEGORY_CONFIG[quest.category];
    const diff = DIFFICULTY_CONFIG[quest.difficulty];
    
    return (
        <div className={'family-quest-card card p-3 quest-' + quest.category + ' border-t-4 animate-bounce-in flex flex-col h-full ' + (completed ? 'quest-done' : '')} style={{ animationDelay: (index * 0.15) + 's' }}>
            {/* Player Header */}
            <div className="flex items-center gap-2 mb-2 pb-2 border-b border-slate-200/50">
                <div className="bg-white/80 rounded-lg p-1">
                    <BlockyAvatar config={player.avatar} size="xs"/>
                </div>
                <div className="flex-1 min-w-0">
                    <h4 className="font-bold text-slate-800 text-sm truncate">{player.username}</h4>
                    <span className="text-xs text-slate-500">Lvl {player.level}</span>
                </div>
            </div>
            
            {/* Quest Category & Difficulty */}
            <div className="flex items-center gap-1 mb-2">
                <span className="text-lg">{cat.emoji}</span>
                <span className={'text-xs font-bold uppercase text-' + cat.color + '-600'}>{cat.label}</span>
                <span className={'ml-auto text-xs font-bold px-2 py-0.5 rounded-full bg-' + diff.color + '-100 text-' + diff.color + '-700'}>{diff.label}</span>
            </div>
            
            {/* Quest Text - grows to fill space */}
            <div className="flex-1 mb-3">
                <h3 className="text-base font-bold text-slate-800 leading-snug">{quest.text}</h3>
            </div>
            
            {/* Rewards */}
            <div className="flex items-center gap-2 mb-3 text-xs">
                <span className="font-bold text-yellow-600">‚ö° {quest.rewards.sparks}</span>
                <span className="font-bold text-purple-600">‚ú® {quest.rewards.xp} XP</span>
            </div>
            
            {/* Action Button */}
            <div className="mt-auto">
                {completed ? (
                    <div className="flex items-center justify-center gap-2 bg-green-100 px-3 py-2 rounded-xl w-full">
                        <span className="text-green-600 text-lg">‚úì</span>
                        <span className="text-green-700 font-bold text-sm">+{rewards.sparksEarned} ‚ö°</span>
                    </div>
                ) : (
                    <button onClick={() => onComplete(quest, player.id)} className="btn-success text-sm px-4 py-2 w-full">Done! ‚úì</button>
                )}
            </div>
        </div>
    );
}

function FamilyQuestView() {
    const { players, familyQuests, completeQuest, clearFamilyQuests, spinAllQuests, isFamilySpinning } = useGame();
    const allCompleted = Object.values(familyQuests).every(q => q.completed);
    const completedCount = Object.values(familyQuests).filter(q => q.completed).length;
    const totalQuests = Object.keys(familyQuests).length;
    const playerCount = players.filter(p => familyQuests[p.id]).length;
    
    // Determine grid columns based on player count
    const getGridClass = () => {
        if (playerCount === 1) return 'grid-cols-1 max-w-sm mx-auto';
        if (playerCount === 2) return 'grid-cols-2';
        if (playerCount === 3) return 'grid-cols-3';
        return 'grid-cols-2 sm:grid-cols-4'; // 4+ players
    };
    
    return (
        <div className="space-y-4">
            {/* Progress Header */}
            <div className="card p-3">
                <div className="flex items-center justify-between mb-2">
                    <span className="font-bold text-slate-700">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Family Quest!</span>
                    <span className="font-bold text-sky-600">{completedCount}/{totalQuests} done</span>
                </div>
                <div className="h-3 bg-slate-100 rounded-full overflow-hidden">
                    <div className="h-full bg-gradient-to-r from-purple-400 via-pink-500 to-red-500 transition-all duration-500" style={{width: (totalQuests > 0 ? (completedCount/totalQuests*100) : 0) + '%'}}/>
                </div>
                {allCompleted && (
                    <div className="text-center mt-3 animate-bounce-in">
                        <span className="text-3xl">üéâ</span>
                        <span className="text-green-600 font-bold ml-2">Everyone finished! Amazing teamwork!</span>
                    </div>
                )}
            </div>
            
            {/* Side-by-Side Quest Cards Grid */}
            <div className={'grid gap-3 ' + getGridClass()}>
                {players.map((player, index) => {
                    const questData = familyQuests[player.id];
                    if (!questData) return null;
                    return (
                        <FamilyQuestCard 
                            key={player.id} 
                            player={player} 
                            questData={questData} 
                            onComplete={completeQuest} 
                            index={index}
                            totalPlayers={playerCount}
                        />
                    );
                })}
            </div>
            
            {/* Action Buttons */}
            <div className="flex gap-2">
                <button onClick={clearFamilyQuests} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-600">‚Üê Back</button>
                {allCompleted && <button onClick={spinAllQuests} disabled={isFamilySpinning} className="flex-1 btn-family">Spin Again! üé≤</button>}
            </div>
        </div>
    );
}

function QuestCard({ quest, onComplete }) {
    const cat = CATEGORY_CONFIG[quest.category], diff = DIFFICULTY_CONFIG[quest.difficulty];
    return (
        <div className={'card card-elevated p-6 quest-' + quest.category + ' border-l-4 animate-bounce-in'}>
            <div className="flex items-center gap-2 mb-3">
                <span className="text-2xl">{cat.emoji}</span>
                <span className={'text-xs font-bold uppercase text-' + cat.color + '-600'}>{cat.label}</span>
                <span className={'ml-auto text-xs font-bold px-2 py-1 rounded-full bg-' + diff.color + '-100 text-' + diff.color + '-700'}>{diff.label}</span>
            </div>
            <h3 className="text-xl font-bold text-slate-800 mb-4">{quest.text}</h3>
            <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                    <span className="text-sm font-bold text-yellow-600">‚ö° {quest.rewards.sparks}</span>
                    <span className="text-sm font-bold text-purple-600">‚ú® {quest.rewards.xp} XP</span>
                </div>
                <button onClick={() => onComplete(quest)} className="btn-primary">Complete! ‚úì</button>
            </div>
        </div>
    );
}

function CompletionModal({ rewards, onClose }) {
    const confetti = Array.from({length:50}, (_,i) => ({ id:i, left:Math.random()*100, delay:Math.random()*0.5, color:['#FFD700','#FF6B6B','#4ECDC4','#45B7D1','#96CEB4'][Math.floor(Math.random()*5)] }));
    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            {confetti.map(p => <div key={p.id} className="absolute w-3 h-3 rounded-sm" style={{left: p.left + '%', top:'-20px', backgroundColor:p.color, animation:'confetti-fall 2s ease-in forwards', animationDelay: p.delay + 's'}}/>)}
            <div className="card card-elevated p-8 text-center max-w-sm w-full animate-bounce-in">
                <div className="text-6xl mb-4">üéâ</div>
                <h2 className="text-2xl font-bold text-slate-800 mb-2">Complete!</h2>
                <div className="bg-gradient-to-r from-yellow-100 to-purple-100 rounded-2xl p-4 mb-4">
                    <div className="flex justify-center gap-6">
                        <div><div className="text-3xl font-bold text-yellow-600">+{rewards.sparksEarned}</div><div className="text-sm text-slate-500">Sparks</div></div>
                        <div><div className="text-3xl font-bold text-purple-600">+{rewards.xpEarned}</div><div className="text-sm text-slate-500">XP</div></div>
                    </div>
                </div>
                {rewards.streakBonus && <div className="bg-orange-100 rounded-xl p-2 mb-4"><span className="text-orange-700 font-bold text-sm">üî• Streak Bonus!</span></div>}
                <button onClick={onClose} className="btn-primary w-full">Awesome! üöÄ</button>
            </div>
        </div>
    );
}

function Notification() {
    const { notification } = useGame();
    if (!notification) return null;
    return <div className={'fixed bottom-24 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full font-bold shadow-lg animate-bounce-in z-50 ' + (notification.type === 'error' ? 'bg-red-500' : 'bg-green-500') + ' text-white'}>{notification.message}</div>;
}

function ParentPinModal({ onSuccess, onCancel }) {
    const { parentPin, setupParentPin, verifyParentPin } = useGame();
    const [pin, setPin] = useState('');
    const [confirmPin, setConfirmPin] = useState('');
    const [error, setError] = useState('');
    const [step, setStep] = useState(parentPin ? 'verify' : 'create');
    
    const handleSubmit = () => {
        setError('');
        if (step === 'create') {
            if (pin.length < 4) { setError('PIN must be at least 4 digits'); return; }
            if (pin !== confirmPin) { setError('PINs do not match'); return; }
            setupParentPin(pin);
            onSuccess();
        } else {
            if (verifyParentPin(pin)) {
                onSuccess();
            } else {
                setError('Incorrect PIN');
                setPin('');
            }
        }
    };
    
    return (
        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div className="card p-6 w-full max-w-sm animate-bounce-in">
                <h2 className="text-xl font-bold text-slate-800 mb-2 text-center">
                    {step === 'create' ? 'üîê Create Parent PIN' : 'üîê Enter Parent PIN'}
                </h2>
                <p className="text-sm text-slate-500 text-center mb-4">
                    {step === 'create' ? 'Set a PIN to protect parent settings' : 'Enter your PIN to access parent mode'}
                </p>
                
                <div className="space-y-3">
                    <div>
                        <label className="text-sm font-bold text-slate-600 mb-1 block">
                            {step === 'create' ? 'Create PIN' : 'PIN'}
                        </label>
                        <input 
                            type="password" 
                            inputMode="numeric"
                            pattern="[0-9]*"
                            value={pin} 
                            onChange={(e) => setPin(e.target.value.replace(/\D/g, ''))} 
                            placeholder="Enter PIN..." 
                            className="w-full p-3 text-center text-2xl tracking-widest border-2 border-slate-200 rounded-xl focus:border-purple-400 focus:outline-none"
                            maxLength={6}
                            autoFocus
                        />
                    </div>
                    
                    {step === 'create' && (
                        <div>
                            <label className="text-sm font-bold text-slate-600 mb-1 block">Confirm PIN</label>
                            <input 
                                type="password" 
                                inputMode="numeric"
                                pattern="[0-9]*"
                                value={confirmPin} 
                                onChange={(e) => setConfirmPin(e.target.value.replace(/\D/g, ''))} 
                                placeholder="Confirm PIN..." 
                                className="w-full p-3 text-center text-2xl tracking-widest border-2 border-slate-200 rounded-xl focus:border-purple-400 focus:outline-none"
                                maxLength={6}
                            />
                        </div>
                    )}
                    
                    {error && <p className="text-red-500 text-sm text-center font-bold">{error}</p>}
                </div>
                
                <div className="flex gap-2 mt-6">
                    <button onClick={onCancel} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-600">Cancel</button>
                    <button onClick={handleSubmit} className="flex-1 py-3 bg-purple-500 text-white rounded-xl font-bold">
                        {step === 'create' ? 'Set PIN' : 'Enter'}
                    </button>
                </div>
            </div>
        </div>
    );
}

function ChoreList() {
    const { activePlayer, getTodayChores, completeChore, showNotif } = useGame();
    const chores = getTodayChores();
    const completedCount = chores.filter(c => c.isCompleted).length;
    const totalCount = chores.length;
    
    const handleComplete = (choreId) => {
        const result = completeChore(choreId);
        if (result) {
            showNotif(`+${result.sparksEarned} ‚ö° ${result.streakBonus ? '(Streak Bonus!)' : ''}`);
        }
    };
    
    if (chores.length === 0) {
        return (
            <div className="card p-8 text-center">
                <div className="text-5xl mb-4">üìã</div>
                <h3 className="text-lg font-bold text-slate-700 mb-2">No Chores Yet!</h3>
                <p className="text-slate-500 text-sm">Ask a parent to add some chores in Parent Mode.</p>
            </div>
        );
    }
    
    return (
        <div className="space-y-4">
            <div className="card p-4">
                <div className="flex items-center justify-between mb-2">
                    <span className="font-bold text-slate-700">üìã Today's Chores</span>
                    <span className="font-bold text-sky-600">{completedCount}/{totalCount}</span>
                </div>
                <div className="h-3 bg-slate-100 rounded-full overflow-hidden">
                    <div 
                        className="h-full bg-gradient-to-r from-green-400 to-emerald-500 transition-all duration-500" 
                        style={{width: (totalCount > 0 ? (completedCount/totalCount*100) : 0) + '%'}}
                    />
                </div>
                {completedCount === totalCount && totalCount > 0 && (
                    <div className="text-center mt-3">
                        <span className="text-2xl">üéâ</span>
                        <span className="text-green-600 font-bold ml-2">All done! Great job!</span>
                    </div>
                )}
            </div>
            
            <div className="space-y-2">
                {chores.map((chore, index) => (
                    <div 
                        key={chore.id} 
                        className={'chore-item card p-4 flex items-center gap-3 animate-stagger ' + (chore.isCompleted ? 'completed' : '')}
                        style={{ animationDelay: (index * 0.05) + 's' }}
                    >
                        <button 
                            onClick={() => !chore.isCompleted && handleComplete(chore.id)}
                            className={'chore-checkbox ' + (chore.isCompleted ? 'checked' : '')}
                            disabled={chore.isCompleted}
                        >
                            {chore.isCompleted && <span className="text-white text-lg">‚úì</span>}
                        </button>
                        
                        <span className="text-2xl">{chore.emoji}</span>
                        
                        <div className="flex-1">
                            <h4 className={'font-bold ' + (chore.isCompleted ? 'text-slate-400 line-through' : 'text-slate-800')}>
                                {chore.name}
                            </h4>
                            <div className="flex gap-2 text-xs">
                                <span className={chore.isCompleted ? 'text-slate-300' : 'text-yellow-600'}>‚ö° {chore.sparks}</span>
                                <span className={chore.isCompleted ? 'text-slate-300' : 'text-purple-600'}>‚ú® {chore.xp} XP</span>
                            </div>
                        </div>
                        
                        {!chore.isCompleted && (
                            <button 
                                onClick={() => handleComplete(chore.id)} 
                                className="btn-success text-sm px-3 py-2"
                            >
                                Done!
                            </button>
                        )}
                    </div>
                ))}
            </div>
        </div>
    );
}

function ParentDashboard() {
    const { players, addChore, removeChore, addRealReward, removeRealReward, realRewards, exitParentMode } = useGame();
    const [selectedPlayer, setSelectedPlayer] = useState(players[0]?.id);
    const [tab, setTab] = useState('chores');
    const [showAddChore, setShowAddChore] = useState(false);
    const [showAddReward, setShowAddReward] = useState(false);
    const [newChore, setNewChore] = useState({ name: '', sparks: 10, xp: 20, emoji: '‚úÖ', recurrence: 'daily' });
    const [newReward, setNewReward] = useState({ name: '', cost: 100, emoji: 'üéÅ', description: '' });
    
    const player = players.find(p => p.id === selectedPlayer);
    const handleAddChore = () => { if (!newChore.name.trim()) return; addChore(selectedPlayer, newChore); setNewChore({ name: '', sparks: 10, xp: 20, emoji: '‚úÖ', recurrence: 'daily' }); setShowAddChore(false); };
    const handleAddReward = () => { if (!newReward.name.trim()) return; addRealReward(newReward); setNewReward({ name: '', cost: 100, emoji: 'üéÅ', description: '' }); setShowAddReward(false); };
    const selectTemplate = (t) => setNewChore({ name: t.name, sparks: t.sparks, xp: t.xp, emoji: t.emoji, recurrence: 'daily' });
    
    return (
        <div className="p-4 pb-8 min-h-screen">
            <div className="flex items-center justify-between mb-4">
                <span className="parent-mode-badge">üë®‚Äçüë©‚Äçüëß Parent Mode</span>
                <button onClick={exitParentMode} className="text-sm font-bold text-purple-600">Exit ‚Üí</button>
            </div>
            
            <div className="flex gap-2 mb-4 overflow-x-auto scrollbar-hide pb-2">
                {players.map(p => {
                    const age = calculateAge(p.dob);
                    return (
                        <button key={p.id} onClick={() => setSelectedPlayer(p.id)} className={'flex items-center gap-2 px-4 py-2 rounded-full font-bold text-sm whitespace-nowrap ' + (selectedPlayer === p.id ? 'bg-purple-500 text-white shadow-lg' : 'bg-white text-slate-500 shadow')}>
                            <BlockyAvatar config={p.avatar} size="xs"/>
                            <div className="text-left">
                                <div>{p.username}</div>
                                <div className={'text-xs ' + (selectedPlayer === p.id ? 'text-purple-200' : 'text-slate-400')}>Age {age}</div>
                            </div>
                        </button>
                    );
                })}
            </div>
            
            {player && (
                <>
                    <div className="card p-4 mb-4 flex items-center gap-3">
                        <BlockyAvatar config={player.avatar} size="sm"/>
                        <div>
                            <h3 className="font-bold text-slate-800">{player.username}</h3>
                            <div className="text-xs text-slate-500 mb-1">Age {calculateAge(player.dob)}</div>
                            <div className="flex gap-2 text-sm"><span className="text-yellow-600">‚ö° {player.sparks}</span><span className="text-purple-600">Lvl {player.level}</span><span className="text-orange-600">üî• {player.streak}</span></div>
                        </div>
                    </div>
                    
                    <div className="flex bg-white rounded-xl p-1 shadow mb-4">
                        <button onClick={() => setTab('chores')} className={'flex-1 py-2 rounded-lg font-bold text-sm ' + (tab === 'chores' ? 'bg-purple-100 text-purple-700' : 'text-slate-400')}>üìã Chores</button>
                        <button onClick={() => setTab('rewards')} className={'flex-1 py-2 rounded-lg font-bold text-sm ' + (tab === 'rewards' ? 'bg-purple-100 text-purple-700' : 'text-slate-400')}>üéÅ Rewards</button>
                        <button onClick={() => setTab('history')} className={'flex-1 py-2 rounded-lg font-bold text-sm ' + (tab === 'history' ? 'bg-purple-100 text-purple-700' : 'text-slate-400')}>üìú History</button>
                    </div>
                    
                    {tab === 'chores' && (
                        <div>
                            <button onClick={() => setShowAddChore(true)} className="w-full btn-success mb-4">+ Add Chore</button>
                            <div className="space-y-2">
                                {(player.chores || []).map(c => (
                                    <div key={c.id} className="card p-3 flex items-center gap-3">
                                        <span className="text-2xl">{c.emoji}</span>
                                        <div className="flex-1"><h4 className="font-bold text-slate-800">{c.name}</h4><div className="flex gap-2 text-xs"><span className="text-yellow-600">‚ö° {c.sparks}</span><span className="text-purple-600">‚ú® {c.xp}</span><span className="text-slate-400 capitalize">‚Ä¢ {c.recurrence}</span></div></div>
                                        <button onClick={() => removeChore(player.id, c.id)} className="text-red-400 hover:text-red-600 p-2">üóëÔ∏è</button>
                                    </div>
                                ))}
                                {(!player.chores || player.chores.length === 0) && <div className="card p-6 text-center text-slate-400">No chores yet</div>}
                            </div>
                        </div>
                    )}
                    
                    {tab === 'rewards' && (
                        <div>
                            <p className="text-sm text-slate-500 mb-3">Real rewards kids can redeem</p>
                            <button onClick={() => setShowAddReward(true)} className="w-full btn-success mb-4">+ Add Reward</button>
                            <div className="space-y-2">
                                {realRewards.map(r => (
                                    <div key={r.id} className="card p-3 flex items-center gap-3">
                                        <span className="text-2xl">{r.emoji}</span>
                                        <div className="flex-1"><h4 className="font-bold text-slate-800">{r.name}</h4><span className="text-sm text-yellow-600">‚ö° {r.cost}</span></div>
                                        <button onClick={() => removeRealReward(r.id)} className="text-red-400 hover:text-red-600 p-2">üóëÔ∏è</button>
                                    </div>
                                ))}
                                {realRewards.length === 0 && <div className="card p-6 text-center text-slate-400">No rewards yet</div>}
                            </div>
                        </div>
                    )}
                    
                    {tab === 'history' && (
                        <div className="space-y-2">
                            {(player.choreHistory || []).slice(0, 20).map((h, i) => (
                                <div key={i} className="card p-3 flex items-center justify-between">
                                    <div><span className="font-bold text-slate-700">{h.choreName}</span><div className="text-xs text-slate-400">{new Date(h.timestamp).toLocaleDateString()}</div></div>
                                    <span className="text-yellow-600 font-bold">+{h.sparks} ‚ö°</span>
                                </div>
                            ))}
                            {(!player.choreHistory || player.choreHistory.length === 0) && <div className="card p-6 text-center text-slate-400">No history</div>}
                        </div>
                    )}
                </>
            )}
            
            {showAddChore && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4 overflow-y-auto">
                    <div className="card p-6 w-full max-w-md my-8 animate-bounce-in">
                        <h2 className="text-xl font-bold text-slate-800 mb-4">Add Chore</h2>
                        <div className="mb-4">
                            <label className="text-sm font-bold text-slate-600 mb-2 block">Quick Add:</label>
                            <div className="flex flex-wrap gap-2 max-h-32 overflow-y-auto">
                                {CHORE_TEMPLATES.map((t, i) => <button key={i} onClick={() => selectTemplate(t)} className="px-3 py-1 bg-slate-100 rounded-full text-sm hover:bg-slate-200 flex items-center gap-1"><span>{t.emoji}</span><span>{t.name}</span></button>)}
                            </div>
                        </div>
                        <div className="space-y-3">
                            <div><label className="text-sm font-bold text-slate-600 mb-1 block">Name</label><input type="text" value={newChore.name} onChange={(e) => setNewChore({...newChore, name: e.target.value})} placeholder="e.g., Make bed" className="w-full p-3 border-2 border-slate-200 rounded-xl focus:border-purple-400 focus:outline-none"/></div>
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-sm font-bold text-slate-600 mb-1 block">‚ö° Sparks</label><input type="number" value={newChore.sparks} onChange={(e) => setNewChore({...newChore, sparks: parseInt(e.target.value)||0})} className="w-full p-3 border-2 border-slate-200 rounded-xl" min="1"/></div>
                                <div><label className="text-sm font-bold text-slate-600 mb-1 block">‚ú® XP</label><input type="number" value={newChore.xp} onChange={(e) => setNewChore({...newChore, xp: parseInt(e.target.value)||0})} className="w-full p-3 border-2 border-slate-200 rounded-xl" min="1"/></div>
                            </div>
                            <div><label className="text-sm font-bold text-slate-600 mb-1 block">Recurrence</label><div className="flex gap-2">{RECURRENCE_OPTIONS.map(o => <button key={o.id} onClick={() => setNewChore({...newChore, recurrence: o.id})} className={'flex-1 py-2 rounded-lg font-bold text-sm ' + (newChore.recurrence === o.id ? 'bg-purple-500 text-white' : 'bg-slate-100 text-slate-600')}>{o.emoji} {o.label}</button>)}</div></div>
                        </div>
                        <div className="flex gap-2 mt-6"><button onClick={() => setShowAddChore(false)} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-600">Cancel</button><button onClick={handleAddChore} className="flex-1 btn-success">Add</button></div>
                    </div>
                </div>
            )}
            
            {showAddReward && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="card p-6 w-full max-w-md animate-bounce-in">
                        <h2 className="text-xl font-bold text-slate-800 mb-4">Add Reward</h2>
                        <div className="space-y-3">
                            <div><label className="text-sm font-bold text-slate-600 mb-1 block">Name</label><input type="text" value={newReward.name} onChange={(e) => setNewReward({...newReward, name: e.target.value})} placeholder="e.g., Extra screen time" className="w-full p-3 border-2 border-slate-200 rounded-xl"/></div>
                            <div><label className="text-sm font-bold text-slate-600 mb-1 block">‚ö° Cost</label><input type="number" value={newReward.cost} onChange={(e) => setNewReward({...newReward, cost: parseInt(e.target.value)||0})} className="w-full p-3 border-2 border-slate-200 rounded-xl" min="1"/></div>
                            <div><label className="text-sm font-bold text-slate-600 mb-1 block">Description</label><input type="text" value={newReward.description} onChange={(e) => setNewReward({...newReward, description: e.target.value})} placeholder="Optional details" className="w-full p-3 border-2 border-slate-200 rounded-xl"/></div>
                        </div>
                        <div className="flex gap-2 mt-6"><button onClick={() => setShowAddReward(false)} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-600">Cancel</button><button onClick={handleAddReward} className="flex-1 btn-success">Add</button></div>
                    </div>
                </div>
            )}
        </div>
    );
}

function PlayerSetupScreen() {
    const { createPlayer, setCurrentView, players } = useGame();
    const [step, setStep] = useState(1);
    const [username, setUsername] = useState('');
    const [dob, setDob] = useState('');
    const [avatar, setAvatar] = useState({ ...DEFAULT_AVATAR });
    const isAddingAnother = players.length > 0;
    
    const handleComplete = () => { createPlayer({ username, dob, avatar }); setCurrentView('home'); };
    const handleCancel = () => { setCurrentView('home'); };
    
    return (
        <div className="min-h-screen p-4 flex flex-col items-center justify-center">
            <div className="card p-6 w-full max-w-md">
                {isAddingAnother && <button onClick={handleCancel} className="text-slate-400 text-sm mb-4 hover:text-slate-600">‚Üê Back to game</button>}
                {step === 1 && (
                    <div className="text-center">
                        <h2 className="text-2xl font-bold text-slate-800 mb-4">{isAddingAnother ? 'üëã Add another player!' : "üëã What's your name?"}</h2>
                        <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} placeholder="Enter name..." className="w-full p-4 text-lg border-2 border-slate-200 rounded-xl focus:border-sky-400 focus:outline-none mb-4" maxLength={20}/>
                        <button onClick={() => setStep(2)} disabled={!username.trim()} className="btn-primary w-full disabled:opacity-50">Next ‚Üí</button>
                    </div>
                )}
                {step === 2 && (
                    <div className="text-center">
                        <h2 className="text-2xl font-bold text-slate-800 mb-2">üéÇ Birthday?</h2>
                        <p className="text-slate-500 text-sm mb-4">Helps pick the right quests!</p>
                        <input type="date" value={dob} onChange={(e) => setDob(e.target.value)} className="w-full p-4 text-lg border-2 border-slate-200 rounded-xl focus:border-sky-400 focus:outline-none mb-4"/>
                        <div className="flex gap-2"><button onClick={() => setStep(1)} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-600">‚Üê Back</button><button onClick={() => setStep(3)} className="flex-1 btn-primary">Next ‚Üí</button></div>
                    </div>
                )}
                {step === 3 && (
                    <div>
                        <h2 className="text-2xl font-bold text-slate-800 mb-4 text-center">üé® Create Avatar!</h2>
                        <div className="flex justify-center mb-4"><div className="bg-sky-50 rounded-2xl p-4"><BlockyAvatar config={avatar} size="lg"/></div></div>
                        <div className="mb-4"><label className="text-sm font-bold text-slate-600 mb-2 block">Skin</label><div className="flex flex-wrap gap-2">{SKIN_TONES.map(t => <button key={t} onClick={() => setAvatar(a => ({...a, skinTone: t}))} className={'w-8 h-8 rounded-full border-2 ' + (avatar.skinTone === t ? 'border-sky-500 ring-2 ring-sky-200' : 'border-slate-200')} style={{backgroundColor:t}}/>)}</div></div>
                        <div className="mb-4"><label className="text-sm font-bold text-slate-600 mb-2 block">Hair Style</label><div className="flex flex-wrap gap-2">{HAIR_STYLES.map(s => <button key={s} onClick={() => setAvatar(a => ({...a, hairStyle: s}))} className={'px-3 py-1 rounded-full text-sm font-medium capitalize ' + (avatar.hairStyle === s ? 'bg-sky-500 text-white' : 'bg-slate-100 text-slate-600')}>{s}</button>)}</div></div>
                        <div className="mb-4"><label className="text-sm font-bold text-slate-600 mb-2 block">Hair Color</label><div className="flex flex-wrap gap-2">{HAIR_COLORS.map(c => <button key={c} onClick={() => setAvatar(a => ({...a, hairColor: c}))} className={'w-8 h-8 rounded-full border-2 ' + (avatar.hairColor === c ? 'border-sky-500 ring-2 ring-sky-200' : 'border-slate-200')} style={{backgroundColor:c}}/>)}</div></div>
                        <div className="mb-4"><label className="text-sm font-bold text-slate-600 mb-2 block">Outfit</label><div className="flex flex-wrap gap-2">{OUTFIT_COLORS.map(c => <button key={c} onClick={() => setAvatar(a => ({...a, outfitColor: c}))} className={'w-8 h-8 rounded-full border-2 ' + (avatar.outfitColor === c ? 'border-sky-500 ring-2 ring-sky-200' : 'border-slate-200')} style={{backgroundColor:c}}/>)}</div></div>
                        <div className="flex gap-2 mt-6"><button onClick={() => setStep(2)} className="flex-1 py-3 bg-slate-100 rounded-xl font-bold text-slate-600">‚Üê Back</button><button onClick={handleComplete} className="flex-1 btn-primary">Let's Go! üöÄ</button></div>
                    </div>
                )}
            </div>
        </div>
    );
}

function HomeScreen() {
    const { players, activePlayer, currentQuest, isSpinning, spinQuest, completeQuest, showCompletion, setShowCompletion, setCurrentQuest, familyQuests, isFamilySpinning, familyMode, spinAllQuests } = useGame();
    const [mode, setMode] = useState('adventure');
    const [lastRewards, setLastRewards] = useState(null);
    const hasMultiplePlayers = players.length > 1;
    const hasFamilyQuests = Object.keys(familyQuests).length > 0;
    
    const handleComplete = (q) => { const r = completeQuest(q); setLastRewards(r); };
    const handleClose = () => { setShowCompletion(false); setCurrentQuest(null); setLastRewards(null); };
    
    return (
        <div className="p-4 pb-24">
            <div className="card p-4 mb-4 flex items-center gap-4">
                <div className="bg-sky-50 rounded-xl p-2"><BlockyAvatar config={activePlayer.avatar} size="sm"/></div>
                <div className="flex-1"><h2 className="text-xl font-bold text-slate-800">{activePlayer.username}</h2><LevelProgress xp={activePlayer.xp} level={activePlayer.level}/></div>
                <SparkCounter amount={activePlayer.sparks}/>
            </div>
            
            {hasMultiplePlayers && (
                <div className="mb-4">
                    <div className="text-xs font-bold text-slate-500 uppercase mb-2">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Switch Player</div>
                    <PlayerSelector/>
                </div>
            )}
            
            {activePlayer.streak > 0 && <div className="flex justify-center mb-4"><StreakFlame streak={activePlayer.streak}/></div>}
            
            <div className="flex bg-white p-1 rounded-xl mb-4 shadow">
                <button onClick={() => setMode('adventure')} className={'flex-1 py-3 rounded-xl font-bold text-sm uppercase ' + (mode === 'adventure' ? 'bg-sky-500 text-white shadow-md' : 'text-slate-400')}>üé≤ Adventure</button>
                <button onClick={() => setMode('chores')} className={'flex-1 py-3 rounded-xl font-bold text-sm uppercase ' + (mode === 'chores' ? 'bg-sky-500 text-white shadow-md' : 'text-slate-400')}>üìã Chores</button>
            </div>
            
            {mode === 'adventure' && (
                <>
                    {hasFamilyQuests && familyMode ? (
                        <FamilyQuestView />
                    ) : (
                        <div className="card p-6 text-center">
                            <h3 className="text-lg font-bold text-slate-700 mb-4">üéØ Random Quest</h3>
                            {!currentQuest && !isSpinning && !isFamilySpinning && (
                                <div>
                                    <div className="text-6xl mb-4 animate-float">üé∞</div>
                                    <p className="text-slate-500 mb-4">Ready for adventure?</p>
                                    <button onClick={spinQuest} className="btn-primary text-lg px-8 py-4 w-full mb-3">Spin for {activePlayer.username}! üé≤</button>
                                    {hasMultiplePlayers && <button onClick={spinAllQuests} className="btn-family text-lg px-8 py-4 w-full">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Spin for Everyone!</button>}
                                </div>
                            )}
                            {(isSpinning || isFamilySpinning) && (
                                <div>
                                    <div className="text-6xl mb-4" style={{animation:'spin-wheel 1.5s ease-out'}}>üé°</div>
                                    <p className="text-slate-500">{isFamilySpinning ? 'Finding quests for everyone...' : 'Finding quest...'}</p>
                                </div>
                            )}
                            {currentQuest && !isSpinning && !familyMode && (
                                <div>
                                    <QuestCard quest={currentQuest} onComplete={handleComplete}/>
                                    <button onClick={() => setCurrentQuest(null)} className="mt-4 text-sm text-slate-400 hover:text-slate-600">Skip ‚Üí</button>
                                </div>
                            )}
                        </div>
                    )}
                </>
            )}
            {mode === 'chores' && <ChoreList/>}
            {showCompletion && lastRewards && <CompletionModal rewards={lastRewards} onClose={handleClose}/>}
        </div>
    );
}

function ShopScreen() {
    const { activePlayer, buyItem, realRewards, redeemReward } = useGame();
    const [cat, setCat] = useState('all');
    const [notif, setNotif] = useState(null);
    const cats = [{id:'all',label:'All',emoji:'üõí'},{id:'avatar_part',label:'Avatar',emoji:'üë§'},{id:'sticker',label:'Stickers',emoji:'‚≠ê'},{id:'real',label:'Rewards',emoji:'üéÅ'}];
    const items = cat === 'all' ? SHOP_ITEMS : cat === 'real' ? [] : SHOP_ITEMS.filter(i => i.type === cat);
    const handleBuy = (item) => { const r = buyItem(item.id); setNotif(r); setTimeout(() => setNotif(null), 2000); };
    const handleRedeem = (reward) => { const r = redeemReward(reward.id); setNotif(r); setTimeout(() => setNotif(null), 3000); };
    
    return (
        <div className="p-4 pb-24">
            <div className="flex items-center justify-between mb-4"><h2 className="text-2xl font-bold text-slate-800">üè™ Shop</h2><SparkCounter amount={activePlayer.sparks}/></div>
            <div className="flex gap-2 mb-4 overflow-x-auto scrollbar-hide pb-2">{cats.map(c => <button key={c.id} onClick={() => setCat(c.id)} className={'flex items-center gap-1 px-4 py-2 rounded-full font-bold text-sm whitespace-nowrap ' + (cat === c.id ? 'bg-sky-500 text-white shadow-lg' : 'bg-white text-slate-500 shadow')}><span>{c.emoji}</span><span>{c.label}</span></button>)}</div>
            
            {cat === 'real' && (
                <div className="space-y-3">
                    {realRewards.length > 0 ? realRewards.map(r => {
                        const can = activePlayer.sparks >= r.cost;
                        return (
                            <div key={r.id} className={'card p-4 ' + (!can ? 'opacity-60' : '')}>
                                <div className="flex items-center gap-4">
                                    <span className="text-4xl">{r.emoji}</span>
                                    <div className="flex-1"><h3 className="font-bold text-slate-800">{r.name}</h3>{r.description && <p className="text-sm text-slate-500">{r.description}</p>}</div>
                                    <button onClick={() => handleRedeem(r)} disabled={!can} className={'px-4 py-2 rounded-lg font-bold ' + (can ? 'bg-green-500 text-white' : 'bg-slate-200 text-slate-400')}>‚ö° {r.cost}</button>
                                </div>
                            </div>
                        );
                    }) : <div className="card p-8 text-center"><div className="text-4xl mb-2">üéÅ</div><p className="text-slate-500">No rewards yet!</p></div>}
                </div>
            )}
            
            {cat !== 'real' && (
                <div className="grid grid-cols-2 gap-3">
                    {items.map(item => {
                        const owned = activePlayer.inventory.includes(item.id);
                        const can = activePlayer.sparks >= item.price;
                        const rarity = RARITY_CONFIG[item.rarity];
                        return (
                            <div key={item.id} className={'card p-4 text-center ' + rarity.glow + ' ' + (!can && !owned ? 'opacity-60' : '')}>
                                <div className="text-4xl mb-2">{item.emoji}</div>
                                <h3 className="font-bold text-slate-800 text-sm">{item.name}</h3>
                                <span className={'text-xs font-bold text-' + rarity.color + '-500 uppercase'}>{rarity.label}</span>
                                {owned ? <div className="mt-2 py-2 bg-green-100 rounded-lg text-green-700 font-bold text-sm">‚úì Owned</div> : <button onClick={() => handleBuy(item)} disabled={!can} className={'mt-2 w-full py-2 rounded-lg font-bold text-sm ' + (can ? 'bg-sky-500 text-white hover:bg-sky-600' : 'bg-slate-200 text-slate-400')}>‚ö° {item.price}</button>}
                            </div>
                        );
                    })}
                </div>
            )}
            {notif && <div className={'fixed bottom-24 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full font-bold shadow-lg animate-bounce-in z-50 ' + (notif.success ? 'bg-green-500' : 'bg-red-500') + ' text-white'}>{notif.message}</div>}
        </div>
    );
}

function ProfileScreen() {
    const { activePlayer, players, setActivePlayerIndex, equipItem, setCurrentView } = useGame();
    const [showInv, setShowInv] = useState(true);
    const [showPin, setShowPin] = useState(false);
    const owned = SHOP_ITEMS.filter(i => activePlayer.inventory.includes(i.id));
    const avatarItems = owned.filter(i => i.type === 'avatar_part');
    
    return (
        <div className="p-4 pb-24">
            {players.length > 1 && (
                <div className="mb-4">
                    <div className="text-xs font-bold text-slate-500 uppercase mb-2">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Switch Player</div>
                    <div className="flex gap-2 overflow-x-auto scrollbar-hide pb-2">
                        {players.map((p, i) => {
                            const age = calculateAge(p.dob);
                            return (
                                <button key={p.id} onClick={() => setActivePlayerIndex(i)} className={'flex items-center gap-2 px-4 py-2 rounded-full font-bold text-sm whitespace-nowrap ' + (i === players.indexOf(activePlayer) ? 'bg-sky-500 text-white shadow-lg' : 'bg-white text-slate-500 shadow')}>
                                    <BlockyAvatar config={p.avatar} size="xs"/>
                                    <div className="text-left">
                                        <div>{p.username}</div>
                                        <div className={'text-xs ' + (i === players.indexOf(activePlayer) ? 'text-sky-100' : 'text-slate-400')}>Age {age}</div>
                                    </div>
                                </button>
                            );
                        })}
                    </div>
                </div>
            )}
            
            <div className="card p-6 mb-4">
                <div className="flex items-center gap-4">
                    <div className="bg-sky-50 rounded-2xl p-3"><BlockyAvatar config={activePlayer.avatar} size="lg"/></div>
                    <div className="flex-1">
                        <h2 className="text-2xl font-bold text-slate-800">{activePlayer.username}</h2>
                        <div className="text-sm text-slate-500 mb-1">Age {calculateAge(activePlayer.dob)}</div>
                        <div className="flex gap-2 mt-2"><span className="bg-purple-100 text-purple-700 px-3 py-1 rounded-full text-sm font-bold">Lvl {activePlayer.level}</span><SparkCounter amount={activePlayer.sparks}/></div>
                        <div className="mt-3"><LevelProgress xp={activePlayer.xp} level={activePlayer.level}/></div>
                    </div>
                </div>
                {activePlayer.streak > 0 && <div className="mt-4 flex justify-center"><StreakFlame streak={activePlayer.streak}/></div>}
            </div>
            
            <div className="grid grid-cols-3 gap-3 mb-4">
                <div className="card p-4 text-center"><div className="text-2xl font-bold text-sky-600">{activePlayer.completedQuests?.length || 0}</div><div className="text-xs text-slate-500">Quests</div></div>
                <div className="card p-4 text-center"><div className="text-2xl font-bold text-green-600">{(activePlayer.choreHistory || []).length}</div><div className="text-xs text-slate-500">Chores</div></div>
                <div className="card p-4 text-center"><div className="text-2xl font-bold text-purple-600">{owned.length}</div><div className="text-xs text-slate-500">Items</div></div>
            </div>
            
            <div className="flex bg-white rounded-xl p-1 shadow mb-4">
                <button onClick={() => setShowInv(true)} className={'flex-1 py-2 rounded-lg font-bold text-sm ' + (showInv ? 'bg-sky-100 text-sky-700' : 'text-slate-400')}>üéí Inventory</button>
                <button onClick={() => setShowInv(false)} className={'flex-1 py-2 rounded-lg font-bold text-sm ' + (!showInv ? 'bg-sky-100 text-sky-700' : 'text-slate-400')}>üìú History</button>
            </div>
            
            {showInv ? (
                avatarItems.length > 0 ? <div className="grid grid-cols-2 gap-3">{avatarItems.map(item => {
                    const eq = activePlayer.avatar[item.slot] === item.id;
                    return <button key={item.id} onClick={() => equipItem(item.id)} className={'card p-4 text-center ' + (eq ? 'ring-2 ring-green-400 bg-green-50' : '')}><div className="text-3xl mb-2">{item.emoji}</div><div className="font-bold text-sm text-slate-800">{item.name}</div><div className={'text-xs mt-1 ' + (eq ? 'text-green-600 font-bold' : 'text-slate-400')}>{eq ? '‚úì Equipped' : 'Tap to equip'}</div></button>;
                })}</div> : <div className="card p-8 text-center"><div className="text-4xl mb-2">üõí</div><p className="text-slate-500">No items yet!</p></div>
            ) : (
                <div className="space-y-2">
                    {(activePlayer.completedQuests || []).slice(0, 10).map((q, i) => <div key={i} className="card p-3 flex items-center justify-between"><div className="flex items-center gap-2"><span>{CATEGORY_CONFIG[q.category]?.emoji || '‚ú®'}</span><span className="text-sm text-slate-600">Quest done</span></div><span className="text-xs text-slate-400">{new Date(q.timestamp).toLocaleDateString()}</span></div>)}
                    {(!activePlayer.completedQuests || activePlayer.completedQuests.length === 0) && <div className="card p-8 text-center"><div className="text-4xl mb-2">üìú</div><p className="text-slate-500">No quests yet!</p></div>}
                </div>
            )}
            
            <div className="mt-6 space-y-2">
                <button onClick={() => setCurrentView('setup')} className="w-full py-3 bg-slate-100 rounded-xl font-bold text-slate-600">+ Add Player</button>
                <button onClick={() => setShowPin(true)} className="w-full py-3 bg-purple-100 rounded-xl font-bold text-purple-600">üë®‚Äçüë©‚Äçüëß Parent Mode</button>
            </div>
            
            {showPin && <ParentPinModal onSuccess={() => { setShowPin(false); setCurrentView('parent'); }} onCancel={() => setShowPin(false)}/>}
        </div>
    );
}

function BottomNav() {
    const { currentView, setCurrentView, isParentMode } = useGame();
    if (isParentMode) return null;
    const items = [{id:'home',icon:'üéØ',label:'Quests'},{id:'shop',icon:'üè™',label:'Shop'},{id:'profile',icon:'üë§',label:'Profile'}];
    return (
        <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200">
            <div className="flex justify-around items-center h-16 max-w-lg mx-auto">
                {items.map(i => <button key={i.id} onClick={() => setCurrentView(i.id)} className={'flex flex-col items-center justify-center flex-1 h-full ' + (currentView === i.id ? 'text-sky-500' : 'text-slate-400')}><span className="text-2xl">{i.icon}</span><span className="text-xs font-bold mt-1">{i.label}</span></button>)}
            </div>
        </nav>
    );
}

function App() {
    const { players, currentView, isParentMode, familyMode, familyQuests } = useGame();
    const hasFamilyQuests = Object.keys(familyQuests).length > 0;
    const showWideLayout = familyMode && hasFamilyQuests;
    
    if (players.length === 0 || currentView === 'setup') return <PlayerSetupScreen/>;
    if (isParentMode || currentView === 'parent') return <ParentDashboard/>;
    return (
        <div className={'min-h-screen mx-auto ' + (showWideLayout ? 'max-w-4xl' : 'max-w-lg')}>
            {currentView === 'home' && <HomeScreen/>}
            {currentView === 'shop' && <ShopScreen/>}
            {currentView === 'profile' && <ProfileScreen/>}
            <BottomNav/>
            <Notification/>
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<GameProvider><App/></GameProvider>);
    </script>
</body>
</html>
