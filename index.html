<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spark Quest: Cloud Edition ‚òÅÔ∏è</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap');
        body { font-family: 'Fredoka', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes bounce-in { 0% { transform: scale(0.5); opacity: 0; } 80% { transform: scale(1.05); opacity: 1; } 100% { transform: scale(1); } }
        .animate-bounce-in { animation: bounce-in 0.5s ease-out forwards; }
        
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 8s linear infinite; }
        
        .animate-glow { animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0%, 100% { filter: drop-shadow(0 0 2px #60a5fa); } 50% { filter: drop-shadow(0 0 8px #3b82f6); } }
    </style>
</head>
<body class="bg-sky-100 text-slate-800 select-none">
    
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useContext, createContext, Component } = React;

        const SUPPORT_EMAIL = "chadramsey01@gmail.com"; 

        // ==========================================
        // üõ°Ô∏è ERROR BOUNDARY (Prevents White Screen)
        // ==========================================
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            componentDidCatch(error, errorInfo) { console.error("Game Crash:", error, errorInfo); }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="min-h-screen flex flex-col items-center justify-center p-6 bg-red-50 text-red-900 text-center">
                            <h1 className="text-4xl mb-4">üòµ OOPS!</h1>
                            <p className="font-bold mb-4">The game crashed. Here is the error:</p>
                            <pre className="bg-red-100 p-4 rounded text-left text-xs mb-4 overflow-auto max-w-sm">{this.state.error && this.state.error.toString()}</pre>
                            <button onClick={() => window.location.reload()} className="bg-red-500 text-white px-6 py-3 rounded-xl font-bold uppercase shadow-lg">Restart Game</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // ==========================================
        // üî• FIREBASE CONFIGURATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAR4wofIoYwrDMC7jr_GGFYPvZoPgGgbIk",
            authDomain: "spark-quest.firebaseapp.com",
            projectId: "spark-quest",
            storageBucket: "spark-quest.firebasestorage.app",
            messagingSenderId: "113841238943",
            appId: "1:113841238943:web:fd6b69669fb891afcd43aa",
            measurementId: "G-9VQJ7CT98X"
        };

        // Initialize Firebase safely
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
        } catch(e) { console.error("Firebase Init Error", e); }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        const analytics = firebase.analytics();

        // ==========================================
        // üìä ANALYTICS TRACKER (Internal)
        // ==========================================
        const trackActivity = (type, id, details = {}) => {
            try {
                if(auth.currentUser) {
                    db.collection('activities').add({
                        type, id, details,
                        userId: auth.currentUser.email,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
            } catch(e) { console.warn("Track error", e); }
        };
        window.sqTrack = { activity: trackActivity };

        // ==========================================
        // 1. ASSET RENDERER
        // ==========================================
        const RenderAsset = ({ type, id, color, skinColor }) => {
            const sColor = skinColor || '#ffe0bd';
            const iColor = color || '#333';
            const stroke = "#1e293b";
            const strokeW = "4";

            if (type === 'base') {
                return (
                    <g>
                        <rect x="70" y="140" width="25" height="40" rx="8" fill={sColor} stroke={stroke} strokeWidth={strokeW} />
                        <rect x="105" y="140" width="25" height="40" rx="8" fill={sColor} stroke={stroke} strokeWidth={strokeW} />
                        <rect x="60" y="100" width="80" height="50" rx="12" fill={sColor} stroke={stroke} strokeWidth={strokeW} />
                        <rect x="45" y="25" width="110" height="90" rx="20" fill={sColor} stroke={stroke} strokeWidth={strokeW} />
                        <circle cx="85" cy="80" r="6" fill="#1e293b" />
                        <circle cx="115" cy="80" r="6" fill="#1e293b" />
                        <path d="M 90 100 Q 100 110 110 100" fill="none" stroke={stroke} strokeWidth={strokeW} strokeLinecap="round" />
                    </g>
                );
            }

            if (id === 'hair_brown_messy') return <path d="M 35 30 C 35 5, 165 5, 165 30 C 165 60, 170 85, 170 95 L 155 95 L 155 30 L 45 30 L 45 95 L 30 95 C 30 85, 35 60, 35 30 Z" fill="#563625" stroke={stroke} strokeWidth={strokeW} />;
            if (id === 'hair_blonde_ponytail') return <g><path d="M 45 25 C 45 5, 155 5, 155 25 C 155 55, 155 80, 155 80 L 45 80 C 45 80, 45 55, 45 25 Z" fill="#ecc94b" stroke={stroke} strokeWidth={strokeW} /><circle cx="160" cy="40" r="20" fill="#ecc94b" stroke={stroke} strokeWidth={strokeW} /></g>;
            if (id === 'hair_black_spiky') return <path d="M 40 30 L 30 10 L 55 20 L 75 5 L 100 15 L 125 5 L 145 20 L 170 10 L 160 30 C 160 60, 150 80, 150 80 L 50 80 C 50 80, 40 60, 40 30 Z" fill="#2d3748" stroke={stroke} strokeWidth={strokeW} />;
            if (id === 'hair_red_bob') return <path d="M 40 35 C 40 10, 160 10, 160 35 C 160 65, 170 100, 170 110 L 140 110 L 140 35 L 60 35 L 60 110 L 30 110 C 30 100, 40 65, 40 35 Z" fill="#e53e3e" stroke={stroke} strokeWidth={strokeW} />;

            if (type === 'shirt') {
                let path = "M 55 100 L 35 115 L 45 130 L 60 120 L 60 155 L 140 155 L 140 120 L 155 130 L 165 115 L 145 100 Q 100 110 55 100 Z";
                if (id === 'shirt_ninja') return <g><path d={path} fill="#1e293b" stroke={stroke} strokeWidth={strokeW} /><path d="M 90 120 L 110 120 L 100 140 Z" fill="#ef4444" /></g>;
                if (id === 'shirt_gold_armor') return <g><path d="M 50 95 L 30 110 L 40 130 L 60 115 L 60 160 L 140 160 L 140 115 L 160 130 L 170 110 L 150 95 Q 100 105 50 95 Z" fill="#fbbf24" stroke="#b45309" strokeWidth={strokeW} /><rect x="85" y="115" width="30" height="35" rx="5" fill="#f59e0b" /></g>;
                return <path d={path} fill={iColor} stroke={stroke} strokeWidth={strokeW} />;
            }

            if (id && id.includes('cap')) return <g><path d="M 45 40 C 45 20, 155 20, 155 40 L 155 55 L 45 55 Z" fill={iColor} stroke={stroke} strokeWidth={strokeW} /><rect x="40" y="50" width="120" height="12" rx="6" fill={iColor} stroke={stroke} strokeWidth={strokeW} /><path d="M 160 50 L 190 55 L 160 60 Z" fill={iColor} stroke={stroke} strokeWidth={strokeW} /></g>;
            if (id === 'hat_beanie') return <g><path d="M 40 45 C 40 10, 160 10, 160 45 L 160 65 L 40 65 Z" fill={iColor} stroke={stroke} strokeWidth={strokeW} /><rect x="35" y="60" width="130" height="20" rx="10" fill={iColor} stroke={stroke} strokeWidth={strokeW} /></g>;
            if (id === 'hat_cowboy') return <g><ellipse cx="100" cy="55" rx="80" ry="20" fill={iColor} stroke={stroke} strokeWidth={strokeW} /><path d="M 65 50 L 75 10 C 75 -5, 125 -5, 125 10 L 135 50 Z" fill={iColor} stroke={stroke} strokeWidth={strokeW} /></g>;
            if (id === 'hat_headphones') return <g><path d="M 30 70 C 30 10, 170 10, 170 70" fill="none" stroke={iColor} strokeWidth="12" /><rect x="20" y="60" width="30" height="50" rx="10" fill={iColor} stroke={stroke} strokeWidth={strokeW} /><rect x="150" y="60" width="30" height="50" rx="10" fill={iColor} stroke={stroke} strokeWidth={strokeW} /></g>;
            if (id === 'hat_top') return <g><rect x="60" y="0" width="80" height="60" fill="#1e293b" stroke={stroke} strokeWidth={strokeW} /><rect x="30" y="60" width="140" height="15" rx="2" fill="#1e293b" stroke={stroke} strokeWidth={strokeW} /><rect x="60" y="50" width="80" height="10" fill="#ef4444" /></g>;
            if (id === 'hat_crown') return <g><path d="M 40 60 L 40 20 L 70 40 L 100 10 L 130 40 L 160 20 L 160 60 Z" fill="#fbbf24" stroke="#b45309" strokeWidth={strokeW} /></g>;

            if (id === 'glass_nerd') return <g stroke="black" strokeWidth="4" fill="none"><circle cx="75" cy="80" r="20"/><circle cx="125" cy="80" r="20"/><line x1="95" y1="80" x2="105" y2="80" /></g>;
            if (id === 'glass_shades') return <path d="M 50 70 L 95 70 L 100 80 L 105 70 L 150 70 L 160 90 L 140 95 L 105 90 L 95 90 L 60 95 L 40 90 Z" fill="#1e293b" stroke={stroke} strokeWidth={3} />;
            if (id === 'glass_cyber') return <rect x="50" y="70" width="100" height="25" rx="5" fill="#ec4899" stroke="#be185d" strokeWidth="3" opacity="0.8" />;

            return null;
        };

        // ==========================================
        // 2. DATA CONFIG
        // ==========================================
        const SKIN_TONES = [{id:'skin_pale',color:'#ffe0bd'},{id:'skin_fair',color:'#ffcd94'},{id:'skin_tan',color:'#eac086'},{id:'skin_medium',color:'#d1a3a4'},{id:'skin_dark',color:'#8d5524'},{id:'skin_deeper',color:'#563625'}];
        const HAIR_STYLES = [{id:'hair_brown_messy',name:'Brown Messy'},{id:'hair_blonde_ponytail',name:'Blonde Pony'},{id:'hair_black_spiky',name:'Black Spiky'},{id:'hair_red_bob',name:'Red Bob'}];
        const DIFFICULTY_CONFIG={"Easy":{reward:15,bg:"bg-green-100",text:"text-green-700",border:"border-green-300"},"Medium":{reward:30,bg:"bg-blue-100",text:"text-blue-700",border:"border-blue-300"},"Hard":{reward:50,bg:"bg-orange-100",text:"text-orange-700",border:"border-orange-300"},"Epic":{reward:100,bg:"bg-purple-100",text:"text-purple-700",border:"border-purple-300"}};
        const RARITY_CONFIG={common:{label:"Common",color:"text-slate-500",bg:"bg-slate-100",border:"border-slate-200"},uncommon:{label:"Uncommon",color:"text-green-600",bg:"bg-green-100",border:"border-green-300"},rare:{label:"Rare",color:"text-blue-600",bg:"bg-blue-100",border:"border-blue-300"},epic:{label:"Epic",color:"text-purple-600",bg:"bg-purple-100",border:"border-purple-300"},mythic:{label:"Mythic",color:"text-amber-600",bg:"bg-amber-100",border:"border-amber-400"}};
        const BORDER_CONFIG=[{id:'border_1',minLevel:1,name:'Rookie',color:'#cbd5e1'},{id:'border_5',minLevel:5,name:'Bronze',color:'#b45309'},{id:'border_10',minLevel:10,name:'Silver',color:'#94a3b8'},{id:'border_20',minLevel:20,name:'Gold',color:'#fbbf24'},{id:'border_50',minLevel:50,name:'Diamond',color:'#60a5fa'}];
        const SHOP_ITEMS=[{id:'hat_cap_blue',name:'Blue Cap',type:'hat',price:30,color:'#3b82f6',rarity:'common',minLevel:1},{id:'hat_cap_red',name:'Red Cap',type:'hat',price:30,color:'#ef4444',rarity:'common',minLevel:1},{id:'hat_beanie',name:'Beanie',type:'hat',price:50,color:'#475569',rarity:'uncommon',minLevel:2},{id:'hat_cowboy',name:'Cowboy Hat',type:'hat',price:100,color:'#78350f',rarity:'rare',minLevel:5},{id:'hat_headphones',name:'Pro Headset',type:'hat',price:150,color:'#ef4444',rarity:'epic',minLevel:10},{id:'hat_top',name:'Gentleman',type:'hat',price:200,color:'#1e293b',rarity:'epic',minLevel:10},{id:'hat_crown',name:'King\'s Crown',type:'hat',price:500,color:'#fbbf24',rarity:'mythic',minLevel:20},{id:'shirt_blue',name:'Blue Tee',type:'shirt',color:'#3b82f6',price:25,rarity:'common',minLevel:1},{id:'shirt_green',name:'Green Tee',type:'shirt',color:'#22c55e',price:25,rarity:'common',minLevel:1},{id:'shirt_purple',name:'Purple Tee',type:'shirt',color:'#a855f7',price:50,rarity:'uncommon',minLevel:2},{id:'shirt_black',name:'Ninja Suit',type:'shirt',id:'shirt_ninja',price:100,rarity:'rare',minLevel:5},{id:'shirt_gold',name:'Gilded Armor',type:'shirt',id:'shirt_gold_armor',price:250,rarity:'epic',minLevel:10},{id:'shirt_void',name:'Void Walker',type:'shirt',id:'shirt_void',price:600,rarity:'mythic',minLevel:20},{id:'glass_nerd',name:'Specs',type:'glasses',price:45,rarity:'uncommon',minLevel:2},{id:'glass_shades',name:'Cool Shades',type:'glasses',price:80,rarity:'rare',minLevel:5},{id:'glass_cyber',name:'Cyber Visor',type:'glasses',price:400,rarity:'mythic',minLevel:20}];
        const WORD_BANKS={color:["Red","Blue","Green","Yellow","Purple","Orange","Pink","White"],location:["kitchen","living room","bedroom","hallway","backyard","play area","couch","bathroom door"],animal:["Lion","Dog","Cat","Frog","Dinosaur","Bunny","Monkey","Chicken","Bear"],object_easy:["toy","pillow","book","spoon","shoe","ball","cup","hat"],object_hard:["flashlight","ruler","mug","sock","backpack","coin","leaf","pencil"],exercise_easy:["jumps","claps","spins","stomps","hops","wiggles"],exercise_hard:["squats","push-ups (knees)","lunges","sit-ups","planks","burpees"]};

        const generateQuest = (playerAge) => {
            const age = parseInt(playerAge) || 8; 
            let templates = [{text:"Find something [color]!",diff:"Easy",cat:'terra'},{text:"Do 5 [exercise_easy]!",diff:"Medium",cat:'blaze'},{text:"Draw a [animal]!",diff:"Medium",cat:'flow'},{text:"Clean up the [location]!",diff:"Hard",cat:'terra'}];
            const t = templates[Math.floor(Math.random() * templates.length)];
            let text = t.text;
            Object.keys(WORD_BANKS).forEach(key => { const regex = new RegExp(`\\[${key}\\]`,'g'); text = text.replace(regex, () => WORD_BANKS[key][Math.floor(Math.random()*WORD_BANKS[key].length)]); });
            return { id: Date.now()+Math.random(), description: text, category: t.cat, difficulty: t.diff, sparks_reward: DIFFICULTY_CONFIG[t.diff].reward, date: new Date().toLocaleDateString() };
        };

        const CAT_STYLES = {
            blaze: { icon: '‚öîÔ∏è', bg: 'bg-red-500', text: 'text-red-100' },
            flow:  { icon: 'üî®', bg: 'bg-blue-500', text: 'text-blue-100' },
            terra: { icon: 'üå±', bg: 'bg-green-500', text: 'text-green-100' },
            breeze:{ icon: 'üí®', bg: 'bg-purple-500', text: 'text-purple-100' }
        };

        // ==========================================
        // 2. CONTEXT (FIREBASE + ADMIN)
        // ==========================================
        const GameContext = createContext();
        const GameProvider = ({ children }) => {
            const [parent, setParent] = useState(null); 
            const [activePlayers, setActivePlayers] = useState([]);
            const [isCreating, setIsCreating] = useState(false);
            const [levelUpQueue, setLevelUpQueue] = useState([]);
            const [pendingChild, setPendingChild] = useState(null); 
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        try {
                            const docRef = db.collection('parents').doc(user.email);
                            const docSnap = await docRef.get();
                            if (docSnap.exists) {
                                const data = docSnap.data();
                                const uniqueChildren = [];
                                const seenNames = new Set();
                                if(data.children) {
                                    data.children.forEach(child => {
                                        const name = typeof child === 'string' ? child : child.name;
                                        const dob = typeof child === 'string' ? null : child.dob;
                                        if (!seenNames.has(name)) {
                                            seenNames.add(name);
                                            uniqueChildren.push({ name, dob });
                                        }
                                    });
                                }
                                setParent({...data, children: uniqueChildren});
                            } else {
                                setParent({ email: user.email, children: [] });
                            }
                        } catch (e) {
                            console.error("Auth Load Error:", e);
                            setParent(null);
                        }
                    } else {
                        setParent(null);
                    }
                    setLoading(false);
                });
                return unsubscribe;
            }, []);

            const loginParent = async (email, password) => { try { await auth.signInWithEmailAndPassword(email, password); return { success: true }; } catch (e) { return { success: false, msg: e.message }; } };
            const registerParent = async (email, password) => { try { await auth.createUserWithEmailAndPassword(email, password); const newParent = { email: email, children: [] }; await db.collection('parents').doc(email).set(newParent); setParent(newParent); return { success: true }; } catch (e) { return { success: false, msg: e.message }; } };
            const resetPassword = async (email) => { try { await auth.sendPasswordResetEmail(email); return { success: true }; } catch (e) { return { success: false, msg: e.message }; } };
            const logoutParent = async () => { await auth.signOut(); setActivePlayers([]); };

            const initAddChild = (name, dob) => {
                if (!name.trim() || !dob) return;
                const kids = (parent && parent.children) ? parent.children : [];
                if (kids.some(c => c.name === name)) { alert("Name exists!"); return; }
                setPendingChild({ username: name, dob: dob, sparks: 50, xp: 0, level: 1, inventory: [], history: [], avatar: { base: 'boy', skin: 'skin_fair', hair: 'hair_brown_messy', shirt: null, hat: null, glasses: null, border: 'border_1' } }); 
                setIsCreating(true); 
            };

            const completeAddChild = async (finalConfig) => {
                try {
                    const childToSave = { ...pendingChild, avatar: finalConfig };
                    const childMeta = { name: childToSave.username, dob: childToSave.dob };
                    
                    const cleanChildren = (parent && parent.children) ? parent.children.filter(c => c.name !== childToSave.username) : [];
                    const updatedParent = { ...parent, children: [...cleanChildren, childMeta] };
                    
                    setParent(updatedParent);
                    
                    const batch = db.batch();
                    const parentRef = db.collection('parents').doc(parent.email);
                    batch.update(parentRef, { children: firebase.firestore.FieldValue.arrayUnion(childMeta) });
                    const childRef = parentRef.collection('kids').doc(childToSave.username);
                    batch.set(childRef, childToSave);
                    await batch.commit();
                    
                    setPendingChild(null);
                    setIsCreating(false);
                } catch (e) {
                    console.error(e);
                    alert("Error saving child: " + e.message);
                }
            };

            const deleteChild = async (childName) => {
                if (!window.confirm(`Delete ${childName}? This cannot be undone.`)) return;
                try {
                    const updatedChildren = parent.children.filter(c => c.name !== childName);
                    const updatedParent = { ...parent, children: updatedChildren };
                    setParent(updatedParent);
                    await db.collection('parents').doc(parent.email).update({ children: updatedChildren });
                    await db.collection('parents').doc(parent.email).collection('kids').doc(childName).delete();
                } catch(e) {
                    alert("Error deleting: " + e.message);
                }
            };

            const startGame = async (selectedNames) => {
                if (selectedNames.length === 0) return;
                setLoading(true);
                const promises = selectedNames.map(name => db.collection('parents').doc(parent.email).collection('kids').doc(name).get());
                const snapshots = await Promise.all(promises);
                const players = snapshots.map(s => {
                    if(!s.exists) return null;
                    const d = s.data();
                    if(!d.avatar) d.avatar = { skin:'skin_fair', hair:'hair_brown_messy', border:'border_1' };
                    if(!d.history) d.history = [];
                    if(!d.inventory) d.inventory = [];
                    return d;
                }).filter(p => p !== null);
                
                setActivePlayers(players);
                setIsCreating(false);
                setLoading(false);
            };

            const editAvatar = (playerIndex) => { setPendingChild(activePlayers[playerIndex]); setIsCreating(true); }
            const saveEditedAvatar = async (finalConfig) => {
                const updatedPlayer = { ...pendingChild, avatar: finalConfig };
                setActivePlayers(prev => prev.map(p => p.username === updatedPlayer.username ? updatedPlayer : p));
                setIsCreating(false); setPendingChild(null);
                await db.collection('parents').doc(parent.email).collection('kids').doc(updatedPlayer.username).update(updatedPlayer);
            }
            const exitGame = () => { setActivePlayers([]); setIsCreating(false); };
            const completeQuest = async (i, q) => { 
                const player = activePlayers[i];
                const newXP = player.xp + q.sparks_reward;
                const oldLevel = player.level;
                const newLevel = Math.floor(newXP / 100) + 1;
                if (newLevel > oldLevel) setLevelUpQueue(prev => [...prev, { playerIdx: i, level: newLevel, bonus: 50 }]);
                const updated = { ...player, sparks: player.sparks + q.sparks_reward + (newLevel > oldLevel ? 50 : 0), xp: newXP, level: newLevel, history: [q, ...player.history] };
                setActivePlayers(prev => prev.map(p => p.username === updated.username ? updated : p));
                await db.collection('parents').doc(parent.email).collection('kids').doc(player.username).set(updated);
                if(window.sqTrack) window.sqTrack.activity('quest', q.id, { xp: q.sparks_reward, cat: q.category });
            };
            const buyItem = async (playerIndex, item) => {
                const player = activePlayers[playerIndex];
                if (player.inventory.includes(item.id)) return { success: false, msg: "Owned!" };
                if (player.sparks < item.price) return { success: false, msg: "Need Sparks!" };
                const updated = { ...player, sparks: player.sparks - item.price, inventory: [...player.inventory, item.id] };
                setActivePlayers(prev => prev.map(p => p.username === player.username ? updated : p));
                await db.collection('parents').doc(parent.email).collection('kids').doc(player.username).update(updated);
                return { success: true, msg: "Got it!" };
            };
            const equipItem = async (playerIndex, item) => {
                const player = activePlayers[playerIndex];
                const newAv = { ...player.avatar };
                if (item.type === 'hat') newAv.hat = (newAv.hat === item.id) ? null : item.id;
                if (item.type === 'glasses') newAv.glasses = (newAv.glasses === item.id) ? null : item.id;
                if (item.type === 'shirt') newAv.shirt = (newAv.shirt === (item.color || item.id)) ? null : (item.color || item.id);
                const updated = { ...player, avatar: newAv };
                setActivePlayers(prev => prev.map(p => p.username === player.username ? updated : p));
                await db.collection('parents').doc(parent.email).collection('kids').doc(player.username).update(updated);
            };
            const closeLevelUp = () => setLevelUpQueue(prev => prev.slice(1));

            return <GameContext.Provider value={{ parent, activePlayers, isCreating, levelUpQueue, pendingChild, loading, loginParent, registerParent, resetPassword, logoutParent, initAddChild, completeAddChild, deleteChild, startGame, exitGame, editAvatar, saveEditedAvatar, completeQuest, buyItem, equipItem, closeLevelUp }}>{children}</GameContext.Provider>;
        };

        const AdminDashboard = ({ onBack }) => {
            const [stats, setStats] = useState({ users: 0, quests: 0 }); const [logs, setLogs] = useState([]);
            useEffect(() => { db.collection('users').get().then(snap => setStats(s => ({...s, users: snap.size}))); db.collection('activities').get().then(snap => setStats(s => ({...s, quests: snap.size}))); const unsub = db.collection('activities').orderBy('completedAt', 'desc').limit(10).onSnapshot(snap => { setLogs(snap.docs.map(d => d.data())); }); return unsub; }, []);
            return (<div className="min-h-screen bg-slate-900 text-white p-6"><div className="flex justify-between items-center mb-8"><h1 className="text-2xl font-bold text-yellow-400">‚ö° Spark Command Center</h1><button onClick={onBack} className="text-sm bg-slate-800 px-4 py-2 rounded hover:bg-slate-700">Exit</button></div><div className="grid grid-cols-2 gap-4 mb-8"><div className="bg-slate-800 p-6 rounded-2xl border border-slate-700"><div className="text-3xl font-black">{stats.users}</div><div className="text-slate-400 text-xs uppercase font-bold">Total Heroes</div></div><div className="bg-slate-800 p-6 rounded-2xl border border-slate-700"><div className="text-3xl font-black text-green-400">{stats.quests}</div><div className="text-slate-400 text-xs uppercase font-bold">Quests Done</div></div></div><h2 className="text-lg font-bold mb-4 text-slate-400">Live Activity Feed</h2><div className="space-y-2">{logs.map((log, i) => (<div key={i} className="bg-slate-800 p-3 rounded-lg border border-slate-700 flex justify-between items-center text-sm"><div><span className="font-bold text-sky-400">{log.activityType}</span> <span className="text-slate-400">by user {log.userId?.substr(0,5)}...</span></div><div className="text-xs text-slate-500">Just now</div></div>))}{logs.length === 0 && <div className="text-slate-600 text-center py-4">Waiting for data...</div>}</div></div>);
        };

        const ItemIcon = ({ item, isLocked }) => {
            if (!item) return <div className="text-4xl">üì¶</div>;
            const style = isLocked ? { filter: 'brightness(0) opacity(0.3)' } : {};
            return <div className="w-12 h-12 relative" style={style}><svg viewBox="0 0 200 200" className="w-full h-full drop-shadow-sm"><RenderAsset type="shirt" id={item.id} color={item.color} /><RenderAsset type="hat" id={item.id} color={item.color} /><RenderAsset type="glass" id={item.id} /></svg></div>;
        };

        const PrestigeFrame = ({ borderId, children }) => {
            const config = BORDER_CONFIG.find(b => b.id === borderId) || BORDER_CONFIG[0];
            const renderBorder = () => {
                const defs = (<defs><linearGradient id="gradSilver" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#e2e8f0" /><stop offset="50%" stopColor="#94a3b8" /><stop offset="100%" stopColor="#e2e8f0" /></linearGradient><linearGradient id="gradGold" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#fde047" /><stop offset="50%" stopColor="#b45309" /><stop offset="100%" stopColor="#fde047" /></linearGradient><linearGradient id="gradDiamond" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stopColor="#60a5fa" /><stop offset="50%" stopColor="#2563eb" /><stop offset="100%" stopColor="#93c5fd" /></linearGradient></defs>);
                if (config.id === 'border_1') return <circle cx="50" cy="50" r="46" fill="none" stroke="#cbd5e1" strokeWidth="6" />;
                if (config.id === 'border_5') return <circle cx="50" cy="50" r="46" fill="none" stroke="#b45309" strokeWidth="6" strokeDasharray="10,5" />;
                if (config.id === 'border_10') return <g>{defs}<circle cx="50" cy="50" r="46" fill="none" stroke="url(#gradSilver)" strokeWidth="8" /><path d="M 50 90 L 45 100 L 55 100 Z" fill="#94a3b8"/><text x="50" y="98" fontSize="16" textAnchor="middle">‚≠ê</text></g>;
                if (config.id === 'border_20') return <g>{defs}<circle cx="50" cy="50" r="46" fill="none" stroke="url(#gradGold)" strokeWidth="8" /><text x="50" y="98" fontSize="18" textAnchor="middle">üëë</text></g>;
                if (config.id === 'border_50') return <g className="animate-glow">{defs}<circle cx="50" cy="50" r="45" fill="none" stroke="url(#gradDiamond)" strokeWidth="8" /><path d="M 50 2 L 60 12 L 50 22 L 40 12 Z" fill="#93c5fd" /><path d="M 50 98 L 60 88 L 50 78 L 40 88 Z" fill="#93c5fd" /></g>;
                return <circle cx="50" cy="50" r="46" fill="none" stroke="#cbd5e1" strokeWidth="4" />;
            };
            return (<div className="relative w-full h-full"><div className="absolute inset-0 z-0 p-3">{children}</div><svg viewBox="0 0 100 100" className="absolute inset-0 z-10 w-full h-full pointer-events-none">{renderBorder()}</svg></div>);
        };

        const BlockyAvatar = ({ config, size = "md" }) => {
            if (!config) return null;
            const sizeClass = { xs: "w-full h-full", sm: "w-16 h-16", md: "w-32 h-32", lg: "w-48 h-48" }[size];
            const skinObj = SKIN_TONES.find(s => s.id === config.skin);
            const skinColor = skinObj ? skinObj.color : '#ffe0bd';
            const hatItem = SHOP_ITEMS.find(i => i.id === config.hat);
            const shirtItem = SHOP_ITEMS.find(i => i.id === config.shirt || i.color === config.shirt); 
            return (
                <div className={`${sizeClass} relative mx-auto`}>
                    <svg viewBox="0 0 200 200" className="w-full h-full drop-shadow-lg">
                        <RenderAsset type="base" skinColor={skinColor} />
                        <RenderAsset type="hair" id={config.hair} />
                        {shirtItem ? <RenderAsset type="shirt" id={shirtItem.id} color={shirtItem.color} /> : <RenderAsset type="shirt" color={config.shirt} />}
                        <RenderAsset type="glass" id={config.glasses} />
                        {hatItem && <RenderAsset type="hat" id={hatItem.id} color={hatItem.color} />}
                    </svg>
                </div>
            );
        };

        const App = () => {
            const { parent, activePlayers, isCreating, exitGame, levelUpQueue, closeLevelUp, loading, startGame } = useContext(GameContext);
            const [view, setView] = useState('landing');
            const [gameView, setGameView] = useState('home');

            useEffect(() => { if (parent) setView('game'); }, [parent]);

            if (loading) return <div className="min-h-screen bg-sky-400 flex items-center justify-center text-white font-black text-2xl animate-pulse">LOADING...</div>;
            if (view === 'landing') return <LandingPage onStart={() => setView('auth')} />;
            if (view === 'auth') return <AuthScreen />;
            if (view === 'admin') return <AdminDashboard onBack={() => setView('game')} />;
            if (isCreating) return <AvatarCreator />;
            if (activePlayers.length === 0) return (
                <>
                    <ParentDashboard />
                    {parent && parent.email === SUPPORT_EMAIL && (
                        <button onClick={() => setView('admin')} className="fixed bottom-4 left-4 bg-slate-800 text-white px-3 py-1 rounded text-xs opacity-50 hover:opacity-100">Admin</button>
                    )}
                </>
            );

            const currentLevelUp = levelUpQueue[0];

            return (
                <div className="max-w-md mx-auto bg-sky-100 min-h-screen shadow-2xl relative border-x border-slate-200">
                    {currentLevelUp && <div className="fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-6"><div className="bg-yellow-400 rounded-3xl p-8 text-center border-4 border-white"><h2 className="text-4xl font-black text-white uppercase">Level Up!</h2><button onClick={closeLevelUp} className="mt-4 bg-white text-yellow-600 font-black px-6 py-3 rounded-xl uppercase">Claim</button></div></div>}
                    <div className="sticky top-0 z-40 bg-white/90 backdrop-blur-md px-4 py-3 border-b border-sky-100 flex justify-between items-center shadow-sm"><button onClick={exitGame} className="text-xs font-bold text-slate-400">‚Üê Back</button><div className="font-black text-sky-900 text-xs uppercase">{activePlayers.length > 1 ? `${activePlayers.length} Players` : activePlayers[0].username}</div><div className="w-8"></div></div>
                    <div className="min-h-[80vh] bg-sky-100">{gameView==='home' && <SparkSpinner />}{gameView==='shop' && <Shop />}{gameView==='dash' && <Dashboard />}</div>
                    <div className="fixed bottom-0 w-full max-w-md bg-white border-t border-slate-200 p-2 flex justify-around pb-6 sm:pb-2 z-50 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]"><button onClick={()=>setGameView('home')} className={`p-3 text-3xl ${gameView==='home'?'grayscale-0 -translate-y-2':'grayscale opacity-50'}`}>üè†</button><button onClick={()=>setGameView('shop')} className={`p-3 text-3xl ${gameView==='shop'?'grayscale-0 -translate-y-2':'grayscale opacity-50'}`}>üõí</button><button onClick={()=>setGameView('dash')} className={`p-3 text-3xl ${gameView==='dash'?'grayscale-0 -translate-y-2':'grayscale opacity-50'}`}>üë§</button></div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><GameProvider><App /></GameProvider></ErrorBoundary>);
    </script>
</body>
</html>